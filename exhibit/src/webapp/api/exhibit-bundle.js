Exhibit.Collection=function(b,a){this._id=b;this._database=a;this._listeners=new SimileAjax.ListenerQueue();this._facets=[];this._updating=false;this._items=null;this._restrictedItems=null};Exhibit.Collection.create=function(e,d,a){var b=new Exhibit.Collection(e,a);if("itemTypes" in d){b._itemTypes=d.itemTypes;b._update=Exhibit.Collection._typeBasedCollection_update}else{b._update=Exhibit.Collection._allItemsCollection_update}var c=function(){b._update()};b._listener={onAfterLoadingItems:c,onAfterRemovingAllStatements:c};a.addListener(b._listener);b._update();return b};Exhibit.Collection.create2=function(e,d,a){var b=a.getDatabase();if("expression" in d){var c=new Exhibit.Collection(e,b);c._expression=Exhibit.ExpressionParser.parse(d.expression);c._baseCollection=("baseCollectionID" in d)?a.getExhibit().getCollection(d.baseCollectionID):a.getCollection();c._update=Exhibit.Collection._basedCollection_update;c._listener={onItemsChanged:function(){c._update()}};c._baseCollection.addListener(c._listener);c._update();return c}else{return Exhibit.Collection.create(e,d,b)}};Exhibit.Collection.createFromDOM=function(g,a,c){var d=new Exhibit.Collection(g,c);var b=Exhibit.getAttribute(a,"itemTypes",",");if(b!=null&&b.length>0){d._itemTypes=b;d._update=Exhibit.Collection._typeBasedCollection_update}else{d._update=Exhibit.Collection._allItemsCollection_update}var e=function(){d._update()};d._listener={onAfterLoadingItems:e,onAfterRemovingAllStatements:e};c.addListener(d._listener);d._update();return d};Exhibit.Collection.createFromDOM2=function(h,c,a){var e=a.getDatabase();var b=Exhibit.getAttribute(c,"expression");if(b!=null&&b.length>0){var g=new Exhibit.Collection(h,e);g._expression=Exhibit.ExpressionParser.parse(b);var d=Exhibit.getAttribute(c,"baseCollectionID");g._baseCollection=(d!=null&&d.length>0)?a.getExhibit().getCollection(d):a.getCollection();g._update=Exhibit.Collection._basedCollection_update;g._listener={onItemsChanged:function(){g._update()}};g._baseCollection.addListener(g._listener);g._update();return g}else{return Exhibit.Collection.createFromDOM(h,c,e)}};Exhibit.Collection.createAllItemsCollection=function(d,a){var b=new Exhibit.Collection(d,a);var c=function(){b._update()};b._listener={onAfterLoadingItems:c,onAfterRemovingAllStatements:c};a.addListener(b._listener);b._update=Exhibit.Collection._allItemsCollection_update;b._update();return b};Exhibit.Collection._allItemsCollection_update=function(){this._items=this._database.getAllItems();this._onRootItemsChanged()};Exhibit.Collection._typeBasedCollection_update=function(){var a=new Exhibit.Set();for(var b=0;b<this._itemTypes.length;b++){this._database.getSubjects(this._itemTypes[b],"type",a)}this._items=a;this._onRootItemsChanged()};Exhibit.Collection._basedCollection_update=function(){this._items=this._expression.evaluate({value:this._baseCollection.getRestrictedItems()},{value:"item"},"value",this._database).values;this._onRootItemsChanged()};Exhibit.Collection.prototype.getID=function(){return this._id};Exhibit.Collection.prototype.dispose=function(){if("_baseCollection" in this){this._baseCollection.removeListener(this._listener);this._baseCollection=null;this._expression=null}else{this._database.removeListener(this._listener)}this._database=null;this._listener=null;this._listeners=null;this._items=null;this._restrictedItems=null};Exhibit.Collection.prototype.addListener=function(a){this._listeners.add(a)};Exhibit.Collection.prototype.removeListener=function(a){this._listeners.remove(a)};Exhibit.Collection.prototype.addFacet=function(a){this._facets.push(a);if(a.hasRestrictions()){this._computeRestrictedItems();this._updateFacets(null);this._listeners.fire("onItemsChanged",[])}else{a.update(this.getRestrictedItems())}};Exhibit.Collection.prototype.removeFacet=function(b){for(var a=0;a<this._facets.length;a++){if(b==this._facets[a]){this._facets.splice(a,1);if(b.hasRestrictions()){this._computeRestrictedItems();this._updateFacets(null);this._listeners.fire("onItemsChanged",[])}break}}};Exhibit.Collection.prototype.clearAllRestrictions=function(){var b=[];this._updating=true;for(var a=0;a<this._facets.length;a++){b.push(this._facets[a].clearAllRestrictions())}this._updating=false;this.onFacetUpdated(null);return b};Exhibit.Collection.prototype.applyRestrictions=function(b){this._updating=true;for(var a=0;a<this._facets.length;a++){this._facets[a].applyRestrictions(b[a])}this._updating=false;this.onFacetUpdated(null)};Exhibit.Collection.prototype.getAllItems=function(){return new Exhibit.Set(this._items)};Exhibit.Collection.prototype.countAllItems=function(){return this._items.size()};Exhibit.Collection.prototype.getRestrictedItems=function(){return new Exhibit.Set(this._restrictedItems)};Exhibit.Collection.prototype.countRestrictedItems=function(){return this._restrictedItems.size()};Exhibit.Collection.prototype.onFacetUpdated=function(a){if(!this._updating){this._computeRestrictedItems();this._updateFacets(a);this._listeners.fire("onItemsChanged",[])}};Exhibit.Collection.prototype._onRootItemsChanged=function(){this._listeners.fire("onRootItemsChanged",[]);this._computeRestrictedItems();this._updateFacets(null);this._listeners.fire("onItemsChanged",[])};Exhibit.Collection.prototype._updateFacets=function(d){var a=0;for(var e=0;e<this._facets.length;e++){if(this._facets[e].hasRestrictions()){a++}}for(var e=0;e<this._facets.length;e++){var g=this._facets[e];if(g.hasRestrictions()){if(a<=1){g.update(this.getAllItems())}else{var b=this.getAllItems();for(var c=0;c<this._facets.length;c++){if(e!=c){b=this._facets[c].restrict(b)}}g.update(b)}}else{g.update(this.getRestrictedItems())}}};Exhibit.Collection.prototype._computeRestrictedItems=function(){this._restrictedItems=this._items;for(var a=0;a<this._facets.length;a++){var b=this._facets[a];if(b.hasRestrictions()){this._restrictedItems=b.restrict(this._restrictedItems)}}};Exhibit.Controls={};Exhibit.Controls["if"]={f:function(d,b,c,h,e){var a=d[0].evaluate(b,c,h,e);var g=false;a.forEachValue(function(i){if(i){g=true;return true}});if(g){return d[1].evaluate(b,c,h,e)}else{return d[2].evaluate(b,c,h,e)}}};Exhibit.Controls.foreach={f:function(h,k,l,b,i){var e=h[0].evaluate(k,l,b,i);var a=k.value;var g=l.value;l.value=e.valueType;var d=[];var c="text";e.forEachValue(function(m){k.value=m;var n=h[1].evaluate(k,l,b,i);c=n.valueType;n.forEachValue(function(o){d.push(o)})});k.value=a;l.value=g;return new Exhibit.Expression._Collection(d,c)}};Exhibit.Controls["default"]={f:function(c,a,b,h,e){for(var d=0;d<c.length;d++){var g=c[d].evaluate(a,b,h,e);if(g.size>0){return g}}return new Exhibit.Expression._Collection([],"text")}};Exhibit.Database=new Object();Exhibit.Database.create=function(){return new Exhibit.Database._Impl()};Exhibit.Database._Impl=function(){this._types={};this._properties={};this._propertyArray={};this._listeners=new SimileAjax.ListenerQueue();this._spo={};this._ops={};this._items=new Exhibit.Set();var b=Exhibit.Database.l10n;var d=new Exhibit.Database._Type("Item");d._custom=Exhibit.Database.l10n.itemType;this._types.Item=d;var c=new Exhibit.Database._Property("label");c._uri="http://www.w3.org/2000/01/rdf-schema#label";c._valueType="text";c._label=b.labelProperty.label;c._pluralLabel=b.labelProperty.pluralLabel;c._reverseLabel=b.labelProperty.reverseLabel;c._reversePluralLabel=b.labelProperty.reversePluralLabel;c._groupingLabel=b.labelProperty.groupingLabel;c._reverseGroupingLabel=b.labelProperty.reverseGroupingLabel;this._properties.label=c;var e=new Exhibit.Database._Property("type");e._uri="http://www.w3.org/1999/02/22-rdf-syntax-ns#type";e._valueType="text";e._label="type";e._pluralLabel=b.typeProperty.label;e._reverseLabel=b.typeProperty.reverseLabel;e._reversePluralLabel=b.typeProperty.reversePluralLabel;e._groupingLabel=b.typeProperty.groupingLabel;e._reverseGroupingLabel=b.typeProperty.reverseGroupingLabel;this._properties.type=e;var a=new Exhibit.Database._Property("uri");a._uri="http://simile.mit.edu/2006/11/exhibit#uri";a._valueType="url";a._label="URI";a._pluralLabel="URIs";a._reverseLabel="URI of";a._reversePluralLabel="URIs of";a._groupingLabel="URIs";a._reverseGroupingLabel="things named by these URIs";this._properties.uri=a};Exhibit.Database._Impl.prototype.createDatabase=function(){return Exhibit.Database.create()};Exhibit.Database._Impl.prototype.addListener=function(a){this._listeners.add(a)};Exhibit.Database._Impl.prototype.removeListener=function(a){this._listeners.remove(a)};Exhibit.Database._Impl.prototype.loadDataLinks=function(d){var b=[];var i=document.documentElement.getElementsByTagName("head");for(var c=0;c<i.length;c++){var g=i[c].getElementsByTagName("link");for(var a=0;a<g.length;a++){var e=g[a];if(e.rel.match(/\bexhibit\/data\b/)){b.push(e)}}}this._loadLinks(b,d)};Exhibit.Database._Impl.prototype._loadLinks=function(a,b){a=[].concat(a);var c=this;var d=function(){while(a.length>0){var h=a.shift();var e=h.type;if(e==null||e.length==0){e="application/json"}var g=Exhibit.importers[e];if(g){g.load(h,c,d);return}else{SimileAjax.Debug.log("No importer for data of type "+e)}}if(b!=null){b()}};d()};Exhibit.Database._Impl.prototype.loadData=function(a,b){if(typeof b=="undefined"){b=location.href}if("types" in a){this.loadTypes(a.types,b)}if("properties" in a){this.loadProperties(a.properties,b)}if("items" in a){this.loadItems(a.items,b)}};Exhibit.Database._Impl.prototype.loadTypes=function(c,k){this._listeners.fire("onBeforeLoadingTypes",[]);try{var b=k.substr(k.length-1);if(b=="#"){k=k.substr(0,k.length-1)+"/"}else{if(b!="/"&&b!=":"){k+="/"}}for(var a in c){if(typeof a!="string"){continue}var g=c[a];if(typeof g!="object"){continue}var d;if(a in this._types){d=this._types[a]}else{d=new Exhibit.Database._Type(a);this._types[a]=d}for(var i in g){d._custom[i]=g[i]}if(!("uri" in d._custom)){d._custom.uri=k+"type#"+encodeURIComponent(a)}if(!("label" in d._custom)){d._custom.label=a}}this._listeners.fire("onAfterLoadingTypes",[])}catch(h){SimileAjax.Debug.exception(h,"Database.loadTypes failed")}};Exhibit.Database._Impl.prototype.loadProperties=function(h,i){this._listeners.fire("onBeforeLoadingProperties",[]);try{var b=i.substr(i.length-1);if(b=="#"){i=i.substr(0,i.length-1)+"/"}else{if(b!="/"&&b!=":"){i+="/"}}for(var g in h){if(typeof g!="string"){continue}var a=h[g];if(typeof a!="object"){continue}var c;if(g in this._properties){c=this._properties[g]}else{c=new Exhibit.Database._Property(g,this);this._properties[g]=c}c._uri=("uri" in a)?a.uri:(i+"property#"+encodeURIComponent(g));c._valueType=("valueType" in a)?a.valueType:"text";c._label=("label" in a)?a.label:g;c._pluralLabel=("pluralLabel" in a)?a.pluralLabel:c._label;c._reverseLabel=("reverseLabel" in a)?a.reverseLabel:("!"+c._label);c._reversePluralLabel=("reversePluralLabel" in a)?a.reversePluralLabel:("!"+c._pluralLabel);c._groupingLabel=("groupingLabel" in a)?a.groupingLabel:c._label;c._reverseGroupingLabel=("reverseGroupingLabel" in a)?a.reverseGroupingLabel:c._reverseLabel;if("origin" in a){c._origin=a.origin}}this._propertyArray=null;this._listeners.fire("onAfterLoadingProperties",[])}catch(d){SimileAjax.Debug.exception(d,"Database.loadProperties failed")}};Exhibit.Database._Impl.prototype.loadItems=function(h,d){this._listeners.fire("onBeforeLoadingItems",[]);try{var n=d.substr(d.length-1);if(n=="#"){d=d.substr(0,d.length-1)+"/"}else{if(n!="/"&&n!=":"){d+="/"}}var c=this._spo;var b=this._ops;var a=Exhibit.Database._indexPut;var l=function(e,i,q){a(c,e,i,q);a(b,q,i,e)};for(var g=0;g<h.length;g++){var m=h[g];if(typeof m=="object"){this._loadItem(m,l,d)}}this._propertyArray=null;this._listeners.fire("onAfterLoadingItems",[])}catch(k){SimileAjax.Debug.exception(k,"Database.loadItems failed")}};Exhibit.Database._Impl.prototype.getType=function(a){return this._types[a]};Exhibit.Database._Impl.prototype.getProperty=function(a){return a in this._properties?this._properties[a]:null};Exhibit.Database._Impl.prototype.getAllProperties=function(){if(this._propertyArray==null){this._propertyArray=[];for(var a in this._properties){this._propertyArray.push(a)}}return[].concat(this._propertyArray)};Exhibit.Database._Impl.prototype.getAllItems=function(){var a=new Exhibit.Set();a.addSet(this._items);return a};Exhibit.Database._Impl.prototype.getAllItemsCount=function(){return this._items.size()};Exhibit.Database._Impl.prototype.containsItem=function(a){return this._items.contains(a)};Exhibit.Database._Impl.prototype.getNamespaces=function(o,n){var a={};for(var q in this._properties){var p=this._properties[q];var d=p.getURI();var k=d.indexOf("#");if(k>0){var b=d.substr(0,k+1);a[b]=true;o[q]={base:b,localName:d.substr(k+1)};continue}var g=d.lastIndexOf("/");if(g>0){var b=d.substr(0,g+1);a[b]=true;o[q]={base:b,localName:d.substr(g+1)};continue}}var c={};var m="abcdefghijklmnopqrstuvwxyz";var h=0;for(var b in a){var l=m.substr(h++,1);n[l]=b;c[b]=l}for(var q in o){var e=o[q];e.prefix=c[e.base]}};Exhibit.Database._Impl.prototype._loadItem=function(e,h,d){if(!("label" in e)&&!("id" in e)){SimileAjax.Debug.warn("Item entry has no label and no id: "+SimileAjax.JSON.toJSONString(e));return}var b;if(!("label" in e)){b=e.id;if(!this._items.contains(b)){SimileAjax.Debug.warn("Cannot add new item containing no label: "+SimileAjax.JSON.toJSONString(e))}}else{var l=e.label;var b=("id" in e)?e.id:l;var c=("uri" in e)?e.uri:(d+"item#"+encodeURIComponent(b));var k=("type" in e)?e.type:"Item";var i=function(n){if(n.constructor.toString().indexOf("Array")==-1){return false}else{return true}};if(i(l)){l=l[0]}if(i(b)){b=b[0]}if(i(c)){c=c[0]}if(i(k)){k=k[0]}this._items.add(b);h(b,"uri",c);h(b,"label",l);h(b,"type",k);this._ensureTypeExists(k,d)}for(var a in e){if(typeof a!="string"){continue}if(a!="uri"&&a!="label"&&a!="id"&&a!="type"){this._ensurePropertyExists(a,d)._onNewData();var m=e[a];if(m instanceof Array){for(var g=0;g<m.length;g++){h(b,a,m[g])}}else{if(m!=undefined&&m!=null){h(b,a,m)}}}}};Exhibit.Database._Impl.prototype._ensureTypeExists=function(a,c){if(!(a in this._types)){var b=new Exhibit.Database._Type(a);b._custom.uri=c+"type#"+encodeURIComponent(a);b._custom.label=a;this._types[a]=b}};Exhibit.Database._Impl.prototype._ensurePropertyExists=function(b,c){if(!(b in this._properties)){var a=new Exhibit.Database._Property(b);a._uri=c+"property#"+encodeURIComponent(b);a._valueType="text";a._label=b;a._pluralLabel=a._label;a._reverseLabel="reverse of "+a._label;a._reversePluralLabel="reverse of "+a._pluralLabel;a._groupingLabel=a._label;a._reverseGroupingLabel=a._reverseLabel;this._properties[b]=a;return a}else{return this._properties[b]}};Exhibit.Database._indexPut=function(b,a,h,e){var d=b[a];if(!d){d={};b[a]=d}var g=d[h];if(!g){g=new Array();d[h]=g}else{for(var c=0;c<g.length;c++){if(e==g[c]){return}}}g.push(e)};Exhibit.Database._indexPutList=function(b,a,g,c){var d=b[a];if(!d){d={};b[a]=d}var e=d[g];if(!e){d[g]=c}else{d[g]=d[g].concat(c)}};Exhibit.Database._indexRemove=function(b,a,h,e){var d=b[a];if(!d){return false}var g=d[h];if(!g){return false}for(var c=0;c<g.length;c++){if(e==g[c]){g.splice(c,1);if(g.length==0){delete d[h]}return true}}};Exhibit.Database._indexRemoveList=function(b,a,e){var c=b[a];if(!c){return null}var d=c[e];if(!d){return null}delete c[e];return d};Exhibit.Database._Impl.prototype._indexFillSet=function(d,k,h,l,a){var b=d[k];if(b){var e=b[h];if(e){if(a){for(var c=0;c<e.length;c++){var g=e[c];if(a.contains(g)){l.add(g)}}}else{for(var c=0;c<e.length;c++){l.add(e[c])}}}}};Exhibit.Database._Impl.prototype._indexCountDistinct=function(b,a,k,d){var e=0;var g=b[a];if(g){var h=g[k];if(h){if(d){for(var c=0;c<h.length;c++){if(d.contains(h[c])){e++}}}else{e=h.length}}}return e};Exhibit.Database._Impl.prototype._get=function(b,a,e,d,c){if(!d){d=new Exhibit.Set()}this._indexFillSet(b,a,e,d,c);return d};Exhibit.Database._Impl.prototype._getUnion=function(a,d,g,e,b){if(!e){e=new Exhibit.Set()}var c=this;d.visit(function(h){c._indexFillSet(a,h,g,e,b)});return e};Exhibit.Database._Impl.prototype._countDistinctUnion=function(a,e,g,b){var c=0;var d=this;e.visit(function(h){c+=d._indexCountDistinct(a,h,g,b)});return c};Exhibit.Database._Impl.prototype._countDistinct=function(b,a,d,c){return this._indexCountDistinct(b,a,d,c)};Exhibit.Database._Impl.prototype._getProperties=function(b,a){var e=b[a];var c=[];if(e){for(var d in e){c.push(d)}}return c};Exhibit.Database._Impl.prototype.getObjects=function(b,c,d,a){return this._get(this._spo,b,c,d,a)};Exhibit.Database._Impl.prototype.countDistinctObjects=function(b,c,a){return this._countDistinct(this._spo,b,c,a)};Exhibit.Database._Impl.prototype.getObjectsUnion=function(a,c,d,b){return this._getUnion(this._spo,a,c,d,b)};Exhibit.Database._Impl.prototype.countDistinctObjectsUnion=function(a,c,b){return this._countDistinctUnion(this._spo,a,c,b)};Exhibit.Database._Impl.prototype.getSubjects=function(c,b,d,a){return this._get(this._ops,c,b,d,a)};Exhibit.Database._Impl.prototype.countDistinctSubjects=function(c,b,a){return this._countDistinct(this._ops,c,b,a)};Exhibit.Database._Impl.prototype.getSubjectsUnion=function(b,c,d,a){return this._getUnion(this._ops,b,c,d,a)};Exhibit.Database._Impl.prototype.countDistinctSubjectsUnion=function(b,c,a){return this._countDistinctUnion(this._ops,b,c,a)};Exhibit.Database._Impl.prototype.getObject=function(a,c){var b=this._spo[a];if(b){var d=b[c];if(d){return d[0]}}return null};Exhibit.Database._Impl.prototype.getSubject=function(c,b){var a=this._ops[c];if(a){var d=a[b];if(d){return d[0]}}return null};Exhibit.Database._Impl.prototype.getForwardProperties=function(a){return this._getProperties(this._spo,a)};Exhibit.Database._Impl.prototype.getBackwardProperties=function(a){return this._getProperties(this._ops,a)};Exhibit.Database._Impl.prototype.getSubjectsInRange=function(h,d,c,b,i,e){var g=this.getProperty(h);if(g!=null){var a=g.getRangeIndex();if(a!=null){return a.getSubjectsInRange(d,c,b,i,e)}}return(!i)?new Exhibit.Set():i};Exhibit.Database._Impl.prototype.getTypeIDs=function(a){return this.getObjectsUnion(a,"type",null,null)};Exhibit.Database._Impl.prototype.addStatement=function(a,c,d){var b=Exhibit.Database._indexPut;b(this._spo,a,c,d);b(this._ops,d,c,a)};Exhibit.Database._Impl.prototype.removeStatement=function(b,c,e){var g=Exhibit.Database._indexRemove;var d=g(this._spo,b,c,e);var a=g(this._ops,e,c,b);return d||a};Exhibit.Database._Impl.prototype.removeObjects=function(b,d){var g=Exhibit.Database._indexRemove;var e=Exhibit.Database._indexRemoveList;var c=e(this._spo,b,d);if(c==null){return false}else{for(var a=0;a<c.length;a++){g(this._ops,c[a],d,b)}return true}};Exhibit.Database._Impl.prototype.removeSubjects=function(e,c){var g=Exhibit.Database._indexRemove;var d=Exhibit.Database._indexRemoveList;var a=d(this._ops,e,c);if(a==null){return false}else{for(var b=0;b<a.length;b++){g(this._spo,a[b],c,e)}return true}};Exhibit.Database._Impl.prototype.removeAllStatements=function(){this._listeners.fire("onBeforeRemovingAllStatements",[]);try{this._spo={};this._ops={};this._items=new Exhibit.Set();for(var b in this._properties){this._properties[b]._onNewData()}this._propertyArray=null;this._listeners.fire("onAfterRemovingAllStatements",[])}catch(a){SimileAjax.Debug.exception(a,"Database.removeAllStatements failed")}};Exhibit.Database._Type=function(a){this._id=a;this._custom={}};Exhibit.Database._Type.prototype={getID:function(){return this._id},getURI:function(){return this._custom.uri},getLabel:function(){return this._custom.label},getOrigin:function(){return this._custom.origin},getProperty:function(a){return this._custom[a]}};Exhibit.Database._Property=function(b,a){this._id=b;this._database=a;this._rangeIndex=null};Exhibit.Database._Property.prototype={getID:function(){return this._id},getURI:function(){return this._uri},getValueType:function(){return this._valueType},getLabel:function(){return this._label},getPluralLabel:function(){return this._pluralLabel},getReverseLabel:function(){return this._reverseLabel},getReversePluralLabel:function(){return this._reversePluralLabel},getGroupingLabel:function(){return this._groupingLabel},getGroupingPluralLabel:function(){return this._groupingPluralLabel},getOrigin:function(){return this._origin}};Exhibit.Database._Property.prototype._onNewData=function(){this._rangeIndex=null};Exhibit.Database._Property.prototype.getRangeIndex=function(){if(this._rangeIndex==null){this._buildRangeIndex()}return this._rangeIndex};Exhibit.Database._Property.prototype._buildRangeIndex=function(){var a;var b=this._database;var c=this._id;switch(this.getValueType()){case"number":a=function(d,e){b.getObjects(d,c,null,null).visit(function(g){if(typeof g!="number"){g=parseFloat(g)}if(!isNaN(g)){e(g)}})};break;case"date":a=function(d,e){b.getObjects(d,c,null,null).visit(function(g){if(g!=null&&!(g instanceof Date)){g=SimileAjax.DateTime.parseIso8601DateTime(g)}if(g instanceof Date){e(g.getTime())}})};break;default:a=function(d,e){}}this._rangeIndex=new Exhibit.Database._RangeIndex(this._database.getAllItems(),a)};Exhibit.Database._RangeIndex=function(b,a){pairs=[];b.visit(function(c){a(c,function(d){pairs.push({item:c,value:d})})});pairs.sort(function(e,d){var g=e.value-d.value;return g!=0?g:e.item.localeCompare(d.item)});this._pairs=pairs};Exhibit.Database._RangeIndex.prototype.getCount=function(){return this._pairs.count()};Exhibit.Database._RangeIndex.prototype.getMin=function(){return this._pairs.length>0?this._pairs[0].value:Number.POSITIVE_INFINITY};Exhibit.Database._RangeIndex.prototype.getMax=function(){return this._pairs.length>0?this._pairs[this._pairs.length-1].value:Number.NEGATIVE_INFINITY};Exhibit.Database._RangeIndex.prototype.getRange=function(e,d,g,h){var k=this._indexOf(d);var a=this._pairs;var b=a.length;h=(h);while(k<b){var c=a[k++];var i=c.value;if(i<g||(i==g&&h)){e(c.item)}else{break}}};Exhibit.Database._RangeIndex.prototype.getSubjectsInRange=function(c,b,a,g,d){if(!g){g=new Exhibit.Set()}var e=(d!=null)?function(h){if(d.contains(h)){g.add(h)}}:function(h){g.add(h)};this.getRange(e,c,b,a);return g};Exhibit.Database._RangeIndex.prototype.countRange=function(d,b,a){var h=this._indexOf(d);var g=this._indexOf(b);if(a){var e=this._pairs;var c=e.length;while(g<c){if(e[g].value==b){g++}else{break}}}return g-h};Exhibit.Database._RangeIndex.prototype._indexOf=function(a){var c=this._pairs;if(c.length==0||c[0].value>=a){return 0}var g=0;var e=c.length;while(g+1<e){var b=(g+e)>>1;var d=c[b].value;if(d>=a){e=b}else{g=b}}return e};Exhibit.BibtexExporter={getLabel:function(){return"Bibtex"},_excludeProperties:{"pub-type":true,type:true,uri:true,key:true}};Exhibit.BibtexExporter.exportOne=function(b,a){return Exhibit.BibtexExporter._wrap(Exhibit.BibtexExporter._exportOne(b,a))};Exhibit.BibtexExporter.exportMany=function(c,b){var a="";c.visit(function(d){a+=Exhibit.BibtexExporter._exportOne(d,b)+"\n"});return Exhibit.BibtexExporter._wrap(a)};Exhibit.BibtexExporter._exportOne=function(a,l){var o="";var d=l.getObject(a,"pub-type");var m=l.getObject(a,"key");m=(m!=null?m:a);m=m.replace(/[\s,]/g,"-");o+="@"+d+"{"+m+",\n";var e=l.getAllProperties();for(var c=0;c<e.length;c++){var n=e[c];var k=l.getProperty(n);var h=l.getObjects(a,n);var b=k.getValueType();if(h.size()>0&&!(n in Exhibit.BibtexExporter._excludeProperties)){o+="\t"+(n=="label"?"title":n)+' = "';var g;if(b=="item"){g=[];h.visit(function(i){g.push(l.getObject(i,"label"))})}else{if(b=="url"){g=[];h.visit(function(i){g.push(Exhibit.Persistence.resolveURL(i))})}else{g=h.toArray()}}o+=g.join(" and ")+'",\n'}}o+='\torigin = "'+Exhibit.Persistence.getItemLink(a)+'"\n';o+="}\n";return o};Exhibit.BibtexExporter._wrap=function(a){return a};Exhibit.ExhibitJsonExporter={getLabel:function(){return Exhibit.l10n.exhibitJsonExporterLabel}};Exhibit.ExhibitJsonExporter.exportOne=function(b,a){return Exhibit.ExhibitJsonExporter._wrap(Exhibit.ExhibitJsonExporter._exportOne(b,a)+"\n")};Exhibit.ExhibitJsonExporter.exportMany=function(e,d){var b="";var a=e.size();var c=0;e.visit(function(g){b+=Exhibit.ExhibitJsonExporter._exportOne(g,d)+((c++<a-1)?",\n":"\n")});return Exhibit.ExhibitJsonExporter._wrap(b)};Exhibit.ExhibitJsonExporter._exportOne=function(b,n){function a(i){if(/[\\\x00-\x1F\x22]/.test(i)){return'"'+i.replace(/([\\\x00-\x1f\x22])/g,function(r,q){var s={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"}[q];if(s){return s}s=q.charCodeAt();return"\\x"+Math.floor(s/16).toString(16)+(s%16).toString(16)})+'"'}return'"'+i+'"'}var p="";var c=n.getObject(b,"uri");p+='  {"id":'+a(b)+",\n";var k=n.getAllProperties();for(var g=0;g<k.length;g++){var o=k[g];var m=n.getProperty(o);var l=n.getObjects(b,o);var d=m.getValueType();if(l.size()>0){var h;if(d=="url"){h=[];l.visit(function(i){h.push(Exhibit.Persistence.resolveURL(i))})}else{h=l.toArray()}p+="   "+a(o)+":";if(h.length==1){p+=a(h[0])}else{p+="[";for(var e=0;e<h.length;e++){p+=(e>0?",":"")+a(h[e])}p+="]"}p+=",\n"}}p+='   "origin":'+a(Exhibit.Persistence.getItemLink(b))+"\n";p+="  }";return p};Exhibit.ExhibitJsonExporter._wrap=function(a){return'{\n "items":[\n'+a+" ]\n}"};Exhibit.RdfXmlExporter={getLabel:function(){return Exhibit.l10n.rdfXmlExporterLabel}};Exhibit.RdfXmlExporter.exportOne=function(d,c){var b={};var a={};c.getNamespaces(b,a);return Exhibit.RdfXmlExporter._wrapRdf(Exhibit.RdfXmlExporter._exportOne(d,c,b,a),a)};Exhibit.RdfXmlExporter.exportMany=function(e,d){var b="";var c={};var a={};d.getNamespaces(c,a);e.visit(function(g){b+=Exhibit.RdfXmlExporter._exportOne(g,d,c,a)+"\n"});return Exhibit.RdfXmlExporter._wrapRdf(b,a)};Exhibit.RdfXmlExporter._exportOne=function(a,o,b,l){var q="";var c=o.getObject(a,"uri");q+="<rdf:Description rdf:about='"+c+"'>\n";var k=o.getAllProperties();for(var g=0;g<k.length;g++){var p=k[g];var n=o.getProperty(p);var m=o.getObjects(a,p);var e=n.getValueType();var h;if(p in b){var d=b[p];h=d.prefix+":"+d.localName}else{h=n.getURI()}if(e=="item"){m.visit(function(i){q+="\t<"+h+" rdf:resource='"+i+"' />\n"})}else{if(p!="uri"){if(e=="url"){m.visit(function(i){q+="\t<"+h+">"+Exhibit.Persistence.resolveURL(i)+"</"+h+">\n"})}else{m.visit(function(i){q+="\t<"+h+">"+i+"</"+h+">\n"})}}}}q+="\t<exhibit:origin>"+Exhibit.Persistence.getItemLink(a)+"</exhibit:origin>\n";q+="</rdf:Description>";return q};Exhibit.RdfXmlExporter._wrapRdf=function(c,b){var a="<?xml version='1.0'?>\n<rdf:RDF xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns#'\n\txmlns:exhibit='http://simile.mit.edu/2006/11/exhibit#'";for(prefix in b){a+="\n\txmlns:"+prefix+"='"+b[prefix]+"'"}a+=">\n"+c+"\n</rdf:RDF>";return a};Exhibit.SemanticWikitextExporter={getLabel:function(){return Exhibit.l10n.smwExporterLabel}};Exhibit.SemanticWikitextExporter.exportOne=function(b,a){return Exhibit.SemanticWikitextExporter._wrap(Exhibit.SemanticWikitextExporter._exportOne(b,a))};Exhibit.SemanticWikitextExporter.exportMany=function(c,b){var a="";c.visit(function(d){a+=Exhibit.SemanticWikitextExporter._exportOne(d,b)+"\n"});return Exhibit.SemanticWikitextExporter._wrap(a)};Exhibit.SemanticWikitextExporter._exportOne=function(a,h){var m="";var b=h.getObject(a,"uri");m+=b+"\n";var e=h.getAllProperties();for(var d=0;d<e.length;d++){var l=e[d];var k=h.getProperty(l);var g=h.getObjects(a,l);var c=k.getValueType();if(c=="item"){g.visit(function(i){m+="[["+l+"::"+i+"]]\n"})}else{if(c=="url"){g.visit(function(i){m+="[["+l+":="+Exhibit.Persistence.resolveURL(i)+"]]\n"})}else{g.visit(function(i){m+="[["+l+":="+i+"]]\n"})}}}m+="[[origin:="+Exhibit.Persistence.getItemLink(a)+"]]\n";m+="\n";return m};Exhibit.SemanticWikitextExporter._wrap=function(a){return a};Exhibit.TSVExporter={getLabel:function(){return Exhibit.l10n.tsvExporterLabel}};Exhibit.TSVExporter.exportOne=function(b,a){return Exhibit.TSVExporter._wrap(Exhibit.TSVExporter._exportOne(b,a),a)};Exhibit.TSVExporter.exportMany=function(c,b){var a="";c.visit(function(d){a+=Exhibit.TSVExporter._exportOne(d,b)+"\n"});return Exhibit.TSVExporter._wrap(a,b)};Exhibit.TSVExporter._exportOne=function(a,e){var l="";var d=e.getAllProperties();for(var c=0;c<d.length;c++){var k=d[c];var g=e.getProperty(k);var h=e.getObjects(a,k);var b=g.getValueType();l+=h.toArray().join("; ")+"\t"}return l};Exhibit.TSVExporter._wrap=function(c,e){var k="";var b=e.getAllProperties();for(var a=0;a<b.length;a++){var g=b[a];var d=e.getProperty(g);var h=d.getValueType();k+=g+":"+h+"\t"}return k+"\n"+c};Exhibit.ExpressionParser=new Object();Exhibit.ExpressionParser.parse=function(c,d,a){d=d||0;a=a||{};var b=new Exhibit.ExpressionScanner(c,d);try{return Exhibit.ExpressionParser._internalParse(b,false)}finally{a.index=b.token()!=null?b.token().start:b.index()}};Exhibit.ExpressionParser.parseSeveral=function(c,d,a){d=d||0;a=a||{};var b=new Exhibit.ExpressionScanner(c,d);try{return Exhibit.ExpressionParser._internalParse(b,true)}finally{a.index=b.token()!=null?b.token().start:b.index()}};Exhibit.ExpressionParser._internalParse=function(i,q){var b=Exhibit.ExpressionScanner;var h=i.token();var k=function(){i.next();h=i.token()};var m=function(){return h!=null?h.start:i.index()};var n=function(){var s=new Exhibit.Expression.Path();while(h!=null&&h.type==b.PATH_OPERATOR){var r=h.value;k();if(h!=null&&h.type==b.IDENTIFIER){s.appendSegment(h.value,r);k()}else{throw new Error("Missing property ID at position "+m())}}return s};var o=function(){if(h==null){throw new Error("Missing factor at end of expression")}var r=null;switch(h.type){case b.NUMBER:r=new Exhibit.Expression._Constant(h.value,"number");k();break;case b.STRING:r=new Exhibit.Expression._Constant(h.value,"text");k();break;case b.PATH_OPERATOR:r=n();break;case b.IDENTIFIER:var t=h.value;k();if(t in Exhibit.Controls){if(h!=null&&h.type==b.DELIMITER&&h.value=="("){k();var s=(h!=null&&h.type==b.DELIMITER&&h.value==")")?[]:e();r=new Exhibit.Expression._ControlCall(t,s);if(h!=null&&h.type==b.DELIMITER&&h.value==")"){k()}else{throw new Error("Missing ) to end "+t+" at position "+m())}}else{throw new Error("Missing ( to start "+t+" at position "+m())}}else{if(h!=null&&h.type==b.DELIMITER&&h.value=="("){k();var s=(h!=null&&h.type==b.DELIMITER&&h.value==")")?[]:e();r=new Exhibit.Expression._FunctionCall(t,s);if(h!=null&&h.type==b.DELIMITER&&h.value==")"){k()}else{throw new Error("Missing ) after function call "+t+" at position "+m())}}else{r=n();r.setRootName(t)}}break;case b.DELIMITER:if(h.value=="("){k();r=c();if(h!=null&&h.type==b.DELIMITER&&h.value==")"){k();break}else{throw new Error("Missing ) at position "+m())}}default:throw new Error("Unexpected text "+h.value+" at position "+m())}return r};var d=function(){var s=o();while(h!=null&&h.type==b.OPERATOR&&(h.value=="*"||h.value=="/")){var r=h.value;k();s=new Exhibit.Expression._Operator(r,[s,o()])}return s};var g=function(){var s=d();while(h!=null&&h.type==b.OPERATOR&&(h.value=="+"||h.value=="-")){var r=h.value;k();s=new Exhibit.Expression._Operator(r,[s,d()])}return s};var c=function(){var s=g();while(h!=null&&h.type==b.OPERATOR&&(h.value=="="||h.value=="<>"||h.value=="<"||h.value=="<="||h.value==">"||h.value==">=")){var r=h.value;k();s=new Exhibit.Expression._Operator(r,[s,g()])}return s};var e=function(){var r=[c()];while(h!=null&&h.type==b.DELIMITER&&h.value==","){k();r.push(c())}return r};if(q){var p=e();var l=[];for(var a=0;a<p.length;a++){l.push(new Exhibit.Expression._Impl(p[a]))}return l}else{return new Exhibit.Expression._Impl(c())}};Exhibit.ExpressionScanner=function(b,a){this._text=b+" ";this._maxIndex=b.length;this._index=a;this.next()};Exhibit.ExpressionScanner.DELIMITER=0;Exhibit.ExpressionScanner.NUMBER=1;Exhibit.ExpressionScanner.STRING=2;Exhibit.ExpressionScanner.IDENTIFIER=3;Exhibit.ExpressionScanner.OPERATOR=4;Exhibit.ExpressionScanner.PATH_OPERATOR=5;Exhibit.ExpressionScanner.prototype.token=function(){return this._token};Exhibit.ExpressionScanner.prototype.index=function(){return this._index};Exhibit.ExpressionScanner.prototype.next=function(){this._token=null;while(this._index<this._maxIndex&&" \t\r\n".indexOf(this._text.charAt(this._index))>=0){this._index++}if(this._index<this._maxIndex){var d=this._text.charAt(this._index);var b=this._text.charAt(this._index+1);if(".!".indexOf(d)>=0){if(b=="@"){this._token={type:Exhibit.ExpressionScanner.PATH_OPERATOR,value:d+b,start:this._index,end:this._index+2};this._index+=2}else{this._token={type:Exhibit.ExpressionScanner.PATH_OPERATOR,value:d,start:this._index,end:this._index+1};this._index++}}else{if("<>".indexOf(d)>=0){if((b=="=")||("<>".indexOf(b)>=0&&d!=b)){this._token={type:Exhibit.ExpressionScanner.OPERATOR,value:d+b,start:this._index,end:this._index+2};this._index+=2}else{this._token={type:Exhibit.ExpressionScanner.OPERATOR,value:d,start:this._index,end:this._index+1};this._index++}}else{if("+-*/=".indexOf(d)>=0){this._token={type:Exhibit.ExpressionScanner.OPERATOR,value:d,start:this._index,end:this._index+1};this._index++}else{if("(),".indexOf(d)>=0){this._token={type:Exhibit.ExpressionScanner.DELIMITER,value:d,start:this._index,end:this._index+1};this._index++}else{if("\"'".indexOf(d)>=0){var a=this._index+1;while(a<this._maxIndex){if(this._text.charAt(a)==d&&this._text.charAt(a-1)!="\\"){break}a++}if(a<this._maxIndex){this._token={type:Exhibit.ExpressionScanner.STRING,value:this._text.substring(this._index+1,a).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:this._index,end:a+1};this._index=a+1}else{throw new Error("Unterminated string starting at "+this._index)}}else{if(this._isDigit(d)){var a=this._index;while(a<this._maxIndex&&this._isDigit(this._text.charAt(a))){a++}if(a<this._maxIndex&&this._text.charAt(a)=="."){a++;while(a<this._maxIndex&&this._isDigit(this._text.charAt(a))){a++}}this._token={type:Exhibit.ExpressionScanner.NUMBER,value:parseFloat(this._text.substring(this._index,a)),start:this._index,end:a};this._index=a}else{var a=this._index;while(a<this._maxIndex){var e=this._text.charAt(a);if("(),.!@ \t".indexOf(e)<0){a++}else{break}}this._token={type:Exhibit.ExpressionScanner.IDENTIFIER,value:this._text.substring(this._index,a),start:this._index,end:a};this._index=a}}}}}}}};Exhibit.ExpressionScanner.prototype._isDigit=function(a){return"0123456789".indexOf(a)>=0};Exhibit.Expression=new Object();Exhibit.Expression._Impl=function(a){this._rootNode=a};Exhibit.Expression._Impl.prototype.evaluate=function(a,b,e,c){var d=this._rootNode.evaluate(a,b,e,c);return{values:d.getSet(),valueType:d.valueType,size:d.size}};Exhibit.Expression._Impl.prototype.evaluateOnItem=function(b,a){return this.evaluate({value:b},{value:"item"},"value",a)};Exhibit.Expression._Impl.prototype.evaluateSingle=function(b,c,g,d){var e=this._rootNode.evaluate(b,c,g,d);var a={value:null,valueType:e.valueType};e.forEachValue(function(h){a.value=h;return true});return a};Exhibit.Expression._Impl.prototype.evaluateSingleOnItem=function(b,a){return this.evaluateSingle({value:b},{value:"item"},"value",a)};Exhibit.Expression._Impl.prototype.testExists=function(a,b,d,c){return this.isPath()?this._rootNode.testExists(a,b,d,c):this.evaluate(a,b,d,c).values.size()>0};Exhibit.Expression._Impl.prototype.isPath=function(){return this._rootNode instanceof Exhibit.Expression.Path};Exhibit.Expression._Impl.prototype.getPath=function(){return this.isPath()?this._rootNode:null};Exhibit.Expression._Collection=function(a,b){this._values=a;this.valueType=b;if(a instanceof Array){this.forEachValue=Exhibit.Expression._Collection._forEachValueInArray;this.getSet=Exhibit.Expression._Collection._getSetFromArray;this.contains=Exhibit.Expression._Collection._containsInArray;this.size=a.length}else{this.forEachValue=Exhibit.Expression._Collection._forEachValueInSet;this.getSet=Exhibit.Expression._Collection._getSetFromSet;this.contains=Exhibit.Expression._Collection._containsInSet;this.size=a.size()}};Exhibit.Expression._Collection._forEachValueInSet=function(a){this._values.visit(a)};Exhibit.Expression._Collection._forEachValueInArray=function(d){var b=this._values;for(var c=0;c<b.length;c++){if(d(b[c])){break}}};Exhibit.Expression._Collection._getSetFromSet=function(){return this._values};Exhibit.Expression._Collection._getSetFromArray=function(){return new Exhibit.Set(this._values)};Exhibit.Expression._Collection._containsInSet=function(a){this._values.contains(a)};Exhibit.Expression._Collection._containsInArray=function(c){var b=this._values;for(var d=0;d<b.length;d++){if(b[d]==c){return true}}return false};Exhibit.Expression.Path=function(){this._rootName=null;this._segments=[]};Exhibit.Expression.Path.create=function(b,a){var c=new Exhibit.Expression.Path();c._segments.push({property:b,forward:a,isArray:false});return c};Exhibit.Expression.Path.prototype.setRootName=function(a){this._rootName=a};Exhibit.Expression.Path.prototype.appendSegment=function(b,a){this._segments.push({property:b,forward:a.charAt(0)==".",isArray:a.length>1})};Exhibit.Expression.Path.prototype.getSegment=function(a){if(a<this._segments.length){var b=this._segments[a];return{property:b.property,forward:b.forward,isArray:b.isArray}}else{return null}};Exhibit.Expression.Path.prototype.getLastSegment=function(){return this.getSegment(this._segments.length-1)};Exhibit.Expression.Path.prototype.getSegmentCount=function(){return this._segments.length};Exhibit.Expression.Path.prototype.evaluate=function(b,c,i,d){var h=this._rootName!=null?this._rootName:i;var g=h in c?c[h]:"text";var e=null;if(h in b){var a=b[h];if(a instanceof Exhibit.Set||a instanceof Array){e=new Exhibit.Expression._Collection(a,g)}else{e=new Exhibit.Expression._Collection([a],g)}return this._walkForward(e,d)}else{throw new Error("No such variable called "+h)}};Exhibit.Expression.Path.prototype.evaluateBackward=function(c,e,a,b){var d=new Exhibit.Expression._Collection([c],e);return this._walkBackward(d,a,b)};Exhibit.Expression.Path.prototype.walkForward=function(a,c,b){return this._walkForward(new Exhibit.Expression._Collection(a,c),b)};Exhibit.Expression.Path.prototype.walkBackward=function(a,d,b,c){return this._walkBackward(new Exhibit.Expression._Collection(a,d),b,c)};Exhibit.Expression.Path.prototype._walkForward=function(k,h){for(var d=0;d<this._segments.length;d++){var e=this._segments[d];if(e.isArray){var b=[];var l;if(e.forward){k.forEachValue(function(a){h.getObjects(a,e.property).visit(function(i){b.push(i)})});var g=h.getProperty(e.property);l=g!=null?g.getValueType():"text"}else{k.forEachValue(function(a){h.getSubjects(a,e.property).visit(function(i){b.push(i)})});l="item"}k=new Exhibit.Expression._Collection(b,l)}else{if(e.forward){var c=h.getObjectsUnion(k.getSet(),e.property);var g=h.getProperty(e.property);var l=g!=null?g.getValueType():"text";k=new Exhibit.Expression._Collection(c,l)}else{var c=h.getSubjectsUnion(k.getSet(),e.property);k=new Exhibit.Expression._Collection(c,"item")}}}return k};Exhibit.Expression.Path.prototype._walkBackward=function(e,b,l){for(var d=this._segments.length-1;d>=0;d--){var g=this._segments[d];if(g.isArray){var h=[];var c;if(g.forward){e.forEachValue(function(a){l.getSubjects(a,g.property).visit(function(i){if(d>0||b==null||b.contains(i)){h.push(i)}})});var m=l.getProperty(g.property);c=m!=null?m.getValueType():"text"}else{e.forEachValue(function(a){l.getObjects(a,g.property).visit(function(i){if(d>0||b==null||b.contains(i)){h.push(i)}})});c="item"}e=new Exhibit.Expression._Collection(h,c)}else{if(g.forward){var k=l.getSubjectsUnion(e.getSet(),g.property,null,d==0?b:null);e=new Exhibit.Expression._Collection(k,"item")}else{var k=l.getObjectsUnion(e.getSet(),g.property,null,d==0?b:null);var m=l.getProperty(g.property);var c=m!=null?m.getValueType():"text";e=new Exhibit.Expression._Collection(k,c)}}}return e};Exhibit.Expression.Path.prototype.rangeBackward=function(e,g,a,l){var h=new Exhibit.Set();var b="item";if(this._segments.length>0){var d=this._segments[this._segments.length-1];if(d.forward){l.getSubjectsInRange(d.property,e,g,false,h,this._segments.length==1?a:null)}else{throw new Error("Last path of segment must be forward")}for(var c=this._segments.length-2;c>=0;c--){d=this._segments[c];if(d.forward){h=l.getSubjectsUnion(h,d.property,null,c==0?a:null);b="item"}else{h=l.getObjectsUnion(h,d.property,null,c==0?a:null);var k=l.getProperty(d.property);b=k!=null?k.getValueType():"text"}}}return{valueType:b,values:h,count:h.size()}};Exhibit.Expression.Path.prototype.testExists=function(a,b,d,c){return this.evaluate(a,b,d,c).size>0};Exhibit.Expression._Constant=function(a,b){this._value=a;this._valueType=b};Exhibit.Expression._Constant.prototype.evaluate=function(a,b,d,c){return new Exhibit.Expression._Collection([this._value],this._valueType)};Exhibit.Expression._Operator=function(a,b){this._operator=a;this._args=b};Exhibit.Expression._Operator.prototype.evaluate=function(k,l,b,g){var h=[];var e=[];for(var c=0;c<this._args.length;c++){e.push(this._args[c].evaluate(k,l,b,g))}var a=Exhibit.Expression._operators[this._operator];var d=a.f;if(a.argumentType=="number"){e[0].forEachValue(function(i){if(!(typeof i=="number")){i=parseFloat(i)}e[1].forEachValue(function(m){if(!(typeof m=="number")){m=parseFloat(m)}h.push(d(i,m))})})}else{e[0].forEachValue(function(i){e[1].forEachValue(function(m){h.push(d(i,m))})})}return new Exhibit.Expression._Collection(h,a.valueType)};Exhibit.Expression._operators={"+":{argumentType:"number",valueType:"number",f:function(d,c){return d+c}},"-":{argumentType:"number",valueType:"number",f:function(d,c){return d-c}},"*":{argumentType:"number",valueType:"number",f:function(d,c){return d*c}},"/":{argumentType:"number",valueType:"number",f:function(d,c){return d/c}},"=":{valueType:"boolean",f:function(d,c){return d==c}},"<>":{valueType:"boolean",f:function(d,c){return d!=c}},"><":{valueType:"boolean",f:function(d,c){return d!=c}},"<":{argumentType:"number",valueType:"boolean",f:function(d,c){return d<c}},">":{argumentType:"number",valueType:"boolean",f:function(d,c){return d>c}},"<=":{argumentType:"number",valueType:"boolean",f:function(d,c){return d<=c}},">=":{argumentType:"number",valueType:"boolean",f:function(d,c){return d>=c}}};Exhibit.Expression._FunctionCall=function(b,a){this._name=b;this._args=a};Exhibit.Expression._FunctionCall.prototype.evaluate=function(a,c,g,e){var b=[];for(var d=0;d<this._args.length;d++){b.push(this._args[d].evaluate(a,c,g,e))}if(this._name in Exhibit.Functions){return Exhibit.Functions[this._name].f(b)}else{throw new Error("No such function named "+this._name)}};Exhibit.Expression._ControlCall=function(b,a){this._name=b;this._args=a};Exhibit.Expression._ControlCall.prototype.evaluate=function(a,b,d,c){return Exhibit.Controls[this._name].f(this._args,a,b,d,c)};Exhibit.Functions={};Exhibit.Functions.union={f:function(b){var e=new Exhibit.Set();var d=null;if(b.length>0){var d=b[0].valueType;for(var c=0;c<b.length;c++){var a=b[c];if(a.size>0){if(d==null){d=a.valueType}e.addSet(a.getSet())}}}return new Exhibit.Expression._Collection(e,d!=null?d:"text")}};Exhibit.Functions.contains={f:function(b){var a=b[0].size>0;var c=b[0].getSet();b[1].forEachValue(function(d){if(!c.contains(d)){a=false;return true}});return new Exhibit.Expression._Collection([a],"boolean")}};Exhibit.Functions.exists={f:function(a){return new Exhibit.Expression._Collection([a[0].size>0],"boolean")}};Exhibit.Functions.count={f:function(a){return new Exhibit.Expression._Collection([a[0].size],"number")}};Exhibit.Functions.not={f:function(a){return new Exhibit.Expression._Collection([!a[0].contains(true)],"boolean")}};Exhibit.Functions.add={f:function(a){var c=0;for(var b=0;b<a.length;b++){a[b].forEachValue(function(d){if(d!=null){if(typeof d=="number"){c+=d}else{var e=parseFloat(d);if(!isNaN(e)){c+=e}}}})}return new Exhibit.Expression._Collection([c],"number")}};Exhibit.Functions.concat={f:function(b){var a=[];for(var c=0;c<b.length;c++){b[c].forEachValue(function(d){if(d!=null){a.push(d)}})}return new Exhibit.Expression._Collection([a.join("")],"text")}};Exhibit.Functions.multiply={f:function(a){var c=1;for(var b=0;b<a.length;b++){a[b].forEachValue(function(d){if(d!=null){if(typeof d=="number"){c*=d}else{var e=parseFloat(d);if(!isNaN(e)){c*=e}}}})}return new Exhibit.Expression._Collection([c],"number")}};Exhibit.Functions["date-range"]={_parseDate:function(a){if(a==null){return Number.NEGATIVE_INFINITY}else{if(a instanceof Date){return a.getTime()}else{try{return SimileAjax.DateTime.parseIso8601DateTime(a).getTime()}catch(b){return Number.NEGATIVE_INFINITY}}}},_factors:{second:1000,minute:60*1000,hour:60*60*1000,day:24*60*60*1000,week:7*24*60*60*1000,month:30*24*60*60*1000,quarter:3*30*24*60*60*1000,year:365*24*60*60*1000,decade:10*365*24*60*60*1000,century:100*365*24*60*60*1000},_computeRange:function(d,c,b){var a=c-d;if(isFinite(a)){if(b in this._factors){a=Math.round(a/this._factors[b])}return a}return null},f:function(d){var c=this;var g=Number.POSITIVE_INFINITY;d[0].forEachValue(function(h){g=Math.min(g,c._parseDate(h))});var e=Number.NEGATIVE_INFINITY;d[1].forEachValue(function(h){e=Math.max(e,c._parseDate(h))});var b="day";d[2].forEachValue(function(h){b=h});var a=this._computeRange(g,e,b);return new Exhibit.Expression._Collection(a!=null?[a]:[],"number")}};Exhibit.Functions.distance={_units:{km:1000,mile:1609.344},_computeDistance:function(e,d,b,c){var a=e.distanceFrom(d);if(!c){c=1}if(isFinite(a)){if(this._units.hasOwnProperty(b)){a=a/this._units[b]}return Exhibit.Util.round(a,c)}return null},f:function(h){var m=this;var d={};var a=["origo","lat","lng","unit","round"];for(var e=0,c;c=a[e];e++){h[e].forEachValue(function(i){d[c]=i})}var b=d.origo.split(",");var l=new GLatLng(b[0],b[1]);var k=new GLatLng(d.lat,d.lng);var g=this._computeDistance(l,k,d.unit,d.round);return new Exhibit.Expression._Collection(g!=null?[g]:[],"number")}};Exhibit.Functions.min={f:function(d){var c=function(i){return i};var g=Number.POSITIVE_INFINITY;var k=null;for(var e=0;e<d.length;e++){var b=d[e];var a=b.valueType?b.valueType:"text";var h=Exhibit.SettingsUtilities._typeToParser(a);b.forEachValue(function(i){parsedV=h(i,c);if(parsedV<g||g==Number.POSITIVE_INFINITY){g=parsedV;k=(k==null)?a:(k==a?k:"text")}})}return new Exhibit.Expression._Collection([g],k!=null?k:"text")}};Exhibit.Functions.max={f:function(e){var d=function(i){return i};var c=Number.NEGATIVE_INFINITY;var k=null;for(var g=0;g<e.length;g++){var b=e[g];var a=b.valueType?b.valueType:"text";var h=Exhibit.SettingsUtilities._typeToParser(a);b.forEachValue(function(i){parsedV=h(i,d);if(parsedV>c||c==Number.NEGATIVE_INFINITY){c=parsedV;k=(k==null)?a:(k==a?k:"text")}})}return new Exhibit.Expression._Collection([c],k!=null?k:"text")}};Exhibit.Functions.remove={f:function(b){var e=b[0].getSet();var d=b[0].valueType;for(var c=1;c<b.length;c++){var a=b[c];if(a.size>0){e.removeSet(a.getSet())}}return new Exhibit.Expression._Collection(e,d)}};Exhibit.Functions.now={f:function(a){return new Exhibit.Expression._Collection([new Date()],"date")}};Exhibit.BabelBasedImporter={mimetypeToReader:{"application/rdf+xml":"rdf-xml","application/n3":"n3","application/msexcel":"xls","application/x-msexcel":"xls","application/x-ms-excel":"xls","application/vnd.ms-excel":"xls","application/x-excel":"xls","application/xls":"xls","application/x-xls":"xls","application/x-bibtex":"bibtex"}};Exhibit.importers["application/rdf+xml"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/n3"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/msexcel"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/x-msexcel"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/vnd.ms-excel"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/x-excel"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/xls"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/x-xls"]=Exhibit.BabelBasedImporter;Exhibit.importers["application/x-bibtex"]=Exhibit.BabelBasedImporter;Exhibit.BabelBasedImporter.load=function(g,i,b){var d=(typeof g=="string")?Exhibit.Persistence.resolveURL(g):Exhibit.Persistence.resolveURL(g.href);var a="rdf-xml";var h="exhibit-jsonp";if(typeof g!="string"){var c=g.type;if(c in Exhibit.BabelBasedImporter.mimetypeToReader){a=Exhibit.BabelBasedImporter.mimetypeToReader[c]}}if(a=="bibtex"){h="bibtex-exhibit-jsonp"}var e="http://simile.mit.edu/babel/translator?"+["reader="+a,"writer="+h,"url="+encodeURIComponent(d)].join("&");return Exhibit.JSONPImporter.load(e,i,b)};Exhibit.ExhibitJSONImporter={};Exhibit.importers["application/json"]=Exhibit.ExhibitJSONImporter;Exhibit.ExhibitJSONImporter.load=function(link,database,cont){var url=typeof link=="string"?link:link.href;url=Exhibit.Persistence.resolveURL(url);var fError=function(statusText,status,xmlhttp){Exhibit.UI.hideBusyIndicator();Exhibit.UI.showHelp(Exhibit.l10n.failedToLoadDataFileMessage(url));if(cont){cont()}};var fDone=function(xmlhttp){Exhibit.UI.hideBusyIndicator();try{var o=null;try{o=eval("("+xmlhttp.responseText+")")}catch(e){Exhibit.UI.showJsonFileValidation(Exhibit.l10n.badJsonMessage(url,e),url)}if(o!=null){database.loadData(o,Exhibit.Persistence.getBaseURL(url))}}catch(e){SimileAjax.Debug.exception(e,"Error loading Exhibit JSON data from "+url)}finally{if(cont){cont()}}};Exhibit.UI.showBusyIndicator();SimileAjax.XmlHttp.get(url,fError,fDone)};Exhibit.HtmlTableImporter={};Exhibit.importers["text/html"]=Exhibit.HtmlTableImporter;Exhibit.HtmlTableImporter.load=function(i,l,n){var a=typeof i=="string"?i:i.href;if(a.substr(0,1)=="#"){try{var b=/#(.*)/.exec(f)[1];var m=document.getElementById(b);m.style.display="none";Exhibit.HtmlTableImporter.loadTable(m,l)}catch(g){SimileAjax.Debug.exception(g)}finally{if(n){n()}}}else{if(typeof i!="string"){var d=i.getAttribute("ex:xpath");var c=(i.getAttribute("ex:columns")).split(",");var h="http://simile.mit.edu/babel/html-extractor?"+["xpath="+d,"url="+encodeURIComponent(a)].join("&");var k=function(p){var s=document.createElement("div");s.innerHTML=p;var r=s.firstChild;var q,e=r.getElementsByTagName("th");for(col=0;q=e[col];col++){var o=c[col];q.setAttribute("ex:name",o)}Exhibit.HtmlTableImporter.loadTable(r,l);return{}};return Exhibit.JSONPImporter.load(h,l,n,k)}else{if(n){n()}}}};Exhibit.HtmlTableImporter.loadTable=function(D,w){var p=function(I){return I.textContent||I.innerText||""};var F=function(M,K){var J={},O=false,I,N,L;for(L=0;I=K[L];L++){N=Exhibit.getAttribute(M,I);if(N){J[I]=N;O=true}}return O&&J};var a=["uri","label","pluralLabel"];var e=["uri","valueType","label","reverseLabel","pluralLabel","reversePluralLabel","groupingLabel","reverseGroupingLabel"];var C=["valueParser","arity"];var r={};var h=Exhibit.getAttribute(D,"type");var s=h&&F(D,a);if(s){r.types={};r.types[h]=s}var y=[],g={},i=[],o,k;var b,t=D.getElementsByTagName("tr");var l,d=t[0].getElementsByTagName("th");for(k=0;l=d[k];k++){var c=p(l).trim();var n=false;var z=F(l,e);var H=Exhibit.getAttribute(l,"name");if(H){z=z||{};z.label=z.label||c;c=H}if(z){g[c]=z;if(g[c].valueType=="textwithlink"){g[c].valueType="text";g[(c+"-link")]={valueType:"url"};n=true}r.properties=g}y.push(c);z=F(l,C)||{};if(z.valueParser&&z.valueParser in window){z.valueParser=window[z.valueParser]}else{if(z.arity=="single"){z.valueParser=function(L,J,K,I){return L.trim()}}else{z.valueParser=function(N,K,M,J){if(N.indexOf(";")==-1){return N.trim()}var L=N.split(";");for(var I=0;I<L.length;I++){L[I]=L[I].trim()}return L};if(n){var A=z.valueParser;z.valueParser=function(N,K,M,J){var I=K.getElementsByTagName("a");if(!I.length){return A(N,K,M,J)}var L={};L[y[J]]=N.trim();L[(y[J]+"-link")]=I[0].href;return L}}}}i[k]=z}var G,v=D.getElementsByTagName("img");while(G=v[0]){G.parentNode.replaceChild(document.createTextNode(G.src),G)}var x=[],q,u;for(o=1;b=t[o];o++){var E={};var B=b.getElementsByTagName("td");for(k=0;q=B[k];k++){var u=p(q);data=i[k].valueParser(u,q,o,k);if(data==null||u===""){continue}if(typeof data=="object"&&!(data instanceof Array)){for(var m in data){E[m]=data[m]}}else{E[y[k]]=data}}if(h){E.type=h}x.push(E);r.items=x}w.loadData(r,Exhibit.Persistence.resolveURL(location.href))};Exhibit.JSONPImporter={_callbacks:{}};Exhibit.importers["application/jsonp"]=Exhibit.JSONPImporter;Exhibit.JSONPImporter.load=function(link,database,cont,fConvert,staticJSONPCallback,charset){var url=link;if(typeof link!="string"){url=Exhibit.Persistence.resolveURL(link.href);fConvert=Exhibit.getAttribute(link,"converter");staticJSONPCallback=Exhibit.getAttribute(link,"jsonp-callback");charset=Exhibit.getAttribute(link,"charset")}if(typeof fConvert=="string"){var name=fConvert;name=name.charAt(0).toLowerCase()+name.substring(1)+"Converter";if(name in Exhibit.JSONPImporter){fConvert=Exhibit.JSONPImporter[name]}else{try{fConvert=eval(fConvert)}catch(e){fConvert=null}}}if(fConvert!=null&&"preprocessURL" in fConvert){url=fConvert.preprocessURL(url)}var next=Exhibit.JSONPImporter._callbacks.next||1;Exhibit.JSONPImporter._callbacks.next=next+1;var callbackName="cb"+next.toString(36);var callbackURL=url;if(callbackURL.indexOf("?")==-1){callbackURL+="?"}var lastChar=callbackURL.charAt(callbackURL.length-1);if(lastChar!="="){if(lastChar!="&"&&lastChar!="?"){callbackURL+="&"}callbackURL+="callback="}var callbackFull="Exhibit.JSONPImporter._callbacks."+callbackName;callbackURL+=callbackFull;var cleanup=function(failedURL){try{Exhibit.UI.hideBusyIndicator();delete Exhibit.JSONPImporter._callbacks[callbackName+"_fail"];delete Exhibit.JSONPImporter._callbacks[callbackName];if(script&&script.parentNode){script.parentNode.removeChild(script)}}finally{if(failedURL){prompt("Failed to load javascript file:",failedURL);cont&&cont(undefined)}}};Exhibit.JSONPImporter._callbacks[callbackName+"_fail"]=cleanup;Exhibit.JSONPImporter._callbacks[callbackName]=function(json){try{cleanup(null);database.loadData(fConvert?fConvert(json,url):json,Exhibit.Persistence.getBaseURL(url))}finally{if(cont){cont(json)}}};if(staticJSONPCallback){callbackURL=url;eval(staticJSONPCallback+"="+callbackFull)}var fail=callbackFull+"_fail('"+callbackURL+"');";var script=SimileAjax.includeJavascriptFile(document,callbackURL,fail,charset);Exhibit.UI.showBusyIndicator();return Exhibit.JSONPImporter._callbacks[callbackName]};Exhibit.JSONPImporter.transformJSON=function(n,e,a,l){var m=n,g=[];if(e){e=e.split(".");while(e.length){m=m[e.shift()]}}for(var d=0,c;c=m[d];d++){var k={};for(var b in a){var e=a[b];if(!a.hasOwnProperty(b)||!c.hasOwnProperty(e)){continue}var h=c[e];if(l&&l.hasOwnProperty(b)){h=l[b](h,c,d,m,n)}if(typeof h!="undefined"){k[b]=h}}g.push(k)}return g};Exhibit.JSONPImporter.deliciousConverter=function(c,b){var a=Exhibit.JSONPImporter.transformJSON(c,null,{label:"u",note:"n",description:"d",tags:"t"});return{items:a,properties:{url:{valueType:"url"}}}};Exhibit.JSONPImporter.googleSpreadsheetsConverter=function(C,h){var x=[];var m={};var s={};var p={text:true,number:true,item:true,url:true,"boolean":true};var u=C.feed.entry;for(var A=0;A<u.length;A++){var b=u[A];var y=b.id.$t;var F=y.lastIndexOf("C");var w=y.lastIndexOf("R");u[A]={row:parseInt(y.substring(w+1,F))-1,col:parseInt(y.substring(F+1))-1,val:b.content.$t}}var o=0;var n=function(){if(o<u.length){var d=u[o++];var i=[d];while(o<u.length){var c=u[o];if(c.row==d.row){i.push(c);o++}else{break}}return i}return null};var e=n();if(e!=null){var G=[];for(var A=0;A<e.length;A++){var a=e[A];var t=a.val.trim().replace(/^\{/g,"").replace(/\}$/g,"").split(":");var g=t[0].trim();var B=t.length>1?t[1].split(","):[];var l={single:false};for(var E=0;E<B.length;E++){var H=B[E].trim();if(H in p){l.valueType=H}else{if(H=="single"){l.single=true}}}G[a.col]=g;m[g]=l}var k=null;while((k=n())!=null){var D={};for(var A=0;A<k.length;A++){var a=k[A];var g=G[a.col];if(typeof g=="string"){D[g]=a.val;var l=m[g];if(!l.single){var z=a.val.split(";");for(var q=0;q<z.length;q++){z[q]=z[q].trim()}D[g]=z}else{D[g]=a.val.trim()}}}x.push(D)}}return{types:s,properties:m,items:x}};Exhibit.JSONPImporter.googleSpreadsheetsConverter.preprocessURL=function(a){return a.replace(/\/list\//g,"/cells/")};var RDFA=new Object();RDFA.url="http://www.w3.org/2006/07/SWD/RDFa/impl/js/20070301/rdfa.js";Exhibit.RDFaImporter={};Exhibit.importers["application/RDFa"]=Exhibit.RDFaImporter;Exhibit.RDFaImporter.load=function(b,c,a){try{if((b.getAttribute("href")||"").length==0){Exhibit.RDFaImporter.loadRDFa(null,document,c)}else{iframe=document.createElement("iframe");iframe.style.display="none";iframe.setAttribute("onLoad","Exhibit.RDFaImporter.loadRDFa(this, this.contentDocument, database)");iframe.src=b.href;document.body.appendChild(iframe)}}catch(d){SimileAjax.Debug.exception(d)}finally{if(a){a()}}};Exhibit.RDFaImporter.loadRDFa=function(c,b,d){var e=function(g){return g.textContent||g.innerText||""};var a=function(m,k){var h={},o=false,g,n,l;for(l=0;g=k[l];l++){n=Exhibit.getAttribute(m,g);if(n){h[g]=n;o=true}}return o&&h};RDFA.CALLBACK_DONE_PARSING=function(){if(c!=null){document.body.removeChild(c)}this.cloneObject=function(v){for(var k in v){this[k]=v[k]}};var s=this.triples;var q={classes:{},properties:{},items:[]};for(var l in s){var t={};t.id,t.uri,t.label=l;var u=s[l];for(var h in u){for(var g=0;g<u[h].length;g++){if(u[h][g].predicate.ns){var p=u[h][g].predicate.ns.prefix+":"+u[h][g].predicate.suffix;if(h=="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"){try{var r=u[h][g]["object"];var m=r.match(/(.+?)(#|\/)([a-zA-Z_]+)?$/);var o=m[3]+"("+m[1]+")";q.classes[o]={label:o,uri:r};t.type=o}catch(n){}}else{q.properties[p]={uri:h,label:u[h][g]["predicate"]["suffix"]};try{if(!t[p]){t[p]=[]}t[p].push(u[h][g]["object"])}catch(n){SimileAjax.Debug.log("problem adding property value: "+n)}if(h=="http://purl.org/dc/elements/1.1/title"||h=="http://www.w3.org/2000/01/rdf-schema#"||h=="http://xmlns.com/foaf/0.1/name"){t.label=t[p]}}}else{t[h]=u[h][g]["object"]}}}q.items.push(new this.cloneObject(t))}d.loadData(q,Exhibit.Persistence.getBaseURL(document.location.href))};RDFA.CALLBACK_DONE_LOADING=function(){RDFA.parse(b)};SimileAjax.includeJavascriptFile(document,RDFA.url)};Exhibit.create=function(a){return new Exhibit._Impl(a)};Exhibit.getAttribute=function(g,c,a){try{var h=g.getAttribute(c);if(h==null){h=g.getAttribute("ex:"+c)}if(a==null){return h}var b=h.split(a);for(var d=0;h=b[d];d++){b[d]=h.trim()}return b}catch(k){return null}};Exhibit.getRoleAttribute=function(a){var b=Exhibit.getAttribute(a,"role");b=b!=null?b:"";b=b.startsWith("exhibit-")?b.substr("exhibit-".length):b;return b};Exhibit.getConfigurationFromDOM=function(elmt){var c=Exhibit.getAttribute(elmt,"configuration");if(c!=null&&c.length>0){try{var o=eval(c);if(typeof o=="object"){return o}}catch(e){}}return{}};Exhibit.getExporters=function(){Exhibit._initializeExporters();return[].concat(Exhibit._exporters)};Exhibit.addExporter=function(a){Exhibit._initializeExporters();Exhibit._exporters.push(a)};Exhibit._initializeExporters=function(){if(!("_exporters" in Exhibit)){Exhibit._exporters=[Exhibit.RdfXmlExporter,Exhibit.SemanticWikitextExporter,Exhibit.TSVExporter,Exhibit.ExhibitJsonExporter]}};Exhibit._Impl=function(a){this._database=a!=null?a:("database" in window?window.database:Exhibit.Database.create());this._uiContext=Exhibit.UIContext.createRootContext({},this);this._collectionMap={};this._componentMap={};this._historyListener={onBeforePerform:function(b){if(b.lengthy){Exhibit.UI.showBusyIndicator()}},onAfterPerform:function(b){if(b.lengthy){Exhibit.UI.hideBusyIndicator()}},onBeforeUndoSeveral:function(){Exhibit.UI.showBusyIndicator()},onAfterUndoSeveral:function(){Exhibit.UI.hideBusyIndicator()},onBeforeRedoSeveral:function(){Exhibit.UI.showBusyIndicator()},onAfterRedoSeveral:function(){Exhibit.UI.hideBusyIndicator()}};SimileAjax.History.addListener(this._historyListener)};Exhibit._Impl.prototype.dispose=function(){SimileAjax.History.removeListener(this._historyListener);for(var b in this._componentMap){try{this._componentMap[b].dispose()}catch(a){SimileAjax.Debug.exception(a,"Failed to dispose component")}}for(var b in this._collectionMap){try{this._collectionMap[b].dispose()}catch(a){SimileAjax.Debug.exception(a,"Failed to dispose collection")}}this._uiContext.dispose();this._componentMap=null;this._collectionMap=null;this._uiContext=null;this._database=null};Exhibit._Impl.prototype.getDatabase=function(){return this._database};Exhibit._Impl.prototype.getUIContext=function(){return this._uiContext};Exhibit._Impl.prototype.getCollection=function(b){var a=this._collectionMap[b];if(a==null&&b=="default"){a=Exhibit.Collection.createAllItemsCollection(b,this._database);this.setDefaultCollection(a)}return a};Exhibit._Impl.prototype.getDefaultCollection=function(){return this.getCollection("default")};Exhibit._Impl.prototype.setCollection=function(d,b){if(d in this._collectionMap){try{this._collectionMap[d].dispose()}catch(a){SimileAjax.Debug.exception(a)}}this._collectionMap[d]=b};Exhibit._Impl.prototype.setDefaultCollection=function(a){this.setCollection("default",a)};Exhibit._Impl.prototype.getComponent=function(a){return this._componentMap[a]};Exhibit._Impl.prototype.setComponent=function(d,b){if(d in this._componentMap){try{this._componentMap[d].dispose()}catch(a){SimileAjax.Debug.exception(a)}}this._componentMap[d]=b};Exhibit._Impl.prototype.disposeComponent=function(b){if(b in this._componentMap){try{this._componentMap[b].dispose()}catch(a){SimileAjax.Debug.exception(a)}delete this._componentMap[b]}};Exhibit._Impl.prototype.configure=function(e){if("collections" in e){for(var c=0;c<e.collections.length;c++){var b=e.collections[c];var d=b.id;if(d==null||d.length==0){d="default"}this.setCollection(d,Exhibit.Collection.create2(d,b,this._uiContext))}}if("components" in e){for(var c=0;c<e.components.length;c++){var b=e.components[c];var a=Exhibit.UI.create(b,b.elmt,this._uiContext);if(a!=null){var d=elmt.id;if(d==null||d.length==0){d="component"+Math.floor(Math.random()*1000000)}this.setComponent(d,a)}}}};Exhibit._Impl.prototype.configureFromDOM=function(root){var collectionElmts=[];var coderElmts=[];var coordinatorElmts=[];var lensElmts=[];var facetElmts=[];var otherElmts=[];var f=function(elmt){var role=Exhibit.getRoleAttribute(elmt);if(role.length>0){switch(role){case"collection":collectionElmts.push(elmt);break;case"coder":coderElmts.push(elmt);break;case"coordinator":coordinatorElmts.push(elmt);break;case"lens":lensElmts.push(elmt);break;case"facet":facetElmts.push(elmt);break;default:otherElmts.push(elmt)}}else{var node=elmt.firstChild;while(node!=null){if(node.nodeType==1){f(node)}node=node.nextSibling}}};f(root||document.body);var uiContext=this._uiContext;for(var i=0;i<collectionElmts.length;i++){var elmt=collectionElmts[i];var id=elmt.id;if(id==null||id.length==0){id="default"}this.setCollection(id,Exhibit.Collection.createFromDOM2(id,elmt,uiContext))}var self=this;var processElmts=function(elmts){for(var i=0;i<elmts.length;i++){var elmt=elmts[i];try{var component=Exhibit.UI.createFromDOM(elmt,uiContext);if(component!=null){var id=elmt.id;if(id==null||id.length==0){id="component"+Math.floor(Math.random()*1000000)}self.setComponent(id,component)}}catch(e){SimileAjax.Debug.exception(e)}}};processElmts(coordinatorElmts);processElmts(coderElmts);processElmts(lensElmts);processElmts(facetElmts);processElmts(otherElmts);var exporters=Exhibit.getAttribute(document.body,"exporters");if(exporters!=null){exporters=exporters.split(";");for(var i=0;i<exporters.length;i++){var expr=exporters[i];var exporter=null;try{exporter=eval(expr)}catch(e){}if(exporter==null){try{exporter=eval(expr+"Exporter")}catch(e){}}if(exporter==null){try{exporter=eval("Exhibit."+expr+"Exporter")}catch(e){}}if(typeof exporter=="object"){Exhibit.addExporter(exporter)}}}var hash=document.location.hash;if(hash.length>1){var itemID=decodeURIComponent(hash.substr(1));if(this._database.containsItem(itemID)){this._showFocusDialogOnItem(itemID)}}};Exhibit._Impl.prototype._showFocusDialogOnItem=function(b){var c=SimileAjax.DOM.createDOMFromString("div","<div class='exhibit-focusDialog-viewContainer' id='lensContainer'></div><div class='exhibit-focusDialog-controls'><button id='closeButton'>"+Exhibit.l10n.focusDialogBoxCloseButtonLabel+"</button></div>");c.elmt.className="exhibit-focusDialog exhibit-ui-protection";c.close=function(){document.body.removeChild(c.elmt)};c.layer=SimileAjax.WindowManager.pushLayer(function(){c.close()},false);var a=this._uiContext.getLensRegistry().createLens(b,c.lensContainer,this._uiContext);c.elmt.style.top=(document.body.scrollTop+100)+"px";document.body.appendChild(c.elmt);SimileAjax.WindowManager.registerEvent(c.closeButton,"click",function(e,d,g){SimileAjax.WindowManager.popLayer(c.layer)},c.layer)};Exhibit.Persistence={};Exhibit.Persistence.getBaseURL=function(a){try{if(a.indexOf("://")<0){var c=Exhibit.Persistence.getBaseURL(document.location.href);if(a.substr(0,1)=="/"){a=c.substr(0,c.indexOf("/",c.indexOf("://")+3))+a}else{a=c+a}}var b=a.lastIndexOf("/");if(b<0){return""}else{return a.substr(0,b+1)}}catch(d){return a}};Exhibit.Persistence.resolveURL=function(a){if(a.indexOf("://")<0){var b=Exhibit.Persistence.getBaseURL(document.location.href);if(a.substr(0,1)=="/"){a=b.substr(0,b.indexOf("/",b.indexOf("://")+3))+a}else{a=b+a}}return a};Exhibit.Persistence.getURLWithoutQueryAndHash=function(){var b;if("_urlWithoutQueryAndHash" in Exhibit){b=Exhibit.Persistence._urlWithoutQueryAndHash}else{b=document.location.href;var c=b.indexOf("#");var a=b.indexOf("?");if(a>=0){b=b.substr(0,a)}else{if(c>=0){b=b.substr(0,c)}}Exhibit.Persistence._urlWithoutQueryAndHash=b}return b};Exhibit.Persistence.getURLWithoutQuery=function(){var b;if("_urlWithoutQuery" in Exhibit.Persistence){b=Exhibit.Persistence._urlWithoutQuery}else{b=document.location.href;var a=b.indexOf("?");if(a>=0){b=b.substr(0,a)}Exhibit.Persistence._urlWithoutQuery=b}return b};Exhibit.Persistence.getItemLink=function(a){return Exhibit.Persistence.getURLWithoutQueryAndHash()+"#"+encodeURIComponent(a)};Exhibit.ColorCoder=function(a){this._uiContext=a;this._settings={};this._map={};this._mixedCase={label:Exhibit.Coders.l10n.mixedCaseLabel,color:Exhibit.Coders.mixedCaseColor};this._missingCase={label:Exhibit.Coders.l10n.missingCaseLabel,color:Exhibit.Coders.missingCaseColor};this._othersCase={label:Exhibit.Coders.l10n.othersCaseLabel,color:Exhibit.Coders.othersCaseColor}};Exhibit.ColorCoder._settingSpecs={};Exhibit.ColorCoder.create=function(c,a){var b=new Exhibit.ColorCoder(Exhibit.UIContext.create(c,a));Exhibit.ColorCoder._configure(b,c);return b};Exhibit.ColorCoder.createFromDOM=function(g,a){g.style.display="none";var h=Exhibit.getConfigurationFromDOM(g);var b=new Exhibit.ColorCoder(Exhibit.UIContext.create(h,a));Exhibit.SettingsUtilities.collectSettingsFromDOM(g,Exhibit.ColorCoder._settingSpecs,b._settings);try{var c=g.firstChild;while(c!=null){if(c.nodeType==1){b._addEntry(Exhibit.getAttribute(c,"case"),c.firstChild.nodeValue.trim(),Exhibit.getAttribute(c,"color"))}c=c.nextSibling}}catch(d){SimileAjax.Debug.exception(d,"ColorCoder: Error processing configuration of coder")}Exhibit.ColorCoder._configure(b,h);return b};Exhibit.ColorCoder._configure=function(b,d){Exhibit.SettingsUtilities.collectSettings(d,Exhibit.ColorCoder._settingSpecs,b._settings);if("entries" in d){var a=d.entries;for(var c=0;c<a.length;c++){b._addEntry(a[c].kase,a[c].key,a[c].color)}}};Exhibit.ColorCoder.prototype.dispose=function(){this._uiContext=null;this._settings=null};Exhibit.ColorCoder._colorTable={red:"#ff0000",green:"#00ff00",blue:"#0000ff",white:"#ffffff",black:"#000000",gray:"#888888"};Exhibit.ColorCoder.prototype._addEntry=function(b,c,a){if(a in Exhibit.ColorCoder._colorTable){a=Exhibit.ColorCoder._colorTable[a]}var d=null;switch(b){case"others":d=this._othersCase;break;case"mixed":d=this._mixedCase;break;case"missing":d=this._missingCase;break}if(d!=null){d.label=c;d.color=a}else{this._map[c]={color:a}}};Exhibit.ColorCoder.prototype.translate=function(b,a){if(b in this._map){if(a){a.keys.add(b)}return this._map[b].color}else{if(b==null){if(a){a.missing=true}return this._missingCase.color}else{if(a){a.others=true}return this._othersCase.color}}};Exhibit.ColorCoder.prototype.translateSet=function(d,a){var c=null;var b=this;d.visit(function(g){var e=b.translate(g,a);if(c==null){c=e}else{if(c!=e){if(a){a.mixed=true}c=b._mixedCase.color;return true}}return false});if(c!=null){return c}else{if(a){a.missing=true}return this._missingCase.color}};Exhibit.ColorCoder.prototype.getOthersLabel=function(){return this._othersCase.label};Exhibit.ColorCoder.prototype.getOthersColor=function(){return this._othersCase.color};Exhibit.ColorCoder.prototype.getMissingLabel=function(){return this._missingCase.label};Exhibit.ColorCoder.prototype.getMissingColor=function(){return this._missingCase.color};Exhibit.ColorCoder.prototype.getMixedLabel=function(){return this._mixedCase.label};Exhibit.ColorCoder.prototype.getMixedColor=function(){return this._mixedCase.color};Exhibit.ColorGradientCoder=function(a){this._uiContext=a;this._settings={};this._gradientPoints=[];this._mixedCase={label:Exhibit.Coders.l10n.mixedCaseLabel,color:Exhibit.Coders.mixedCaseColor};this._missingCase={label:Exhibit.Coders.l10n.missingCaseLabel,color:Exhibit.Coders.missingCaseColor};this._othersCase={label:Exhibit.Coders.l10n.othersCaseLabel,color:Exhibit.Coders.othersCaseColor}};Exhibit.ColorGradientCoder._settingSpecs={};Exhibit.ColorGradientCoder.create=function(c,a){var b=new Exhibit.ColorGradientCoder(Exhibit.UIContext.create(c,a));Exhibit.ColorGradientCoder._configure(b,c);return b};Exhibit.ColorGradientCoder.createFromDOM=function(a,k){a.style.display="none";var c=Exhibit.getConfigurationFromDOM(a);var b=new Exhibit.ColorGradientCoder(Exhibit.UIContext.create(c,k));Exhibit.SettingsUtilities.collectSettingsFromDOM(a,Exhibit.ColorGradientCoder._settingSpecs,b._settings);try{var n=Exhibit.getAttribute(a,"gradientPoints",";");for(var l=0;l<n.length;l++){var r=n[l];var q=parseFloat(r);var p=r.indexOf("#")+1;var g=parseInt(r.slice(p,p+2),16);var h=parseInt(r.slice(p+2,p+4),16);var o=parseInt(r.slice(p+4),16);b._gradientPoints.push({value:q,red:g,green:h,blue:o})}var d=a.firstChild;while(d!=null){if(d.nodeType==1){b._addEntry(Exhibit.getAttribute(d,"case"),d.firstChild.nodeValue.trim(),Exhibit.getAttribute(d,"color"))}d=d.nextSibling}}catch(m){SimileAjax.Debug.exception(m,"ColorGradientCoder: Error processing configuration of coder")}Exhibit.ColorGradientCoder._configure(b,c);return b};Exhibit.ColorGradientCoder._configure=function(b,d){Exhibit.SettingsUtilities.collectSettings(d,Exhibit.ColorGradientCoder._settingSpecs,b._settings);if("entries" in d){var a=d.entries;for(var c=0;c<a.length;c++){b._addEntry(a[c].kase,a[c].key,a[c].color)}}};Exhibit.ColorGradientCoder.prototype.dispose=function(){this._uiContext=null;this._settings=null};Exhibit.ColorGradientCoder.prototype._addEntry=function(b,c,a){var d=null;switch(b){case"others":d=this._othersCase;break;case"mixed":d=this._mixedCase;break;case"missing":d=this._missingCase;break}if(d!=null){d.label=c;d.color=a}};Exhibit.ColorGradientCoder.prototype.translate=function(b,a){var e=this._gradientPoints;var d=function(h){if(h.constructor!=Number){h=parseFloat(h)}for(j=0;j<e.length;j++){if(h==e[j].value){return c(e[j].red,e[j].green,e[j].blue)}else{if(e[j+1]!=null){if(h<e[j+1].value){var i=(h-e[j].value)/(e[j+1].value-e[j].value);var g=Math.floor(e[j].red+i*(e[j+1].red-e[j].red));var k=Math.floor(e[j].green+i*(e[j+1].green-e[j].green));var l=Math.floor(e[j].blue+i*(e[j+1].blue-e[j].blue));return c(g,k,l)}}}}};var c=function(l,k,h){var i=function(g){if(g==0){return"00"}else{return g.toString(16)}};return"#"+i(l)+i(k)+i(h)};if(b>=e[0].value&b<=e[e.length-1].value){if(a){a.keys.add(b)}return d(b)}else{if(b==null){if(a){a.missing=true}return this._missingCase.color}else{if(a){a.others=true}return this._othersCase.color}}};Exhibit.ColorGradientCoder.prototype.translateSet=function(d,a){var c=null;var b=this;d.visit(function(g){var e=b.translate(g,a);if(c==null){c=e}else{if(c!=e){if(a){a.mixed=true}c=b._mixedCase.color;return true}}return false});if(c!=null){return c}else{if(a){a.missing=true}return this._missingCase.color}};Exhibit.ColorGradientCoder.prototype.getOthersLabel=function(){return this._othersCase.label};Exhibit.ColorGradientCoder.prototype.getOthersColor=function(){return this._othersCase.color};Exhibit.ColorGradientCoder.prototype.getMissingLabel=function(){return this._missingCase.label};Exhibit.ColorGradientCoder.prototype.getMissingColor=function(){return this._missingCase.color};Exhibit.ColorGradientCoder.prototype.getMixedLabel=function(){return this._mixedCase.label};Exhibit.ColorGradientCoder.prototype.getMixedColor=function(){return this._mixedCase.color};Exhibit.DefaultColorCoder=function(a){};Exhibit.DefaultColorCoder.colors=["#006400","#0000CD","#FF4500","#6B8E23","#6A5ACD","#D2691E","#32CD32","#008080","#FFA500","#66CDAA","#00008B","#F4A460","#3CB371","#00CED1","#8B4513","#00FA9A","#4169E1","#B8860B"];Exhibit.DefaultColorCoder._map={};Exhibit.DefaultColorCoder._nextColor=0;Exhibit.DefaultColorCoder.prototype.translate=function(c,a){if(c==null){if(a){a.missing=true}return Exhibit.Coders.missingCaseColor}else{if(a){a.keys.add(c)}if(c in Exhibit.DefaultColorCoder._map){return Exhibit.DefaultColorCoder._map[c]}else{var b=Exhibit.DefaultColorCoder.colors[Exhibit.DefaultColorCoder._nextColor];Exhibit.DefaultColorCoder._nextColor=(Exhibit.DefaultColorCoder._nextColor+1)%Exhibit.DefaultColorCoder.colors.length;Exhibit.DefaultColorCoder._map[c]=b;return b}}};Exhibit.DefaultColorCoder.prototype.translateSet=function(d,a){var c=null;var b=this;d.visit(function(g){var e=b.translate(g,a);if(c==null){c=e}else{if(c!=e){c=Exhibit.Coders.mixedCaseColor;a.mixed=true;return true}}return false});if(c!=null){return c}else{a.missing=true;return Exhibit.Coders.missingCaseColor}};Exhibit.DefaultColorCoder.prototype.getOthersLabel=function(){return Exhibit.Coders.l10n.othersCaseLabel};Exhibit.DefaultColorCoder.prototype.getOthersColor=function(){return Exhibit.Coders.othersCaseColor};Exhibit.DefaultColorCoder.prototype.getMissingLabel=function(){return Exhibit.Coders.l10n.missingCaseLabel};Exhibit.DefaultColorCoder.prototype.getMissingColor=function(){return Exhibit.Coders.missingCaseColor};Exhibit.DefaultColorCoder.prototype.getMixedLabel=function(){return Exhibit.Coders.l10n.mixedCaseLabel};Exhibit.DefaultColorCoder.prototype.getMixedColor=function(){return Exhibit.Coders.mixedCaseColor};Exhibit.IconCoder=function(a){this._uiContext=a;this._settings={};this._map={};this._mixedCase={label:"mixed",icon:null};this._missingCase={label:"missing",icon:null};this._othersCase={label:"others",icon:null}};Exhibit.IconCoder._settingSpecs={};Exhibit.IconCoder.create=function(c,a){var b=new Exhibit.IconCoder(Exhibit.UIContext.create(c,a));Exhibit.IconCoder._configure(b,c);return b};Exhibit.IconCoder.createFromDOM=function(g,a){g.style.display="none";var h=Exhibit.getConfigurationFromDOM(g);var b=new Exhibit.IconCoder(Exhibit.UIContext.create(h,a));Exhibit.SettingsUtilities.collectSettingsFromDOM(g,Exhibit.IconCoder._settingSpecs,b._settings);try{var c=g.firstChild;while(c!=null){if(c.nodeType==1){b._addEntry(Exhibit.getAttribute(c,"case"),c.firstChild.nodeValue.trim(),Exhibit.getAttribute(c,"icon"))}c=c.nextSibling}}catch(d){SimileAjax.Debug.exception(d,"IconCoder: Error processing configuration of coder")}Exhibit.IconCoder._configure(b,h);return b};Exhibit.IconCoder._configure=function(b,d){Exhibit.SettingsUtilities.collectSettings(d,Exhibit.IconCoder._settingSpecs,b._settings);if("entries" in d){var a=d.entries;for(var c=0;c<a.length;c++){b._addEntry(a[c].kase,a[c].key,a[c].icon)}}};Exhibit.IconCoder.prototype.dispose=function(){this._uiContext=null;this._settings=null};Exhibit.IconCoder._iconTable={};Exhibit.IconCoder.prototype._addEntry=function(a,b,c){if(c in Exhibit.IconCoder._iconTable){c=Exhibit.IconCoder._iconTable[c]}var d=null;switch(a){case"others":d=this._othersCase;break;case"mixed":d=this._mixedCase;break;case"missing":d=this._missingCase;break}if(d!=null){d.label=b;d.icon=c}else{this._map[b]={icon:c}}};Exhibit.IconCoder.prototype.translate=function(b,a){if(b in this._map){if(a){a.keys.add(b)}return this._map[b].icon}else{if(b==null){if(a){a.missing=true}return this._missingCase.icon}else{if(a){a.others=true}return this._othersCase.icon}}};Exhibit.IconCoder.prototype.translateSet=function(d,a){var c=null;var b=this;d.visit(function(g){var e=b.translate(g,a);if(c==null){c=e}else{if(c!=e){if(a){a.mixed=true}c=b._mixedCase.icon;return true}}return false});if(c!=null){return c}else{if(a){a.missing=true}return this._missingCase.icon}};Exhibit.IconCoder.prototype.getOthersLabel=function(){return this._othersCase.label};Exhibit.IconCoder.prototype.getOthersIcon=function(){return this._othersCase.icon};Exhibit.IconCoder.prototype.getMissingLabel=function(){return this._missingCase.label};Exhibit.IconCoder.prototype.getMissingIcon=function(){return this._missingCase.icon};Exhibit.IconCoder.prototype.getMixedLabel=function(){return this._mixedCase.label};Exhibit.IconCoder.prototype.getMixedIcon=function(){return this._mixedCase.icon};Exhibit.SizeCoder=function(a){this._uiContext=a;this._settings={};this._map={};this._mixedCase={label:"mixed",size:10};this._missingCase={label:"missing",size:10};this._othersCase={label:"others",size:10}};Exhibit.SizeCoder._settingSpecs={};Exhibit.SizeCoder.create=function(c,a){var b=new Exhibit.SizeCoder(Exhibit.UIContext.create(c,a));Exhibit.SizeCoder._configure(b,c);return b};Exhibit.SizeCoder.createFromDOM=function(g,a){g.style.display="none";var h=Exhibit.getConfigurationFromDOM(g);var b=new Exhibit.SizeCoder(Exhibit.UIContext.create(h,a));Exhibit.SettingsUtilities.collectSettingsFromDOM(g,Exhibit.SizeCoder._settingSpecs,b._settings);try{var c=g.firstChild;while(c!=null){if(c.nodeType==1){b._addEntry(Exhibit.getAttribute(c,"case"),c.firstChild.nodeValue.trim(),Exhibit.getAttribute(c,"size"))}c=c.nextSibling}}catch(d){SimileAjax.Debug.exception(d,"SizeCoder: Error processing configuration of coder")}Exhibit.SizeCoder._configure(b,h);return b};Exhibit.SizeCoder._configure=function(b,d){Exhibit.SettingsUtilities.collectSettings(d,Exhibit.SizeCoder._settingSpecs,b._settings);if("entries" in d){var a=d.entries;for(var c=0;c<a.length;c++){b._addEntry(a[c].kase,a[c].key,a[c].size)}}};Exhibit.SizeCoder.prototype.dispose=function(){this._uiContext=null;this._settings=null};Exhibit.SizeCoder.prototype._addEntry=function(a,c,b){var d=null;switch(a){case"others":d=this._othersCase;break;case"mixed":d=this._mixedCase;break;case"missing":d=this._missingCase;break}if(d!=null){d.label=c;d.size=b}else{this._map[c]={size:b}}};Exhibit.SizeCoder.prototype.translate=function(b,a){if(b in this._map){if(a){a.keys.add(b)}return this._map[b].size}else{if(b==null){if(a){a.missing=true}return this._missingCase.size}else{if(a){a.others=true}return this._othersCase.size}}};Exhibit.SizeCoder.prototype.translateSet=function(d,a){var c=null;var b=this;d.visit(function(e){var g=b.translate(e,a);if(c==null){c=g}else{if(c!=g){if(a){a.mixed=true}c=b._mixedCase.size;return true}}return false});if(c!=null){return c}else{if(a){a.missing=true}return this._missingCase.size}};Exhibit.SizeCoder.prototype.getOthersLabel=function(){return this._othersCase.label};Exhibit.SizeCoder.prototype.getOthersSize=function(){return this._othersCase.size};Exhibit.SizeCoder.prototype.getMissingLabel=function(){return this._missingCase.label};Exhibit.SizeCoder.prototype.getMissingSize=function(){return this._missingCase.size};Exhibit.SizeCoder.prototype.getMixedLabel=function(){return this._mixedCase.label};Exhibit.SizeCoder.prototype.getMixedSize=function(){return this._mixedCase.size};Exhibit.SizeGradientCoder=function(a){this._uiContext=a;this._settings={};this._log={func:function(b){return Math.ceil(Math.log(b))},invFunc:function(b){return Math.ceil(Math.exp(b))}};this._linear={func:function(b){return Math.ceil(b)},invFunc:function(b){return Math.ceil(b)}};this._quad={func:function(b){return Math.ceil(Math.pow((b/100),2))},invFunc:function(b){return Math.sqrt(b)*100}};this._exp={func:function(b){return Math.ceil(Math.exp(b))},invFunc:function(b){return Math.ceil(Math.log(b))}};this._markerScale=this._quad;this._valueScale=this._linear;this._gradientPoints=[];this._mixedCase={label:"mixed",size:20};this._missingCase={label:"missing",size:20};this._othersCase={label:"others",size:20}};Exhibit.SizeGradientCoder._settingSpecs={};Exhibit.SizeGradientCoder.create=function(c,a){var b=new Exhibit.SizeGradientCoder(Exhibit.UIContext.create(c,a));Exhibit.SizeGradientCoder._configure(b,c);return b};Exhibit.SizeGradientCoder.createFromDOM=function(a,h){a.style.display="none";var c=Exhibit.getConfigurationFromDOM(a);var b=new Exhibit.SizeGradientCoder(Exhibit.UIContext.create(c,h));Exhibit.SettingsUtilities.collectSettingsFromDOM(a,Exhibit.SizeGradientCoder._settingSpecs,b._settings);try{var g=b._settings.markerScale;if(g=="log"){b._markerScale=b._log}if(g=="linear"){b._markerScale=b._linear}if(g=="exp"){b._markerScale=b._exp}var m=Exhibit.getAttribute(a,"gradientPoints",";");for(var k=0;k<m.length;k++){var o=m[k].split(",");var n=parseFloat(o[0]);var p=b._markerScale.invFunc(parseFloat(o[1]));b._gradientPoints.push({value:n,size:p})}var d=a.firstChild;while(d!=null){if(d.nodeType==1){b._addEntry(Exhibit.getAttribute(d,"case"),d.firstChild.nodeValue.trim(),Exhibit.getAttribute(d,"size"))}d=d.nextSibling}}catch(l){SimileAjax.Debug.exception(l,"SizeGradientCoder: Error processing configuration of coder")}Exhibit.SizeGradientCoder._configure(b,c);return b};Exhibit.SizeGradientCoder._configure=function(b,d){Exhibit.SettingsUtilities.collectSettings(d,Exhibit.SizeGradientCoder._settingSpecs,b._settings);if("entries" in d){var a=d.entries;for(var c=0;c<a.length;c++){b._addEntry(a[c].kase,a[c].key,a[c].size)}}};Exhibit.SizeGradientCoder.prototype.dispose=function(){this._uiContext=null;this._settings=null};Exhibit.SizeGradientCoder.prototype._addEntry=function(a,c,b){var d=null;switch(a){case"others":d=this._othersCase;break;case"mixed":d=this._mixedCase;break;case"missing":d=this._missingCase;break}if(d!=null){d.label=c;d.size=b}};Exhibit.SizeGradientCoder.prototype.translate=function(c,a){var b=this;var e=this._gradientPoints;var d=function(h){if(h.constructor!=Number){h=parseFloat(h)}for(j=0;j<e.length;j++){if(h==e[j].value){return b._markerScale.func(e[j].size)}else{if(e[j+1]!=null){if(h<e[j+1].value){var i=(h-e[j].value)/(e[j+1].value-e[j].value);var g=Math.floor(e[j].size+i*(e[j+1].size-e[j].size));return b._markerScale.func(g)}}}}};if(c>=e[0].value&c<=e[e.length-1].value){if(a){a.keys.add(c)}return d(c)}else{if(c==null){if(a){a.missing=true}return this._missingCase.size}else{if(a){a.others=true}return this._othersCase.size}}};Exhibit.SizeGradientCoder.prototype.translateSet=function(d,a){var c=null;var b=this;d.visit(function(e){var g=b.translate(e,a);if(c==null){c=g}else{if(c!=g){if(a){a.mixed=true}c=b._mixedCase.size;return true}}return false});if(c!=null){return c}else{if(a){a.missing=true}return this._missingCase.size}};Exhibit.SizeGradientCoder.prototype.getOthersLabel=function(){return this._othersCase.label};Exhibit.SizeGradientCoder.prototype.getOthersSize=function(){return this._othersCase.size};Exhibit.SizeGradientCoder.prototype.getMissingLabel=function(){return this._missingCase.label};Exhibit.SizeGradientCoder.prototype.getMissingSize=function(){return this._missingCase.size};Exhibit.SizeGradientCoder.prototype.getMixedLabel=function(){return this._mixedCase.label};Exhibit.SizeGradientCoder.prototype.getMixedSize=function(){return this._mixedCase.size};Exhibit.Coordinator=function(a){this._uiContext=a;this._listeners=[]};Exhibit.Coordinator.create=function(c,a){var b=new Exhibit.Coordinator(a);return b};Exhibit.Coordinator.createFromDOM=function(c,a){var b=new Exhibit.Coordinator(Exhibit.UIContext.createFromDOM(c,a,false));return b};Exhibit.Coordinator.prototype.dispose=function(){this._uiContext.dispose();this._uiContext=null};Exhibit.Coordinator.prototype.addListener=function(b){var a=new Exhibit.Coordinator._Listener(this,b);this._listeners.push(a);return a};Exhibit.Coordinator.prototype._removeListener=function(b){for(var a=0;a<this._listeners.length;a++){if(this._listeners[a]==b){this._listeners.splice(a,1);return}}};Exhibit.Coordinator.prototype._fire=function(c,d){for(var b=0;b<this._listeners.length;b++){var a=this._listeners[b];if(a!=c){a._callback(d)}}};Exhibit.Coordinator._Listener=function(a,b){this._coordinator=a;this._callback=b};Exhibit.Coordinator._Listener.prototype.dispose=function(){this._coordinator._removeListener(this)};Exhibit.Coordinator._Listener.prototype.fire=function(a){this._coordinator._fire(this,a)};Exhibit.CloudFacet=function(c,b){this._div=c;this._uiContext=b;this._colorCoder=null;this._expression=null;this._valueSet=new Exhibit.Set();this._selectMissing=false;this._settings={};this._dom=null;var a=this;this._listener={onRootItemsChanged:function(){if("_itemToValue" in a){delete a._itemToValue}if("_valueToItem" in a){delete a._valueToItem}if("_missingItems" in a){delete a._missingItems}}};b.getCollection().addListener(this._listener)};Exhibit.CloudFacet._settingSpecs={facetLabel:{type:"text"},minimumCount:{type:"int",defaultValue:1},showMissing:{type:"boolean",defaultValue:true},missingLabel:{type:"text"}};Exhibit.CloudFacet.create=function(d,b,a){var a=Exhibit.UIContext.create(d,a);var c=new Exhibit.CloudFacet(b,a);Exhibit.CloudFacet._configure(c,d);c._initializeUI();a.getCollection().addFacet(c);return c};Exhibit.CloudFacet.createFromDOM=function(a,d,h){var c=Exhibit.getConfigurationFromDOM(a);var h=Exhibit.UIContext.createFromDOM(a,h);var b=new Exhibit.CloudFacet(d!=null?d:a,h);Exhibit.SettingsUtilities.collectSettingsFromDOM(a,Exhibit.CloudFacet._settingSpecs,b._settings);try{var g=Exhibit.getAttribute(a,"expression");if(g!=null&&g.length>0){b._expression=Exhibit.ExpressionParser.parse(g)}var n=Exhibit.getAttribute(a,"selection",";");if(n!=null&&n.length>0){for(var k=0,o;o=n[k];k++){b._valueSet.add(o)}}var l=Exhibit.getAttribute(a,"selectMissing");if(l!=null&&l.length>0){b._selectMissing=(l=="true")}}catch(m){SimileAjax.Debug.exception(m,"CloudFacet: Error processing configuration of cloud facet")}Exhibit.CloudFacet._configure(b,c);b._initializeUI();h.getCollection().addFacet(b);return b};Exhibit.CloudFacet._configure=function(d,c){Exhibit.SettingsUtilities.collectSettings(c,Exhibit.CloudFacet._settingSpecs,d._settings);if("expression" in c){d._expression=Exhibit.ExpressionParser.parse(c.expression)}if("selection" in c){var b=c.selection;for(var a=0;a<b.length;a++){d._valueSet.add(b[a])}}if("selectMissing" in c){d._selectMissing=c.selectMissing}};Exhibit.CloudFacet.prototype.dispose=function(){this._uiContext.getCollection().removeFacet(this);this._uiContext.getCollection().removeListener(this._listener);this._uiContext=null;this._div.innerHTML="";this._div=null;this._dom=null;this._expression=null;this._valueSet=null;this._settings=null;this._itemToValue=null;this._valueToItem=null;this._missingItems=null};Exhibit.CloudFacet.prototype.hasRestrictions=function(){return this._valueSet.size()>0||this._selectMissing};Exhibit.CloudFacet.prototype.clearAllRestrictions=function(){var a={selection:[],selectMissing:false};if(this.hasRestrictions()){this._valueSet.visit(function(b){a.selection.push(b)});this._valueSet=new Exhibit.Set();a.selectMissing=this._selectMissing;this._selectMissing=false;this._notifyCollection()}return a};Exhibit.CloudFacet.prototype.applyRestrictions=function(b){this._valueSet=new Exhibit.Set();for(var a=0;a<b.selection.length;a++){this._valueSet.add(b.selection[a])}this._selectMissing=b.selectMissing;this._notifyCollection()};Exhibit.CloudFacet.prototype.setSelection=function(b,a){if(a){this._valueSet.add(b)}else{this._valueSet.remove(b)}this._notifyCollection()};Exhibit.CloudFacet.prototype.setSelectMissing=function(a){if(a!=this._selectMissing){this._selectMissing=a;this._notifyCollection()}};Exhibit.CloudFacet.prototype.restrict=function(b){if(this._valueSet.size()==0&&!this._selectMissing){return b}var d;if(this._expression.isPath()){d=this._expression.getPath().walkBackward(this._valueSet,"item",b,this._uiContext.getDatabase()).getSet()}else{this._buildMaps();d=new Exhibit.Set();var c=this._valueToItem;this._valueSet.visit(function(h){if(h in c){var k=c[h];for(var e=0;e<k.length;e++){var g=k[e];if(b.contains(g)){d.add(g)}}}})}if(this._selectMissing){this._buildMaps();var a=this._missingItems;b.visit(function(e){if(e in a){d.add(e)}})}return d};Exhibit.CloudFacet.prototype.update=function(a){this._constructBody(this._computeFacet(a))};Exhibit.CloudFacet.prototype._computeFacet=function(l){var h=this._uiContext.getDatabase();var g=[];var t="text";var k=this;if(this._expression.isPath()){var m=this._expression.getPath();var w=m.walkForward(l,"item",h);t=w.valueType;if(w.size>0){w.forEachValue(function(x){var i=m.evaluateBackward(x,t,l,h);if(i.size>=k._settings.minimumCount||k._valueSet.contains(x)){g.push({value:x,count:i.size})}})}}else{this._buildMaps();t=this._valueType;for(var o in this._valueToItem){var n=this._valueToItem[o];var e=0;for(var r=0;r<n.length;r++){if(l.contains(n[r])){e++}}if(e>=this._settings.minimumCount||this._valueSet.contains(o)){g.push({value:o,count:e})}}}if(g.length>0){var v=this._valueSet;var b=t=="item"?function(x){var i=h.getObject(x,"label");return i!=null?i:x}:function(i){return i};for(var r=0;r<g.length;r++){var a=g[r];a.actionLabel=a.selectionLabel=b(a.value);a.selected=v.contains(a.value)}var d=function(x,i){return x.selectionLabel.localeCompare(i.selectionLabel)};if("_orderMap" in this){var s=this._orderMap;d=function(x,i){if(x.selectionLabel in s){if(i.selectionLabel in s){return s[x.selectionLabel]-s[i.selectionLabel]}else{return -1}}else{if(i.selectionLabel in s){return 1}else{return x.selectionLabel.localeCompare(i.selectionLabel)}}}}else{if(t=="number"){d=function(x,i){x=parseFloat(x.value);i=parseFloat(i.value);return x<i?-1:x>i?1:0}}}var p=d;if(this._settings.sortMode=="count"){p=function(x,i){var y=i.count-x.count;return y!=0?y:d(x,i)}}var c=p;if(this._settings.sortDirection=="reverse"){c=function(x,i){return p(i,x)}}g.sort(c)}if(this._settings.showMissing||this._selectMissing){this._buildMaps();var e=0;for(var u in this._missingItems){if(l.contains(u)){e++}}if(e>0||this._selectMissing){var q=document.createElement("span");q.innerHTML=("missingLabel" in this._settings)?this._settings.missingLabel:Exhibit.FacetUtilities.l10n.missingThisField;q.className="exhibit-facet-value-missingThisField";g.unshift({value:null,count:e,selected:this._selectMissing,selectionLabel:q,actionLabel:Exhibit.FacetUtilities.l10n.missingThisField})}}return g};Exhibit.CloudFacet.prototype._notifyCollection=function(){this._uiContext.getCollection().onFacetUpdated(this)};Exhibit.CloudFacet.prototype._initializeUI=function(){this._div.innerHTML="";this._div.className="exhibit-cloudFacet";var a=SimileAjax.DOM.createDOMFromString(this._div,(("facetLabel" in this._settings)?("<div class='exhibit-cloudFacet-header'><span class='exhibit-cloudFacet-header-title'>"+this._settings.facetLabel+"</span></div>"):"")+"<div class='exhibit-cloudFacet-body' id='valuesContainer'></div>");this._dom=a};Exhibit.CloudFacet.prototype._constructBody=function(e){var k=this;var a=this._dom.valuesContainer;a.style.display="none";a.innerHTML="";if(e.length>0){var b=Number.POSITIVE_INFINITY;var h=Number.NEGATIVE_INFINITY;for(var c=0;c<e.length;c++){var i=e[c];b=Math.min(b,i.count);h=Math.max(h,i.count)}var d=h-b;var g=function(n){var l=function(p,o,q){k._filter(n.value,n.actionLabel,!(o.ctrlKey||o.metaKey));SimileAjax.DOM.cancelEvent(o);return false};var m=document.createElement("span");m.appendChild(document.createTextNode("\u00A0"));if(typeof n.selectionLabel=="string"){m.appendChild(document.createTextNode(n.selectionLabel))}else{m.appendChild(n.selectionLabel)}m.appendChild(document.createTextNode("\u00A0"));m.className=n.selected?"exhibit-cloudFacet-value exhibit-cloudFacet-value-selected":"exhibit-cloudFacet-value";if(n.count>b){m.style.fontSize=Math.ceil(100+100*Math.log(1+1.5*(n.count-b)/d))+"%"}SimileAjax.WindowManager.registerEvent(m,"click",l,SimileAjax.WindowManager.getBaseLayer());a.appendChild(m);a.appendChild(document.createTextNode(" "))};for(var c=0;c<e.length;c++){g(e[c])}}a.style.display="block"};Exhibit.CloudFacet.prototype._filter=function(o,l,b){var q=this;var c,m,i;var p=new Exhibit.Set(this._valueSet);var n=this._selectMissing;var s;var k;var a;var h;var d;if(o==null){h=n;d=h&&(p.size()==0);if(b){if(p.size()==0){k=!n}else{k=true}s=new Exhibit.Set()}else{k=!n;s=new Exhibit.Set(p)}}else{h=p.contains(o);d=h&&(p.size()==1)&&!n;if(b){k=false;s=new Exhibit.Set();if(!p.contains(o)){s.add(o)}else{if(p.size()>1||n){s.add(o)}}}else{k=n;s=new Exhibit.Set(p);if(s.contains(o)){s.remove(o)}else{s.add(o)}}}var e={selection:s.toArray(),selectMissing:k};var g={selection:p.toArray(),selectMissing:n};var r=("facetLabel" in this._settings)?this._settings.facetLabel:"";SimileAjax.History.addLengthyAction(function(){q.applyRestrictions(e)},function(){q.applyRestrictions(g)},(b&&!d)?String.substitute(Exhibit.FacetUtilities.l10n.facetSelectOnlyActionTitle,[l,r]):String.substitute(Exhibit.FacetUtilities.l10n[h?"facetUnselectActionTitle":"facetSelectActionTitle"],[l,r]))};Exhibit.CloudFacet.prototype._clearSelections=function(){var b={};var a=this;SimileAjax.History.addLengthyAction(function(){b.restrictions=a.clearAllRestrictions()},function(){a.applyRestrictions(b.restrictions)},String.substitute(Exhibit.FacetUtilities.l10n.facetClearSelectionsActionTitle,[this._settings.facetLabel]))};Exhibit.CloudFacet.prototype._buildMaps=function(){if(!("_itemToValue" in this)){var b={};var c={};var a={};var h="text";var e=function(i,l,k){if(i in k){k[i].push(l)}else{k[i]=[l]}};var g=this._expression;var d=this._uiContext.getDatabase();this._uiContext.getCollection().getAllItems().visit(function(k){var i=g.evaluateOnItem(k,d);if(i.values.size()>0){h=i.valueType;i.values.visit(function(l){e(k,l,b);e(l,k,c)})}else{a[k]=true}});this._itemToValue=b;this._valueToItem=c;this._missingItems=a;this._valueType=h}};Exhibit.ListFacet=function(c,b){this._div=c;this._uiContext=b;this._colorCoder=null;this._expression=null;this._valueSet=new Exhibit.Set();this._selectMissing=false;this._settings={};this._dom=null;var a=this;this._listener={onRootItemsChanged:function(){if("_itemToValue" in a){delete a._itemToValue}if("_valueToItem" in a){delete a._valueToItem}if("_missingItems" in a){delete a._missingItems}}};b.getCollection().addListener(this._listener)};Exhibit.ListFacet._settingSpecs={facetLabel:{type:"text"},fixedOrder:{type:"text"},sortMode:{type:"text",defaultValue:"value"},sortDirection:{type:"text",defaultValue:"forward"},showMissing:{type:"boolean",defaultValue:true},missingLabel:{type:"text"},scroll:{type:"boolean",defaultValue:true},height:{type:"text"},colorCoder:{type:"text",defaultValue:null}};Exhibit.ListFacet.create=function(d,b,a){var a=Exhibit.UIContext.create(d,a);var c=new Exhibit.ListFacet(b,a);Exhibit.ListFacet._configure(c,d);c._initializeUI();a.getCollection().addFacet(c);return c};Exhibit.ListFacet.createFromDOM=function(a,d,h){var c=Exhibit.getConfigurationFromDOM(a);var h=Exhibit.UIContext.createFromDOM(a,h);var b=new Exhibit.ListFacet(d!=null?d:a,h);Exhibit.SettingsUtilities.collectSettingsFromDOM(a,Exhibit.ListFacet._settingSpecs,b._settings);try{var g=Exhibit.getAttribute(a,"expression");if(g!=null&&g.length>0){b._expression=Exhibit.ExpressionParser.parse(g)}var n=Exhibit.getAttribute(a,"selection",";");if(n!=null&&n.length>0){for(var k=0,o;o=n[k];k++){b._valueSet.add(o)}}var l=Exhibit.getAttribute(a,"selectMissing");if(l!=null&&l.length>0){b._selectMissing=(l=="true")}}catch(m){SimileAjax.Debug.exception(m,"ListFacet: Error processing configuration of list facet")}Exhibit.ListFacet._configure(b,c);b._initializeUI();h.getCollection().addFacet(b);return b};Exhibit.ListFacet._configure=function(k,h){Exhibit.SettingsUtilities.collectSettings(h,Exhibit.ListFacet._settingSpecs,k._settings);if("expression" in h){k._expression=Exhibit.ExpressionParser.parse(h.expression)}if("selection" in h){var c=h.selection;for(var b=0;b<c.length;b++){k._valueSet.add(c[b])}}if("selectMissing" in h){k._selectMissing=h.selectMissing}if(!("facetLabel" in k._settings)){k._settings.facetLabel="missing ex:facetLabel";if(k._expression!=null&&k._expression.isPath()){var d=k._expression.getPath().getLastSegment();var e=k._uiContext.getDatabase().getProperty(d.property);if(e!=null){k._settings.facetLabel=d.forward?e.getLabel():e.getReverseLabel()}}}if("fixedOrder" in k._settings){var a=k._settings.fixedOrder.split(";");var g={};for(var b=0;b<a.length;b++){g[a[b].trim()]=b}k._orderMap=g}if("colorCoder" in k._settings){k._colorCoder=k._uiContext.getExhibit().getComponent(k._settings.colorCoder)}};Exhibit.ListFacet.prototype.dispose=function(){this._uiContext.getCollection().removeFacet(this);this._uiContext.getCollection().removeListener(this._listener);this._uiContext=null;this._colorCoder=null;this._div.innerHTML="";this._div=null;this._dom=null;this._expression=null;this._valueSet=null;this._settings=null;this._itemToValue=null;this._valueToItem=null;this._missingItems=null};Exhibit.ListFacet.prototype.hasRestrictions=function(){return this._valueSet.size()>0||this._selectMissing};Exhibit.ListFacet.prototype.clearAllRestrictions=function(){var a={selection:[],selectMissing:false};if(this.hasRestrictions()){this._valueSet.visit(function(b){a.selection.push(b)});this._valueSet=new Exhibit.Set();a.selectMissing=this._selectMissing;this._selectMissing=false;this._notifyCollection()}return a};Exhibit.ListFacet.prototype.applyRestrictions=function(b){this._valueSet=new Exhibit.Set();for(var a=0;a<b.selection.length;a++){this._valueSet.add(b.selection[a])}this._selectMissing=b.selectMissing;this._notifyCollection()};Exhibit.ListFacet.prototype.setSelection=function(b,a){if(a){this._valueSet.add(b)}else{this._valueSet.remove(b)}this._notifyCollection()};Exhibit.ListFacet.prototype.setSelectMissing=function(a){if(a!=this._selectMissing){this._selectMissing=a;this._notifyCollection()}};Exhibit.ListFacet.prototype.restrict=function(b){if(this._valueSet.size()==0&&!this._selectMissing){return b}var d;if(this._expression.isPath()){d=this._expression.getPath().walkBackward(this._valueSet,"item",b,this._uiContext.getDatabase()).getSet()}else{this._buildMaps();d=new Exhibit.Set();var c=this._valueToItem;this._valueSet.visit(function(h){if(h in c){var k=c[h];for(var e=0;e<k.length;e++){var g=k[e];if(b.contains(g)){d.add(g)}}}})}if(this._selectMissing){this._buildMaps();var a=this._missingItems;b.visit(function(e){if(e in a){d.add(e)}})}return d};Exhibit.ListFacet.prototype.update=function(a){this._dom.valuesContainer.style.display="none";this._dom.valuesContainer.innerHTML="";this._constructBody(this._computeFacet(a));this._dom.valuesContainer.style.display="block"};Exhibit.ListFacet.prototype._computeFacet=function(k){var h=this._uiContext.getDatabase();var g=[];var s="text";if(this._expression.isPath()){var l=this._expression.getPath();var v=l.walkForward(k,"item",h);s=v.valueType;if(v.size>0){v.forEachValue(function(w){var i=l.evaluateBackward(w,s,k,h);g.push({value:w,count:i.size})})}}else{this._buildMaps();s=this._valueType;for(var n in this._valueToItem){var m=this._valueToItem[n];var e=0;for(var q=0;q<m.length;q++){if(k.contains(m[q])){e++}}if(e>0){g.push({value:n,count:e})}}}if(g.length>0){var u=this._valueSet;var b=s=="item"?function(w){var i=h.getObject(w,"label");return i!=null?i:w}:function(i){return i};for(var q=0;q<g.length;q++){var a=g[q];a.actionLabel=a.selectionLabel=b(a.value);a.selected=u.contains(a.value)}var d=function(w,i){return w.selectionLabel.localeCompare(i.selectionLabel)};if("_orderMap" in this){var r=this._orderMap;d=function(w,i){if(w.selectionLabel in r){if(i.selectionLabel in r){return r[w.selectionLabel]-r[i.selectionLabel]}else{return -1}}else{if(i.selectionLabel in r){return 1}else{return w.selectionLabel.localeCompare(i.selectionLabel)}}}}else{if(s=="number"){d=function(w,i){w=parseFloat(w.value);i=parseFloat(i.value);return w<i?-1:w>i?1:0}}}var o=d;if(this._settings.sortMode=="count"){o=function(w,i){var x=i.count-w.count;return x!=0?x:d(w,i)}}var c=o;if(this._settings.sortDirection=="reverse"){c=function(w,i){return o(i,w)}}g.sort(c)}if(this._settings.showMissing||this._selectMissing){this._buildMaps();var e=0;for(var t in this._missingItems){if(k.contains(t)){e++}}if(e>0||this._selectMissing){var p=document.createElement("span");p.innerHTML=("missingLabel" in this._settings)?this._settings.missingLabel:Exhibit.FacetUtilities.l10n.missingThisField;p.className="exhibit-facet-value-missingThisField";g.unshift({value:null,count:e,selected:this._selectMissing,selectionLabel:p,actionLabel:Exhibit.FacetUtilities.l10n.missingThisField})}}return g};Exhibit.ListFacet.prototype._notifyCollection=function(){this._uiContext.getCollection().onFacetUpdated(this)};Exhibit.ListFacet.prototype._initializeUI=function(){var a=this;this._dom=Exhibit.FacetUtilities[this._settings.scroll?"constructFacetFrame":"constructFlowingFacetFrame"](this._div,this._settings.facetLabel,function(c,b,d){a._clearSelections()},this._uiContext);if("height" in this._settings&&this._settings.scroll){this._dom.valuesContainer.style.height=this._settings.height}};Exhibit.ListFacet.prototype._constructBody=function(a){var b=this;var h=this._dom.valuesContainer;h.style.display="none";var g=Exhibit.FacetUtilities[this._settings.scroll?"constructFacetItem":"constructFlowingFacetItem"];var d=this._valueSet.size()>0||this._selectMissing;var e=function(m){var i=function(o,n,p){b._filter(m.value,m.actionLabel,false);SimileAjax.DOM.cancelEvent(n);return false};var l=function(o,n,p){b._filter(m.value,m.actionLabel,!(n.ctrlKey||n.metaKey));SimileAjax.DOM.cancelEvent(n);return false};var k=g(m.selectionLabel,m.count,(b._colorCoder!=null)?b._colorCoder.translate(m.value):null,m.selected,d,i,l,b._uiContext);h.appendChild(k)};for(var c=0;c<a.length;c++){e(a[c])}h.style.display="block";this._dom.setSelectionCount(this._valueSet.size()+(this._selectMissing?1:0))};Exhibit.ListFacet.prototype._filter=function(o,l,b){var q=this;var c,m,i;var p=new Exhibit.Set(this._valueSet);var n=this._selectMissing;var r;var k;var a;var h;var d;if(o==null){h=n;d=h&&(p.size()==0);if(b){if(p.size()==0){k=!n}else{k=true}r=new Exhibit.Set()}else{k=!n;r=new Exhibit.Set(p)}}else{h=p.contains(o);d=h&&(p.size()==1)&&!n;if(b){k=false;r=new Exhibit.Set();if(!p.contains(o)){r.add(o)}else{if(p.size()>1||n){r.add(o)}}}else{k=n;r=new Exhibit.Set(p);if(r.contains(o)){r.remove(o)}else{r.add(o)}}}var e={selection:r.toArray(),selectMissing:k};var g={selection:p.toArray(),selectMissing:n};SimileAjax.History.addLengthyAction(function(){q.applyRestrictions(e)},function(){q.applyRestrictions(g)},(b&&!d)?String.substitute(Exhibit.FacetUtilities.l10n.facetSelectOnlyActionTitle,[l,this._settings.facetLabel]):String.substitute(Exhibit.FacetUtilities.l10n[h?"facetUnselectActionTitle":"facetSelectActionTitle"],[l,this._settings.facetLabel]))};Exhibit.ListFacet.prototype._clearSelections=function(){var b={};var a=this;SimileAjax.History.addLengthyAction(function(){b.restrictions=a.clearAllRestrictions()},function(){a.applyRestrictions(b.restrictions)},String.substitute(Exhibit.FacetUtilities.l10n.facetClearSelectionsActionTitle,[this._settings.facetLabel]))};Exhibit.ListFacet.prototype._buildMaps=function(){if(!("_itemToValue" in this)){var b={};var c={};var a={};var h="text";var e=function(i,l,k){if(i in k){k[i].push(l)}else{k[i]=[l]}};var g=this._expression;var d=this._uiContext.getDatabase();this._uiContext.getCollection().getAllItems().visit(function(k){var i=g.evaluateOnItem(k,d);if(i.values.size()>0){h=i.valueType;i.values.visit(function(l){e(k,l,b);e(l,k,c)})}else{a[k]=true}});this._itemToValue=b;this._valueToItem=c;this._missingItems=a;this._valueType=h}};Exhibit.NumericRangeFacet=function(c,b){this._div=c;this._uiContext=b;this._expression=null;this._settings={};this._dom=null;this._ranges=[];var a=this;this._listener={onRootItemsChanged:function(){if("_rangeIndex" in a){delete a._rangeIndex}}};b.getCollection().addListener(this._listener)};Exhibit.NumericRangeFacet._settingSpecs={facetLabel:{type:"text"},scroll:{type:"boolean",defaultValue:true},height:{type:"text"},interval:{type:"float",defaultValue:10}};Exhibit.NumericRangeFacet.create=function(d,b,a){var a=Exhibit.UIContext.create(d,a);var c=new Exhibit.NumericRangeFacet(b,a);Exhibit.NumericRangeFacet._configure(c,d);c._initializeUI();a.getCollection().addFacet(c);return c};Exhibit.NumericRangeFacet.createFromDOM=function(g,d,a){var i=Exhibit.getConfigurationFromDOM(g);var a=Exhibit.UIContext.createFromDOM(g,a);var h=new Exhibit.NumericRangeFacet(d!=null?d:g,a);Exhibit.SettingsUtilities.collectSettingsFromDOM(g,Exhibit.NumericRangeFacet._settingSpecs,h._settings);try{var b=Exhibit.getAttribute(g,"expression");if(b!=null&&b.length>0){h._expression=Exhibit.ExpressionParser.parse(b)}}catch(c){SimileAjax.Debug.exception(c,"NumericRangeFacet: Error processing configuration of numeric range facet")}Exhibit.NumericRangeFacet._configure(h,i);h._initializeUI();a.getCollection().addFacet(h);return h};Exhibit.NumericRangeFacet._configure=function(d,c){Exhibit.SettingsUtilities.collectSettings(c,Exhibit.NumericRangeFacet._settingSpecs,d._settings);if("expression" in c){d._expression=Exhibit.ExpressionParser.parse(c.expression)}if(!("facetLabel" in d._settings)){d._settings.facetLabel="missing ex:facetLabel";if(d._expression!=null&&d._expression.isPath()){var a=d._expression.getPath().getLastSegment();var b=d._uiContext.getDatabase().getProperty(a.property);if(b!=null){d._settings.facetLabel=a.forward?b.getLabel():b.getReverseLabel()}}}};Exhibit.NumericRangeFacet.prototype.dispose=function(){this._uiContext.getCollection().removeFacet(this);this._uiContext.getCollection().removeListener(this._listener);this._uiContext=null;this._div.innerHTML="";this._div=null;this._dom=null;this._expression=null;this._settings=null;this._ranges=null};Exhibit.NumericRangeFacet.prototype.hasRestrictions=function(){return this._ranges.length>0};Exhibit.NumericRangeFacet.prototype.clearAllRestrictions=function(){var a=[];if(this._ranges.length>0){a=a.concat(this._ranges);this._ranges=[];this._notifyCollection()}return a};Exhibit.NumericRangeFacet.prototype.applyRestrictions=function(a){this._ranges=a;this._notifyCollection()};Exhibit.NumericRangeFacet.prototype.setRange=function(e,d,c){if(c){for(var b=0;b<this._ranges.length;b++){var a=this._ranges[b];if(a.from==e&&a.to==d){return}}this._ranges.push({from:e,to:d})}else{for(var b=0;b<this._ranges.length;b++){var a=this._ranges[b];if(a.from==e&&a.to==d){this._ranges.splice(b,1);break}}}this._notifyCollection()};Exhibit.NumericRangeFacet.prototype.restrict=function(b){if(this._ranges.length==0){return b}else{if(this._expression.isPath()){var e=this._expression.getPath();var d=this._uiContext.getDatabase();var g=new Exhibit.Set();for(var c=0;c<this._ranges.length;c++){var a=this._ranges[c];g.addSet(e.rangeBackward(a.from,a.to,b,d).values)}return g}else{this._buildRangeIndex();var g=new Exhibit.Set();for(var c=0;c<this._ranges.length;c++){var a=this._ranges[c];this._rangeIndex.getSubjectsInRange(a.from,a.to,false,g,b)}return g}}};Exhibit.NumericRangeFacet.prototype.update=function(a){this._dom.valuesContainer.style.display="none";this._dom.valuesContainer.innerHTML="";this._reconstruct(a);this._dom.valuesContainer.style.display="block"};Exhibit.NumericRangeFacet.prototype._reconstruct=function(n){var m=this;var a=[];var u;var c;if(this._expression.isPath()){var k=this._uiContext.getDatabase();var o=this._expression.getPath();var q=o.getLastSegment().property;var b=k.getProperty(q);if(b==null){return null}u=b.getRangeIndex();countItems=function(i){return o.rangeBackward(i.from,i.to,n,k).values.size()}}else{this._buildRangeIndex();u=this._rangeIndex;countItems=function(i){return u.getSubjectsInRange(i.from,i.to,false,null,n).size()}}var r=u.getMin();var s=u.getMax();r=Math.floor(r/this._settings.interval)*this._settings.interval;s=Math.ceil(s/this._settings.interval)*this._settings.interval;for(var d=r;d<s;d+=this._settings.interval){var l={from:d,to:d+this._settings.interval,selected:false};l.count=countItems(l);for(var t=0;t<this._ranges.length;t++){var h=this._ranges[t];if(h.from==l.from&&h.to==l.to){l.selected=true;g=true;break}}a.push(l)}var g=this._ranges.length>0;var e=this._dom.valuesContainer;e.style.display="none";var v=Exhibit.FacetUtilities[this._settings.scroll?"constructFacetItem":"constructFlowingFacetItem"];var p=function(B,A,z,y){var i=function(D,C,E){m._toggleRange(B,A,y,false);SimileAjax.DOM.cancelEvent(C);return false};var x=function(D,C,E){m._toggleRange(B,A,y,!(C.ctrlKey||C.metaKey));SimileAjax.DOM.cancelEvent(C);return false};var w=v(B+" - "+A,z,null,y,g,i,x,m._uiContext);e.appendChild(w)};for(var t=0;t<a.length;t++){var l=a[t];if(l.selected||l.count>0){p(l.from,l.to,l.count,l.selected)}}e.style.display="block";this._dom.setSelectionCount(this._ranges.length)};Exhibit.NumericRangeFacet.prototype._notifyCollection=function(){this._uiContext.getCollection().onFacetUpdated(this)};Exhibit.NumericRangeFacet.prototype._initializeUI=function(){var a=this;this._dom=Exhibit.FacetUtilities[this._settings.scroll?"constructFacetFrame":"constructFlowingFacetFrame"](this._div,this._settings.facetLabel,function(c,b,d){a._clearSelections()},this._uiContext);if("height" in this._settings){this._dom.valuesContainer.style.height=this._settings.height}};Exhibit.NumericRangeFacet.prototype._toggleRange=function(h,i,d,e){var k=this;var g=h+" to "+i;var a=(this._ranges.length==1&&d);if(e&&!a){var b=[{from:h,to:i}];var c=[].concat(this._ranges);SimileAjax.History.addLengthyAction(function(){k.applyRestrictions(b)},function(){k.applyRestrictions(c)},String.substitute(Exhibit.FacetUtilities.l10n.facetSelectOnlyActionTitle,[g,this._settings.facetLabel]))}else{SimileAjax.History.addLengthyAction(function(){k.setRange(h,i,!d)},function(){k.setRange(h,i,d)},String.substitute(Exhibit.FacetUtilities.l10n[d?"facetUnselectActionTitle":"facetSelectActionTitle"],[g,this._settings.facetLabel]))}};Exhibit.NumericRangeFacet.prototype._clearSelections=function(){var b={};var a=this;SimileAjax.History.addLengthyAction(function(){b.restrictions=a.clearAllRestrictions()},function(){a.applyRestrictions(b.restrictions)},String.substitute(Exhibit.FacetUtilities.l10n.facetClearSelectionsActionTitle,[this._settings.facetLabel]))};Exhibit.NumericRangeFacet.prototype._buildRangeIndex=function(){if(!("_rangeIndex" in this)){var c=this._expression;var b=this._uiContext.getDatabase();var a=function(d,e){c.evaluateOnItem(d,b).values.visit(function(g){if(typeof g!="number"){g=parseFloat(g)}if(!isNaN(g)){e(g)}})};this._rangeIndex=new Exhibit.Database._RangeIndex(this._uiContext.getCollection().getAllItems(),a)}};Exhibit.TextSearchFacet=function(c,b){this._div=c;this._uiContext=b;this._expressions=[];this._text=null;this._settings={};this._dom=null;this._timerID=null;var a=this;this._listener={onRootItemsChanged:function(){if("_itemToValue" in a){delete a._itemToValue}}};b.getCollection().addListener(this._listener)};Exhibit.TextSearchFacet._settingSpecs={facetLabel:{type:"text"},queryParamName:{type:"text"}};Exhibit.TextSearchFacet.create=function(d,b,a){var a=Exhibit.UIContext.create(d,a);var c=new Exhibit.TextSearchFacet(b,a);Exhibit.TextSearchFacet._configure(c,d);c._initializeUI();a.getCollection().addFacet(c);return c};Exhibit.TextSearchFacet.createFromDOM=function(h,g,a){var k=Exhibit.getConfigurationFromDOM(h);var a=Exhibit.UIContext.createFromDOM(h,a);var i=new Exhibit.TextSearchFacet(g!=null?g:h,a);Exhibit.SettingsUtilities.collectSettingsFromDOM(h,Exhibit.TextSearchFacet._settingSpecs,i._settings);try{var b=Exhibit.getAttribute(h,"expressions");if(b!=null&&b.length>0){i._expressions=Exhibit.ExpressionParser.parseSeveral(b)}var c=Exhibit.getAttribute(h,"query");if(c!=null&&c.length>0){i._text=c}}catch(d){SimileAjax.Debug.exception(d,"TextSearchFacet: Error processing configuration of list facet")}Exhibit.TextSearchFacet._configure(i,k);i._initializeUI();a.getCollection().addFacet(i);return i};Exhibit.TextSearchFacet._configure=function(e,d){Exhibit.SettingsUtilities.collectSettings(d,Exhibit.TextSearchFacet._settingSpecs,e._settings);if("expressions" in d){for(var a=0;a<d.expressions.length;a++){e._expressions.push(Exhibit.ExpressionParser.parse(d.expressions[a]))}}if("selection" in d){var b=d.selection;for(var a=0;a<b.length;a++){e._valueSet.add(b[a])}}if("query" in d){e._text=d.query}if("queryParamName" in e._settings){var c=SimileAjax.parseURLParameters();if(e._settings.queryParamName in c){e._text=c[e._settings.queryParamName]}}if(!("facetLabel" in e._settings)){e._settings.facetLabel=""}};Exhibit.TextSearchFacet.prototype.dispose=function(){this._uiContext.getCollection().removeFacet(this);this._uiContext.getCollection().removeListener(this._listener);this._uiContext=null;this._div.innerHTML="";this._div=null;this._dom=null;this._expressions=null;this._itemToValue=null;this._settings=null};Exhibit.TextSearchFacet.prototype.hasRestrictions=function(){return this._text!=null};Exhibit.TextSearchFacet.prototype.clearAllRestrictions=function(){var a=this._text;if(this._text!=null){this._text=null;this._notifyCollection()}this._dom.input.value="";return a};Exhibit.TextSearchFacet.prototype.applyRestrictions=function(a){this.setText(a)};Exhibit.TextSearchFacet.prototype.setText=function(a){if(a!=null){a=a.trim();this._dom.input.value=a;a=a.length>0?a:null}else{this._dom.input.value=""}if(a!=this._text){this._text=a;this._notifyCollection()}};Exhibit.TextSearchFacet.prototype.restrict=function(a){if(this._text==null){return a}else{this._buildMaps();var d=new Exhibit.Set();var b=this._itemToValue;var c=this._text.toLowerCase();a.visit(function(h){if(h in b){var g=b[h];for(var e=0;e<g.length;e++){if(g[e].indexOf(c)>=0){d.add(h);break}}}});return d}};Exhibit.TextSearchFacet.prototype.update=function(a){};Exhibit.TextSearchFacet.prototype._notifyCollection=function(){this._uiContext.getCollection().onFacetUpdated(this)};Exhibit.TextSearchFacet.prototype._initializeUI=function(){var a=this;this._dom=Exhibit.TextSearchFacet.constructFacetFrame(this._div,this._settings.facetLabel);if(this._text!=null){this._dom.input.value=this._text}SimileAjax.WindowManager.registerEvent(this._dom.input,"keyup",function(c,b,d){a._onTextInputKeyUp()})};Exhibit.TextSearchFacet.constructFacetFrame=function(b,a){if(a!==""&&a!==null){return SimileAjax.DOM.createDOMFromString(b,"<div class='exhibit-facet-header'><span class='exhibit-facet-header-title'>"+a+"</span></div><div class='exhibit-text-facet'><input type='text' id='input'></div>")}else{return SimileAjax.DOM.createDOMFromString(b,"<div class='exhibit-text-facet'><input type='text' id='input'></div>")}};Exhibit.TextSearchFacet.prototype._onTextInputKeyUp=function(){if(this._timerID!=null){window.clearTimeout(this._timerID)}var a=this;this._timerID=window.setTimeout(function(){a._onTimeout()},500)};Exhibit.TextSearchFacet.prototype._onTimeout=function(){this._timerID=null;var c=this._dom.input.value.trim();if(c.length==0){c=null}if(c!=this._text){var b=this;var a=this._text;SimileAjax.History.addLengthyAction(function(){b.setText(c)},function(){b.setText(a)},c!=null?String.substitute(Exhibit.FacetUtilities.l10n.facetTextSearchActionTitle,[c]):Exhibit.FacetUtilities.l10n.facetClearTextSearchActionTitle)}};Exhibit.TextSearchFacet.prototype._buildMaps=function(){if(!("_itemToValue" in this)){var a={};var b=this._uiContext.getCollection().getAllItems();var d=this._uiContext.getDatabase();if(this._expressions.length>0){var c=this._expressions;b.visit(function(i){var h=[];for(var g=0;g<c.length;g++){var k=c[g];k.evaluateOnItem(i,d).values.visit(function(l){h.push(l.toLowerCase())})}a[i]=h})}else{var e=d.getAllProperties();b.visit(function(h){var g=[];for(var i=0;i<e.length;i++){d.getObjects(h,e[i]).visit(function(k){g.push(k.toLowerCase())})}a[h]=g})}this._itemToValue=a}};Exhibit.FormatParser=new Object();Exhibit.FormatParser.parse=function(a,d,e,b){e=e||0;b=b||{};var c=new Exhibit.FormatScanner(d,e);try{return Exhibit.FormatParser._internalParse(a,c,b,false)}finally{b.index=c.token()!=null?c.token().start:c.index()}};Exhibit.FormatParser.parseSeveral=function(a,d,e,b){e=e||0;b=b||{};var c=new Exhibit.FormatScanner(d,e);try{return Exhibit.FormatParser._internalParse(a,c,b,true)}finally{b.index=c.token()!=null?c.token().start:c.index()}};Exhibit.FormatParser._valueTypes={list:true,number:true,date:true,item:true,text:true,url:true,image:true,currency:true};Exhibit.FormatParser._internalParse=function(o,d,u,a){var w=Exhibit.FormatScanner;var i=d.token();var t=function(){d.next();i=d.token()};var h=function(){return i!=null?i.start:d.index()};var c=function(B,z,A){o.putSetting("format/"+B+"/"+z,A)};var e=function(B,A,z){if(i!=null&&i.type!=w.IDENTIFIER&&i.value in z){c(B,A,z[i.value]);t();return false}return true};var n=function(B,A,z){if(e(B,A,z)){if(i==null||i.type!=w.NUMBER){throw new Error("Missing number at position "+h())}c(B,A,i.value);t()}};var v=function(B,A,z){if(e(B,A,z)){if(i==null||i.type!=w.NUMBER){throw new Error("Missing integer at position "+h())}c(B,A,Math.round(i.value));t()}};var y=function(B,A,z){if(e(B,A,z)){if(i==null||i.type!=w.NUMBER||i.value<0){throw new Error("Missing non-negative integer at position "+h())}c(B,A,Math.round(i.value));t()}};var k=function(B,A,z){if(e(B,A,z)){if(i==null||i.type!=w.STRING){throw new Error("Missing string at position "+h())}c(B,A,i.value);t()}};var p=function(B,A,z){if(e(B,A,z)){if(i==null||i.type!=w.URL){throw new Error("Missing url at position "+h())}c(B,A,i.value);t()}};var s=function(B,A,z){if(e(B,A,z)){if(i==null||i.type!=w.EXPRESSION){throw new Error("Missing expression at position "+h())}c(B,A,i.value);t()}};var g=function(B,A,z){if(e(B,A,z)){if(i==null||(i.type!=w.EXPRESSION&&i.type!=w.STRING)){throw new Error("Missing expression or string at position "+h())}c(B,A,i.value);t()}};var r=function(C,A,B){if(i==null||i.type!=w.IDENTIFIER){throw new Error("Missing option at position "+h())}for(var z=0;z<B.length;z++){if(i.value==B[z]){c(C,A,i.value);t();return}}throw new Error("Unsupported option "+i.value+" for setting "+A+" on value type "+C+" found at position "+h())};var l=function(D,C,A,z){outer:while(i!=null&&i.type==w.IDENTIFIER){for(var B=0;B<A.length;B++){if(i.value==A[B]){c(D,C+"/"+i.value,true);t();continue outer}}if(i.value in z){c(D,C+"/"+z[i.value],false);t();continue outer}throw new Error("Unsupported flag "+i.value+" for setting "+C+" on value type "+D+" found at position "+h())}};var x=function(A,z){switch(A){case"number":switch(z){case"decimal-digits":y(A,z,{"default":-1});return}break;case"date":switch(z){case"time-zone":n(A,z,{"default":null});return;case"show":r(A,z,["date","time","date-time"]);return;case"mode":r(A,z,["short","medium","long","full"]);c(A,"template",null);return;case"template":k(A,z,{});c(A,"mode",null);return}break;case"boolean":switch(z){}break;case"text":switch(z){case"max-length":v(A,z,{none:0});return}break;case"image":switch(z){case"tooltip":g(A,z,{none:null});return;case"max-width":case"max-height":v(A,z,{none:-1});return}break;case"url":switch(z){case"target":k(A,z,{none:null});return;case"external-icon":p(A,z,{none:null});return}break;case"item":switch(z){case"title":s(A,z,{"default":null});return}break;case"currency":switch(z){case"negative-format":l(A,z,["red","parentheses","signed"],{unsigned:"signed","no-parenthesis":"parentheses",black:"red"});return;case"symbol":k(A,z,{"default":"$",none:null});return;case"symbol-placement":r(A,z,["first","last","after-sign"]);return;case"decimal-digits":y(A,z,{"default":-1});return}break;case"list":switch(z){case"separator":case"last-separator":case"pair-separator":case"empty-text":k(A,z,{});return}break}throw new Error("Unsupported setting called "+z+" for value type "+A+" found at position "+h())};var q=function(A){while(i!=null&&i.type==w.IDENTIFIER){var z=i.value;t();if(i==null||i.type!=w.DELIMITER||i.value!=":"){throw new Error("Missing : at position "+h())}t();x(A,z);if(i==null||i.type!=w.DELIMITER||i.value!=";"){break}else{t()}}};var m=function(){if(i==null||i.type!=w.IDENTIFIER){throw new Error("Missing value type at position "+h())}var z=i.value;if(!(z in Exhibit.FormatParser._valueTypes)){throw new Error("Unsupported value type "+z+" at position "+h())}t();if(i!=null&&i.type==w.DELIMITER&&i.value=="{"){t();q(z);if(i==null||i.type!=w.DELIMITER||i.value!="}"){throw new Error("Missing } at position "+h())}t()}return z};var b=function(){var z="text";while(i!=null&&i.type==w.IDENTIFIER){z=m()}return z};if(a){return b()}else{return m()}};Exhibit.FormatScanner=function(b,a){this._text=b+" ";this._maxIndex=b.length;this._index=a;this.next()};Exhibit.FormatScanner.DELIMITER=0;Exhibit.FormatScanner.NUMBER=1;Exhibit.FormatScanner.STRING=2;Exhibit.FormatScanner.IDENTIFIER=3;Exhibit.FormatScanner.URL=4;Exhibit.FormatScanner.EXPRESSION=5;Exhibit.FormatScanner.COLOR=6;Exhibit.FormatScanner.prototype.token=function(){return this._token};Exhibit.FormatScanner.prototype.index=function(){return this._index};Exhibit.FormatScanner.prototype.next=function(){this._token=null;var m=this;var b=function(i){while(i<m._maxIndex&&" \t\r\n".indexOf(m._text.charAt(i))>=0){i++}return i};this._index=b(this._index);if(this._index<this._maxIndex){var e=this._text.charAt(this._index);var c=this._text.charAt(this._index+1);if("{}(),:;".indexOf(e)>=0){this._token={type:Exhibit.FormatScanner.DELIMITER,value:e,start:this._index,end:this._index+1};this._index++}else{if("\"'".indexOf(e)>=0){var g=this._index+1;while(g<this._maxIndex){if(this._text.charAt(g)==e&&this._text.charAt(g-1)!="\\"){break}g++}if(g<this._maxIndex){this._token={type:Exhibit.FormatScanner.STRING,value:this._text.substring(this._index+1,g).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:this._index,end:g+1};this._index=g+1}else{throw new Error("Unterminated string starting at "+this._index)}}else{if(e=="#"){var g=this._index+1;while(g<this._maxIndex&&this._isHexDigit(this._text.charAt(g))){g++}this._token={type:Exhibit.FormatScanner.COLOR,value:this._text.substring(this._index,g),start:this._index,end:g};this._index=g}else{if(this._isDigit(e)){var g=this._index;while(g<this._maxIndex&&this._isDigit(this._text.charAt(g))){g++}if(g<this._maxIndex&&this._text.charAt(g)=="."){g++;while(g<this._maxIndex&&this._isDigit(this._text.charAt(g))){g++}}this._token={type:Exhibit.FormatScanner.NUMBER,value:parseFloat(this._text.substring(this._index,g)),start:this._index,end:g};this._index=g}else{var g=this._index;while(g<this._maxIndex){var d=this._text.substr(g).search(/\W/);if(d>0){g+=d}else{if("-".indexOf(this._text.charAt(g))>=0){g++}else{break}}}var k=this._text.substring(this._index,g);while(true){if(k=="url"){var n=b(g);if(this._text.charAt(n)=="("){var h=this._text.indexOf(")",n);if(h>0){this._token={type:Exhibit.FormatScanner.URL,value:this._text.substring(n+1,h),start:this._index,end:h+1};this._index=h+1;break}else{throw new Error("Missing ) to close url at "+this._index)}}}else{if(k=="expression"){var n=b(g);if(this._text.charAt(n)=="("){var a={};var l=Exhibit.ExpressionParser.parse(this._text,n+1,a);var h=b(a.index);if(this._text.charAt(h)==")"){this._token={type:Exhibit.FormatScanner.EXPRESSION,value:l,start:this._index,end:h+1};this._index=h+1;break}else{throw new Error("Missing ) to close expression at "+a.index)}}}}this._token={type:Exhibit.FormatScanner.IDENTIFIER,value:k,start:this._index,end:g};this._index=g;break}}}}}}};Exhibit.FormatScanner.prototype._isDigit=function(a){return"0123456789".indexOf(a)>=0};Exhibit.FormatScanner.prototype._isHexDigit=function(a){return"0123456789abcdefABCDEF".indexOf(a)>=0};Exhibit.Formatter=new Object();Exhibit.Formatter.createListDelimiter=function(h,c,a){var g=a.getSetting("format/list/separator");var b=a.getSetting("format/list/last-separator");var e=a.getSetting("format/list/pair-separator");if(typeof g!="string"){g=Exhibit.Formatter.l10n.listSeparator}if(typeof b!="string"){b=Exhibit.Formatter.l10n.listLastSeparator}if(typeof e!="string"){e=Exhibit.Formatter.l10n.listPairSeparator}var d=function(){if(d.index>0&&d.index<c){if(c>2){h.appendChild(document.createTextNode((d.index==c-1)?b:g))}else{h.appendChild(document.createTextNode(e))}}d.index++};d.index=0;return d};Exhibit.Formatter._lessThanRegex=/</g;Exhibit.Formatter._greaterThanRegex=/>/g;Exhibit.Formatter.encodeAngleBrackets=function(a){return a.replace(Exhibit.Formatter._lessThanRegex,"&lt;").replace(Exhibit.Formatter._greaterThanRegex,"&gt;")};Exhibit.Formatter._ListFormatter=function(a){this._uiContext=a;this._separator=a.getSetting("format/list/separator");this._lastSeparator=a.getSetting("format/list/last-separator");this._pairSeparator=a.getSetting("format/list/pair-separator");this._emptyText=a.getSetting("format/list/empty-text");if(typeof this._separator!="string"){this._separator=Exhibit.Formatter.l10n.listSeparator}if(typeof this._lastSeparator!="string"){this._lastSeparator=Exhibit.Formatter.l10n.listLastSeparator}if(typeof this._pairSeparator!="string"){this._pairSeparator=Exhibit.Formatter.l10n.listPairSeparator}};Exhibit.Formatter._ListFormatter.prototype.formatList=function(d,g,h,a){var c=this._uiContext;var b=this;if(g==0){if(this._emptyText!=null&&this._emptyText.length>0){a(document.createTextNode(this._emptyText))}}else{if(g==1){d.visit(function(i){c.format(i,h,a)})}else{var e=0;if(g==2){d.visit(function(i){c.format(i,h,a);e++;if(e==1){a(document.createTextNode(b._pairSeparator))}})}else{d.visit(function(i){c.format(i,h,a);e++;if(e<g){a(document.createTextNode((e==g-1)?b._lastSeparator:b._separator))}})}}}};Exhibit.Formatter._TextFormatter=function(a){this._maxLength=a.getSetting("format/text/max-length");if(typeof this._maxLength=="number"){this._maxLength=Math.max(3,Math.round(this._maxLength))}else{this._maxLength=0}};Exhibit.Formatter._TextFormatter.prototype.format=function(c,a){var b=document.createElement("span");b.innerHTML=this.formatText(c);a(b)};Exhibit.Formatter._TextFormatter.prototype.formatText=function(a){if(Exhibit.params.safe){a=Exhibit.Formatter.encodeAngleBrackets(a)}if(this._maxLength==0||a.length<=this._maxLength){return a}else{return a.substr(0,this._maxLength)+Exhibit.Formatter.l10n.textEllipsis}};Exhibit.Formatter._BooleanFormatter=function(a){};Exhibit.Formatter._BooleanFormatter.prototype.format=function(c,a){var b=document.createElement("span");b.innerHTML=this.formatText(c);a(b)};Exhibit.Formatter._BooleanFormatter.prototype.formatText=function(a){return(typeof a=="boolean"?a:(typeof a=="string"?(a=="true"):false))?Exhibit.Formatter.l10n.booleanTrue:Exhibit.Formatter.l10n.booleanFalse};Exhibit.Formatter._NumberFormatter=function(a){this._decimalDigits=a.getSetting("format/number/decimal-digits");if(typeof this._decimalDigits=="number"){this._decimalDigits=Math.max(-1,Math.round(this._decimalDigits))}else{this._decimalDigits=-1}};Exhibit.Formatter._NumberFormatter.prototype.format=function(b,a){a(document.createTextNode(this.formatText(b)))};Exhibit.Formatter._NumberFormatter.prototype.formatText=function(a){if(this._decimalDigits==-1){return a.toString()}else{return new Number(a).toFixed(this._decimalDigits)}};Exhibit.Formatter._ImageFormatter=function(a){this._uiContext=a;this._maxWidth=a.getSetting("format/image/max-width");if(typeof this._maxWidth=="number"){this._maxWidth=Math.max(-1,Math.round(this._maxWidth))}else{this._maxWidth=-1}this._maxHeight=a.getSetting("format/image/max-height");if(typeof this._maxHeight=="number"){this._maxHeight=Math.max(-1,Math.round(this._maxHeight))}else{this._maxHeight=-1}this._tooltip=a.getSetting("format/image/tooltip")};Exhibit.Formatter._ImageFormatter.prototype.format=function(c,a){if(Exhibit.params.safe){c=c.trim().startsWith("javascript:")?"":c}var b=document.createElement("img");b.src=c;if(this._tooltip!=null){if(typeof this._tooltip=="string"){b.title=this._tootlip}else{b.title=this._tooltip.evaluateSingleOnItem(this._uiContext.getSetting("itemID"),this._uiContext.getDatabase()).value}}a(b)};Exhibit.Formatter._ImageFormatter.prototype.formatText=function(a){return a};Exhibit.Formatter._URLFormatter=function(a){this._target=a.getSetting("format/url/target");this._externalIcon=a.getSetting("format/url/external-icon")};Exhibit.Formatter._URLFormatter.prototype.format=function(d,c){var b=document.createElement("a");b.href=d;b.innerHTML=d;if(this._target!=null){b.target=this._target}if(this._externalIcon!=null){}c(b)};Exhibit.Formatter._URLFormatter.prototype.formatText=function(a){if(Exhibit.params.safe){a=a.trim().startsWith("javascript:")?"":a}return a};Exhibit.Formatter._CurrencyFormatter=function(a){this._decimalDigits=a.getSetting("format/currency/decimal-digits");if(typeof this._decimalDigits=="number"){this._decimalDigits=Math.max(-1,Math.round(this._decimalDigits))}else{this._decimalDigits=2}this._symbol=a.getSetting("format/currency/symbol");if(this._symbol==null){this._symbol=Exhibit.Formatter.l10n.currencySymbol}this._symbolPlacement=a.getSetting("format/currency/symbol-placement");if(this._symbolPlacement==null){this._symbol=Exhibit.Formatter.l10n.currencySymbolPlacement}this._negativeFormat={signed:a.getBooleanSetting("format/currency/negative-format/signed",Exhibit.Formatter.l10n.currencyShowSign),red:a.getBooleanSetting("format/currency/negative-format/red",Exhibit.Formatter.l10n.currencyShowRed),parentheses:a.getBooleanSetting("format/currency/negative-format/parentheses",Exhibit.Formatter.l10n.currencyShowParentheses)}};Exhibit.Formatter._CurrencyFormatter.prototype.format=function(c,a){var d=this.formatText(c);if(c<0&&this._negativeFormat.red){var b=document.createElement("span");b.innerHTML=d;b.style.color="red";a(b)}else{a(document.createTextNode(d))}};Exhibit.Formatter._CurrencyFormatter.prototype.formatText=function(c){var b=c<0;var d;if(this._decimalDigits==-1){d=Math.abs(c)}else{d=new Number(Math.abs(c)).toFixed(this._decimalDigits)}var a=(b&&this._negativeFormat.signed)?"-":"";if(b&&this._negativeFormat.parentheses){d="("+d+")"}switch(this._negativeFormat){case"first":d=this._symbol+a+d;break;case"after-sign":d=a+this._symbol+d;break;case"last":d=a+d+this._symbol;break}return d};Exhibit.Formatter._ItemFormatter=function(a){this._uiContext=a;this._title=a.getSetting("format/item/title")};Exhibit.Formatter._ItemFormatter.prototype.format=function(g,c){var d=this;var h=this.formatText(g);var b=SimileAjax.DOM.createElementFromString('<a href="'+Exhibit.Persistence.getItemLink(g)+"\" class='exhibit-item'>"+h+"</a>");var e=function(i,a,k){Exhibit.UI.showItemInPopup(g,i,d._uiContext)};SimileAjax.WindowManager.registerEvent(b,"click",e,this._uiContext.getSetting("layer"));c(b)};Exhibit.Formatter._ItemFormatter.prototype.formatText=function(b){var a=this._uiContext.getDatabase();var c=null;if(this._title==null){c=a.getObject(b,"label")}else{c=this._title.evaluateSingleOnItem(b,a).value}if(c==null){c=b}return c};Exhibit.Formatter._DateFormatter=function(c){this._timeZone=c.getSetting("format/date/time-zone");if(!(typeof this._timeZone=="number")){this._timeZone=-(new Date().getTimezoneOffset())/60}this._timeZoneOffset=this._timeZone*3600000;var e=c.getSetting("format/date/mode");var k=c.getSetting("format/date/show");var m=null;switch(e){case"short":m=k=="date"?Exhibit.Formatter.l10n.dateShortFormat:(k=="time"?Exhibit.Formatter.l10n.timeShortFormat:Exhibit.Formatter.l10n.dateTimeShortFormat);break;case"medium":m=k=="date"?Exhibit.Formatter.l10n.dateMediumFormat:(k=="time"?Exhibit.Formatter.l10n.timeMediumFormat:Exhibit.Formatter.l10n.dateTimeMediumFormat);break;case"long":m=k=="date"?Exhibit.Formatter.l10n.dateLongFormat:(k=="time"?Exhibit.Formatter.l10n.timeLongFormat:Exhibit.Formatter.l10n.dateTimeLongFormat);break;case"full":m=k=="date"?Exhibit.Formatter.l10n.dateFullFormat:(k=="time"?Exhibit.Formatter.l10n.timeFullFormat:Exhibit.Formatter.l10n.dateTimeFullFormat);break;default:m=c.getSetting("format/date/template")}if(typeof m!="string"){m=Exhibit.Formatter.l10n.dateTimeDefaultFormat}var d=[];var h=m.match(/\b\w+\b/g);var l=0;for(var a=0;a<h.length;a++){var i=h[a];var g=m.indexOf(i,l);if(g>l){d.push(m.substring(l,g))}var b=Exhibit.Formatter._DateFormatter._retrievers[i];if(typeof b=="function"){d.push(b)}else{d.push(i)}l=g+i.length}if(l<m.length){d.push(m.substr(l))}this._segments=d};Exhibit.Formatter._DateFormatter.prototype.format=function(b,a){a(document.createTextNode(this.formatText(b)))};Exhibit.Formatter._DateFormatter.prototype.formatText=function(e){var b=(e instanceof Date)?e:SimileAjax.DateTime.parseIso8601DateTime(e);if(b==null){return e}b.setTime(b.getTime()+this._timeZoneOffset);var g="";var a=this._segments;for(var c=0;c<a.length;c++){var d=a[c];if(typeof d=="string"){g+=d}else{g+=d(b)}}return g};Exhibit.Formatter._DateFormatter._pad=function(a){return a<10?("0"+a):a.toString()};Exhibit.Formatter._DateFormatter._pad3=function(a){return a<10?("00"+a):(a<100?("0"+a):a.toString())};Exhibit.Formatter._DateFormatter._retrievers={d:function(a){return a.getUTCDate().toString()},dd:function(a){return Exhibit.Formatter._DateFormatter._pad(a.getUTCDate())},EEE:function(a){return Exhibit.Formatter.l10n.shortDaysOfWeek[a.getUTCDay()]},EEEE:function(a){return Exhibit.Formatter.l10n.daysOfWeek[a.getUTCDay()]},MM:function(a){return Exhibit.Formatter._DateFormatter._pad(a.getUTCMonth()+1)},MMM:function(a){return Exhibit.Formatter.l10n.shortMonths[a.getUTCMonth()]},MMMM:function(a){return Exhibit.Formatter.l10n.months[a.getUTCMonth()]},yy:function(a){return Exhibit.Formatter._DateFormatter._pad(a.getUTCFullYear()%100)},yyyy:function(a){var b=a.getUTCFullYear();return b>0?b.toString():(1-b)},G:function(a){var b=a.getUTCYear();return b>0?Exhibit.Formatter.l10n.commonEra:Exhibit.Formatter.l10n.beforeCommonEra},HH:function(a){return Exhibit.Formatter._DateFormatter._pad(a.getUTCHours())},hh:function(a){var b=a.getUTCHours();return Exhibit.Formatter._DateFormatter._pad(b==0?12:(b>12?b-12:b))},h:function(a){var b=a.getUTCHours();return(b==0?12:(b>12?b-12:b)).toString()},a:function(a){return a.getUTCHours()<12?Exhibit.Formatter.l10n.beforeNoon:Exhibit.Formatter.l10n.afterNoon},A:function(a){return a.getUTCHours()<12?Exhibit.Formatter.l10n.BeforeNoon:Exhibit.Formatter.l10n.AfterNoon},mm:function(a){return Exhibit.Formatter._DateFormatter._pad(a.getUTCMinutes())},ss:function(a){return Exhibit.Formatter._DateFormatter._pad(a.getUTCSeconds())},S:function(a){return Exhibit.Formatter._DateFormatter._pad3(a.getUTCMilliseconds())}};Exhibit.Formatter._constructors={number:Exhibit.Formatter._NumberFormatter,date:Exhibit.Formatter._DateFormatter,text:Exhibit.Formatter._TextFormatter,"boolean":Exhibit.Formatter._BooleanFormatter,image:Exhibit.Formatter._ImageFormatter,url:Exhibit.Formatter._URLFormatter,item:Exhibit.Formatter._ItemFormatter,currency:Exhibit.Formatter._CurrencyFormatter};Exhibit.LensRegistry=function(a){this._parentRegistry=a;this._defaultLens=null;this._typeToLens={};this._lensSelectors=[]};Exhibit.LensRegistry.prototype.registerDefaultLens=function(a){this._defaultLens=(typeof a=="string")?a:a.cloneNode(true)};Exhibit.LensRegistry.prototype.registerLensForType=function(b,a){this._typeToLens[a]=(typeof b=="string")?b:b.cloneNode(true)};Exhibit.LensRegistry.prototype.addLensSelector=function(a){this._lensSelectors.unshift(a)};Exhibit.LensRegistry.prototype.getLens=function(e,d){for(var b=0;b<this._lensSelectors.length;b++){var a=this._lensSelectors[b](e,d);if(a!=null){return a}}var c=d.getObject(e,"type");if(c in this._typeToLens){return this._typeToLens[c]}if(this._defaultLens!=null){return this._defaultLens}if(this._parentRegistry){return this._parentRegistry.getLens(e,d)}return null};Exhibit.LensRegistry.prototype.createLens=function(d,e,a){var b=new Exhibit.Lens();var c=this.getLens(d,a.getDatabase());if(c==null){b._constructDefaultUI(d,e,a)}else{if(typeof c=="string"){b._constructFromLensTemplateURL(d,e,a,c)}else{b._constructFromLensTemplateDOM(d,e,a,c)}}return b};Exhibit.Lens=function(){};Exhibit.Lens._commonProperties=null;Exhibit.Lens.prototype._constructDefaultUI=function(c,a,k){var q=k.getDatabase();if(Exhibit.Lens._commonProperties==null){Exhibit.Lens._commonProperties=q.getAllProperties()}var n=Exhibit.Lens._commonProperties;var p=q.getObject(c,"label");p=p!=null?p:c;if(Exhibit.params.safe){p=Exhibit.Formatter.encodeAngleBrackets(p)}var r={elmt:a,className:"exhibit-lens",children:[{tag:"div",className:"exhibit-lens-title",title:p,children:[p+" (",{tag:"a",href:Exhibit.Persistence.getItemLink(c),target:"_blank",children:[Exhibit.l10n.itemLinkLabel]},")"]},{tag:"div",className:"exhibit-lens-body",children:[{tag:"table",className:"exhibit-lens-properties",field:"propertiesTable"}]}]};var i=SimileAjax.DOM.createDOMFromTemplate(r);a.setAttribute("ex:itemID",c);var b=Exhibit.ViewPanel.getPropertyValuesPairs(c,n,q);for(var h=0;h<b.length;h++){var g=b[h];var o=i.propertiesTable.insertRow(h);o.className="exhibit-lens-property";var e=o.insertCell(0);e.className="exhibit-lens-property-name";e.innerHTML=g.propertyLabel+": ";var l=o.insertCell(1);l.className="exhibit-lens-property-values";if(g.valueType=="item"){for(var d=0;d<g.values.length;d++){if(d>0){l.appendChild(document.createTextNode(", "))}l.appendChild(Exhibit.UI.makeItemSpan(g.values[d],null,k))}}else{for(var d=0;d<g.values.length;d++){if(d>0){l.appendChild(document.createTextNode(", "))}l.appendChild(Exhibit.UI.makeValueSpan(g.values[d],g.valueType))}}}};Exhibit.Lens._compiledTemplates={};Exhibit.Lens._handlers=["onblur","onfocus","onkeydown","onkeypress","onkeyup","onmousedown","onmouseenter","onmouseleave","onmousemove","onmouseout","onmouseover","onmouseup","onclick","onresize","onscroll"];Exhibit.Lens.prototype._constructFromLensTemplateURL=function(d,g,b,e){var c={lens:this,itemID:d,div:g,uiContext:b};var a=Exhibit.Lens._compiledTemplates[e];if(a==null){Exhibit.Lens._startCompilingTemplate(e,c)}else{if(!a.compiled){a.jobs.push(c)}else{c.template=a;Exhibit.Lens._performConstructFromLensTemplateJob(c)}}};Exhibit.Lens.prototype._constructFromLensTemplateDOM=function(e,h,b,c){var d={lens:this,itemID:e,div:h,uiContext:b};var g=c.id;if(g==null||g.length==0){g="exhibitLensTemplate"+Math.floor(Math.random()*10000);c.id=g}var a=Exhibit.Lens._compiledTemplates[g];if(a==null){a={url:g,template:Exhibit.Lens.compileTemplate(c,false,b),compiled:true,jobs:[]};Exhibit.Lens._compiledTemplates[g]=a}d.template=a;Exhibit.Lens._performConstructFromLensTemplateJob(d)};Exhibit.Lens._startCompilingTemplate=function(e,c){var a={url:e,template:null,compiled:false,jobs:[c]};Exhibit.Lens._compiledTemplates[e]=a;var d=function(i,g,h){SimileAjax.Debug.log("Failed to load view template from "+e+"\n"+i)};var b=function(h){try{a.template=Exhibit.Lens.compileTemplate(h.responseXML.documentElement,true,c.uiContext);a.compiled=true;for(var g=0;g<a.jobs.length;g++){try{var l=a.jobs[g];l.template=a;Exhibit.Lens._performConstructFromLensTemplateJob(l)}catch(k){SimileAjax.Debug.exception(k,"Lens: Error constructing lens template in job queue")}}a.jobs=null}catch(k){SimileAjax.Debug.exception(k,"Lens: Error compiling lens template and processing template job queue")}};SimileAjax.XmlHttp.get(e,d,b);return a};Exhibit.Lens.compileTemplate=function(b,c,a){return Exhibit.Lens._processTemplateNode(b,c,a)};Exhibit.Lens._processTemplateNode=function(b,c,a){if(b.nodeType==1){return Exhibit.Lens._processTemplateElement(b,c,a)}else{return b.nodeValue}};Exhibit.Lens._processTemplateElement=function(g,s,l){var d={tag:g.tagName.toLowerCase(),uiContext:l,control:null,condition:null,content:null,contentAttributes:null,subcontentAttributes:null,attributes:[],styles:[],handlers:[],children:null};var q=true;var m=g.attributes;for(var n=0;n<m.length;n++){var e=m[n];var b=e.nodeName;var r=e.nodeValue;if(r==null||typeof r!="string"||r.length==0||b=="contentEditable"){continue}if(b=="ex:onshow"){d.attributes.push({name:b,value:r})}else{if(b.length>3&&b.substr(0,3)=="ex:"){b=b.substr(3);if(b=="formats"){d.uiContext=Exhibit.UIContext._createWithParent(l);Exhibit.FormatParser.parseSeveral(d.uiContext,r,0,{})}else{if(b=="control"){d.control=r}else{if(b=="content"){d.content=Exhibit.ExpressionParser.parse(r)}else{if(b=="if-exists"){d.condition={test:"if-exists",expression:Exhibit.ExpressionParser.parse(r)}}else{if(b=="if"){d.condition={test:"if",expression:Exhibit.ExpressionParser.parse(r)};q=false}else{if(b=="select"){d.condition={test:"select",expression:Exhibit.ExpressionParser.parse(r)}}else{if(b=="case"){d.condition={test:"case",value:r};q=false}else{var u=false;var p=b.indexOf("-style-content");if(p>0){u=true}else{p=b.indexOf("-content")}if(p>0){if(d.contentAttributes==null){d.contentAttributes=[]}d.contentAttributes.push({name:b.substr(0,p),expression:Exhibit.ExpressionParser.parse(r),isStyle:u})}else{p=b.indexOf("-style-subcontent");if(p>0){u=true}else{p=b.indexOf("-subcontent")}if(p>0){if(d.subcontentAttributes==null){d.subcontentAttributes=[]}d.subcontentAttributes.push({name:b.substr(0,p),fragments:Exhibit.Lens._parseSubcontentAttribute(r),isStyle:u})}}}}}}}}}}else{if(b=="style"){Exhibit.Lens._processStyle(d,r)}else{if(b!="id"){if(b=="className"){b="class"}else{if(b=="cellspacing"){b="cellSpacing"}else{if(b=="cellpadding"){b="cellPadding"}else{if(b=="bgcolor"){b="bgColor"}}}}d.attributes.push({name:b,value:r})}}}}}if(!s&&SimileAjax.Platform.browser.isIE){var k=Exhibit.Lens._handlers;for(var o=0;o<k.length;o++){var t=k[o];var c=g[t];if(c!=null){d.handlers.push({name:t,code:c})}}}var a=g.firstChild;if(a!=null){d.children=[];while(a!=null){if((q&&a.nodeType==3)||a.nodeType==1){d.children.push(Exhibit.Lens._processTemplateNode(a,s,d.uiContext))}a=a.nextSibling}}return d};Exhibit.Lens._processStyle=function(a,k){var h=k.split(";");for(var i=0;i<h.length;i++){var c=h[i].split(":");if(c.length>1){var b=c[0].trim();var g=c[1].trim();if(b=="float"){b=SimileAjax.Platform.browser.isIE?"styleFloat":"cssFloat"}else{if(b=="-moz-opacity"){b="MozOpacity"}else{if(b.indexOf("-")>0){var d=b.split("-");b=d[0];for(var e=1;e<d.length;e++){b+=d[e].substr(0,1).toUpperCase()+d[e].substr(1)}}}}a.styles.push({name:b,value:g})}}};Exhibit.Lens._parseSubcontentAttribute=function(c){var a=[];var d=0;var b;while(d<c.length&&(b=c.indexOf("{{",d))>=0){var e=c.indexOf("}}",b);if(e<0){break}a.push(c.substring(d,b));a.push(Exhibit.ExpressionParser.parse(c.substring(b+2,e)));d=e+2}if(d<c.length){a.push(c.substr(d))}return a};Exhibit.Lens.constructFromLensTemplate=function(c,b,d,a){return Exhibit.Lens._performConstructFromLensTemplateJob({itemID:c,template:{template:b},div:d,uiContext:a})};Exhibit.Lens._performConstructFromLensTemplateJob=function(job){Exhibit.Lens._constructFromLensTemplateNode({value:job.itemID},{value:"item"},job.template.template,job.div);var node=job.div.lastChild;var tagName=node.tagName;if(tagName=="span"){node.style.display="inline"}else{node.style.display="block"}node.setAttribute("ex:itemID",job.itemID);if(!Exhibit.params.safe){var onshow=Exhibit.getAttribute(node,"onshow");if(onshow!=null&&onshow.length>0){try{eval("(function() { "+onshow+" })").call(node)}catch(e){SimileAjax.Debug.log(e)}}}return node};Exhibit.Lens._constructFromLensTemplateNode=function(o,q,G,g){if(typeof G=="string"){g.appendChild(document.createTextNode(G));return}var u=G.uiContext.getDatabase();var m=G.children;if(G.condition!=null){if(G.condition.test=="if-exists"){if(!G.condition.expression.testExists(o,q,"value",u)){return}}else{if(G.condition.test=="if"){if(G.condition.expression.evaluate(o,q,"value",u).values.contains(true)){if(m!=null&&m.length>0){Exhibit.Lens._constructFromLensTemplateNode(o,q,m[0],g)}}else{if(m!=null&&m.length>1){Exhibit.Lens._constructFromLensTemplateNode(o,q,m[1],g)}}return}else{if(G.condition.test=="select"){var e=G.condition.expression.evaluate(o,q,"value",u).values;if(m!=null){var k=null;for(var C=0;C<m.length;C++){var s=m[C];if(s.condition!=null&&s.condition.test=="case"){if(e.contains(s.condition.value)){Exhibit.Lens._constructFromLensTemplateNode(o,q,s,g);return}}else{if(typeof s!="string"){k=s}}}}if(k!=null){Exhibit.Lens._constructFromLensTemplateNode(o,q,k,g)}return}}}}var p=Exhibit.Lens._constructElmtWithAttributes(G,g,u);if(G.contentAttributes!=null){var D=G.contentAttributes;for(var A=0;A<D.length;A++){var t=D[A];var e=[];t.expression.evaluate(o,q,"value",u).values.visit(function(a){e.push(a)});var y=e.join(";");if(t.isStyle){p.style[t.name]=y}else{if("class"==t.name){p.className=y}else{if(Exhibit.Lens._attributeValueIsSafe(t.name,y)){p.setAttribute(t.name,y)}}}}}if(G.subcontentAttributes!=null){var l=G.subcontentAttributes;for(var A=0;A<l.length;A++){var t=l[A];var H=t.fragments;var x="";for(var v=0;v<H.length;v++){var b=H[v];if(typeof b=="string"){x+=b}else{x+=b.evaluateSingle(o,q,"value",u).value}}if(t.isStyle){p.style[t.name]=x}else{if("class"==t.name){p.className=x}else{if(Exhibit.Lens._attributeValueIsSafe(t.name,x)){p.setAttribute(t.name,x)}}}}}if(!Exhibit.params.safe){var w=G.handlers;for(var B=0;B<w.length;B++){var d=w[B];p[d.name]=d.code}}if(G.control!=null){switch(G.control){case"item-link":var E=document.createElement("a");E.innerHTML=Exhibit.l10n.itemLinkLabel;E.href=Exhibit.Persistence.getItemLink(o.value);E.target="_blank";p.appendChild(E)}}else{if(G.content!=null){var x=G.content.evaluate(o,q,"value",u);if(m!=null){var z={value:x.valueType,index:"number"};var n=1;var F=function(c){var a={value:c,index:n++};for(var h=0;h<m.length;h++){Exhibit.Lens._constructFromLensTemplateNode(a,z,m[h],p)}};if(x.values instanceof Array){for(var A=0;A<x.values.length;A++){F(x.values[A])}}else{x.values.visit(F)}}else{Exhibit.Lens._constructDefaultValueList(x.values,x.valueType,p,G.uiContext)}}else{if(m!=null){for(var A=0;A<m.length;A++){Exhibit.Lens._constructFromLensTemplateNode(o,q,m[A],p)}}}}};Exhibit.Lens._constructElmtWithAttributes=function(c,h,o){var g;if(c.tag=="input"&&SimileAjax.Platform.browser.isIE){var n=["<input"];var k=c.attributes;for(var l=0;l<k.length;l++){var d=k[l];if(Exhibit.Lens._attributeValueIsSafe(d.name,d.value)){n.push(d.name+'="'+d.value+'"')}}n.push("></input>");g=SimileAjax.DOM.createElementFromString(n.join(" "));h.appendChild(g)}else{switch(c.tag){case"tr":g=h.insertRow(h.rows.length);break;case"td":g=h.insertCell(h.cells.length);break;default:g=document.createElement(c.tag);h.appendChild(g)}var k=c.attributes;for(var l=0;l<k.length;l++){var d=k[l];if(Exhibit.Lens._attributeValueIsSafe(d.name,d.value)){try{g.setAttribute(d.name,d.value)}catch(m){}}}}var p=c.styles;for(var l=0;l<p.length;l++){var b=p[l];g.style[b.name]=b.value}return g};Exhibit.Lens._constructDefaultValueList=function(b,d,c,a){a.formatList(b,b.size(),d,function(e){c.appendChild(e)})};Exhibit.Lens._attributeValueIsSafe=function(a,b){if(Exhibit.params.safe){if((a=="href"&&b.startsWith("javascript:"))||(a.startsWith("on"))){return false}}return true};Exhibit.UIContext=function(){this._parent=null;this._exhibit=null;this._collection=null;this._lensRegistry=new Exhibit.LensRegistry();this._settings={};this._formatters={};this._listFormatter=null};Exhibit.UIContext.createRootContext=function(g,b){var c=new Exhibit.UIContext();c._exhibit=b;var d=Exhibit.UIContext.l10n.initialSettings;for(var e in d){c._settings[e]=d[e]}var a=Exhibit.getAttribute(document.body,"formats");if(a!=null&&a.length>0){Exhibit.FormatParser.parseSeveral(c,a,0,{})}Exhibit.SettingsUtilities.collectSettingsFromDOM(document.body,Exhibit.UIContext._settingSpecs,c._settings);Exhibit.UIContext._configure(c,g);return c};Exhibit.UIContext.create=function(d,b,a){var c=Exhibit.UIContext._createWithParent(b);Exhibit.UIContext._configure(c,d,a);return c};Exhibit.UIContext.createFromDOM=function(e,c,b){var d=Exhibit.UIContext._createWithParent(c);if(!(b)){Exhibit.UIContext.registerLensesFromDOM(e,d.getLensRegistry())}var g=Exhibit.getAttribute(e,"collectionID");if(g!=null&&g.length>0){d._collection=d._exhibit.getCollection(g)}var a=Exhibit.getAttribute(e,"formats");if(a!=null&&a.length>0){Exhibit.FormatParser.parseSeveral(d,a,0,{})}Exhibit.SettingsUtilities.collectSettingsFromDOM(e,Exhibit.UIContext._settingSpecs,d._settings);Exhibit.UIContext._configure(d,Exhibit.getConfigurationFromDOM(e),b);return d};Exhibit.UIContext.prototype.dispose=function(){};Exhibit.UIContext.prototype.getParentUIContext=function(){return this._parent};Exhibit.UIContext.prototype.getExhibit=function(){return this._exhibit};Exhibit.UIContext.prototype.getDatabase=function(){return this.getExhibit().getDatabase()};Exhibit.UIContext.prototype.getCollection=function(){if(this._collection==null){if(this._parent!=null){this._collection=this._parent.getCollection()}else{this._collection=this._exhibit.getDefaultCollection()}}return this._collection};Exhibit.UIContext.prototype.getLensRegistry=function(){return this._lensRegistry};Exhibit.UIContext.prototype.getSetting=function(a){return a in this._settings?this._settings[a]:(this._parent!=null?this._parent.getSetting(a):undefined)};Exhibit.UIContext.prototype.getBooleanSetting=function(c,a){var b=this.getSetting(c);return b==undefined||b==null?a:b};Exhibit.UIContext.prototype.putSetting=function(a,b){this._settings[a]=b};Exhibit.UIContext.prototype.format=function(c,d,a){var b;if(d in this._formatters){b=this._formatters[d]}else{b=this._formatters[d]=new Exhibit.Formatter._constructors[d](this)}b.format(c,a)};Exhibit.UIContext.prototype.formatList=function(b,c,d,a){if(this._listFormatter==null){this._listFormatter=new Exhibit.Formatter._ListFormatter(this)}this._listFormatter.formatList(b,c,d,a)};Exhibit.UIContext._createWithParent=function(b){var a=new Exhibit.UIContext();a._parent=b;a._exhibit=b._exhibit;a._lensRegistry=new Exhibit.LensRegistry(b.getLensRegistry());return a};Exhibit.UIContext._settingSpecs={bubbleWidth:{type:"int"},bubbleHeight:{type:"int"}};Exhibit.UIContext._configure=function(b,c,a){Exhibit.UIContext.registerLenses(c,b.getLensRegistry());if("collectionID" in c){b._collection=b._exhibit.getCollection(c.collectionID)}if("formats" in c){Exhibit.FormatParser.parseSeveral(b,c.formats,0,{})}if(!(a)){Exhibit.SettingsUtilities.collectSettings(c,Exhibit.UIContext._settingSpecs,b._settings)}};Exhibit.UIContext.registerLens=function(d,a){var c=d.templateFile;if(c!=null){if("itemTypes" in d){for(var b=0;b<d.itemTypes.length;b++){a.registerLensForType(c,d.itemTypes[b])}}else{a.registerDefaultLens(c)}}};Exhibit.UIContext.registerLensFromDOM=function(d,b){d.style.display="none";var h=Exhibit.getAttribute(d,"itemTypes",",");var g=null;var a=Exhibit.getAttribute(d,"templateFile");if(a!=null&&a.length>0){g=a}else{var k=Exhibit.getAttribute(d,"template");var e=document.getElementById(k);if(e!=null){g=e}else{g=d}}if(g!=null){if(h==null||h.length==0||(h.length==1&&h[0]=="")){b.registerDefaultLens(g)}else{for(var c=0;c<h.length;c++){b.registerLensForType(g,h[c])}}}};Exhibit.UIContext.registerLenses=function(d,b){if("lenses" in d){for(var c=0;c<d.lenses.length;c++){Exhibit.UIContext.registerLens(d.lenses[c],b)}}if("lensSelector" in d){var a=d.lensSelector;if(typeof a=="function"){b.addLensSelector(a)}else{SimileAjax.Debug.log("lensSelector is not a function")}}};Exhibit.UIContext.registerLensesFromDOM=function(parentNode,lensRegistry){var node=parentNode.firstChild;while(node!=null){if(node.nodeType==1){var role=Exhibit.getRoleAttribute(node);if(role=="lens"){Exhibit.UIContext.registerLensFromDOM(node,lensRegistry)}}node=node.nextSibling}var lensSelectorString=Exhibit.getAttribute(parentNode,"lensSelector");if(lensSelectorString!=null&&lensSelectorString.length>0){try{var lensSelector=eval(lensSelectorString);if(typeof lensSelector=="function"){lensRegistry.addLensSelector(lensSelector)}else{SimileAjax.Debug.log("lensSelector expression "+lensSelectorString+" is not a function")}}catch(e){SimileAjax.Debug.exception(e,"Bad lensSelector expression: "+lensSelectorString)}}};Exhibit.UIContext.createLensRegistry=function(c,b){var a=new Exhibit.LensRegistry(b);Exhibit.UIContext.registerLenses(c,a);return a};Exhibit.UIContext.createLensRegistryFromDOM=function(a,d,c){var b=new Exhibit.LensRegistry(c);Exhibit.UIContext.registerLensesFromDOM(a,b);Exhibit.UIContext.registerLenses(d,b);return b};Exhibit.UI=new Object();Exhibit.UI.create=function(d,b,a){if("role" in d){var c=d.role;if(c!=null&&c.startsWith("exhibit-")){c=c.substr("exhibit-".length)}switch(c){case"lens":Exhibit.UIContext.registerLens(d,a.getLensRegistry());return null;case"view":return Exhibit.UI.createView(d,b,a);case"facet":return Exhibit.UI.createFacet(d,b,a);case"coordinator":return Exhibit.UI.createCoordinator(d,a);case"coder":return Exhibit.UI.createCoder(d,a);case"viewPanel":return Exhibit.ViewPanel.create(d,b,a);case"logo":return Exhibit.Logo.create(d,b,a);case"hiddenContent":b.style.display="none";return null}}return null};Exhibit.UI.createFromDOM=function(b,a){var c=Exhibit.getRoleAttribute(b);switch(c){case"lens":Exhibit.UIContext.registerLensFromDOM(b,a.getLensRegistry());return null;case"view":return Exhibit.UI.createViewFromDOM(b,null,a);case"facet":return Exhibit.UI.createFacetFromDOM(b,null,a);case"coordinator":return Exhibit.UI.createCoordinatorFromDOM(b,a);case"coder":return Exhibit.UI.createCoderFromDOM(b,a);case"viewPanel":return Exhibit.ViewPanel.createFromDOM(b,a);case"logo":return Exhibit.Logo.createFromDOM(b,a);case"hiddenContent":b.style.display="none";return null}return null};Exhibit.UI.createView=function(d,b,a){var c="viewClass" in d?d.viewClass:Exhibit.TileView;if(typeof c=="string"){c=Exhibit.UI.viewClassNameToViewClass(c)}return c.create(d,b,a)};Exhibit.UI.createViewFromDOM=function(c,a,b){var d=Exhibit.UI.viewClassNameToViewClass(Exhibit.getAttribute(c,"viewClass"));return d.createFromDOM(c,a,b)};Exhibit.UI.viewClassNameToViewClass=function(a){if(a!=null&&a.length>0){try{return Exhibit.UI._stringToObject(a,"View")}catch(b){SimileAjax.Debug.warn("Unknown viewClass "+a)}}return Exhibit.TileView};Exhibit.UI.createFacet=function(d,b,a){var c="facetClass" in d?d.facetClass:Exhibit.ListFacet;if(typeof c=="string"){c=Exhibit.UI.facetClassNameToFacetClass(c)}return c.create(d,b,a)};Exhibit.UI.createFacetFromDOM=function(c,a,b){var d=Exhibit.UI.facetClassNameToFacetClass(Exhibit.getAttribute(c,"facetClass"));return d.createFromDOM(c,a,b)};Exhibit.UI.facetClassNameToFacetClass=function(a){if(a!=null&&a.length>0){try{return Exhibit.UI._stringToObject(a,"Facet")}catch(b){SimileAjax.Debug.warn("Unknown facetClass "+a)}}return Exhibit.ListFacet};Exhibit.UI.createCoder=function(c,a){var b="coderClass" in c?c.coderClass:Exhibit.ColorCoder;if(typeof b=="string"){b=Exhibit.UI.coderClassNameToCoderClass(b)}return b.create(c,a)};Exhibit.UI.createCoderFromDOM=function(b,a){var c=Exhibit.UI.coderClassNameToCoderClass(Exhibit.getAttribute(b,"coderClass"));return c.createFromDOM(b,a)};Exhibit.UI.coderClassNameToCoderClass=function(a){if(a!=null&&a.length>0){try{return Exhibit.UI._stringToObject(a,"Coder")}catch(b){SimileAjax.Debug.warn("Unknown coderClass "+a)}}return Exhibit.ColorCoder};Exhibit.UI.createCoordinator=function(b,a){return Exhibit.Coordinator.create(b,a)};Exhibit.UI.createCoordinatorFromDOM=function(b,a){return Exhibit.Coordinator.createFromDOM(b,a)};Exhibit.UI._stringToObject=function(name,suffix){if(!name.startsWith("Exhibit.")){if(!name.endsWith(suffix)){try{return eval("Exhibit."+name+suffix)}catch(e){}}try{return eval("Exhibit."+name)}catch(e){}}if(!name.endsWith(suffix)){try{return eval(name+suffix)}catch(e){}}try{return eval(name)}catch(e){}throw new Error("Unknown class "+name)};Exhibit.UI.docRoot="http://simile.mit.edu/wiki/";Exhibit.UI.validator="http://simile.mit.edu/babel/validator";Exhibit.UI.showHelp=function(b,a,c){c=(c)?c:"_blank";if(a!=null){if(window.confirm(b+"\n\n"+Exhibit.l10n.showDocumentationMessage)){window.open(a,c)}}else{window.alert(b)}};Exhibit.UI.showJavascriptExpressionValidation=function(a,c){var b="_blank";if(window.confirm(a+"\n\n"+Exhibit.l10n.showJavascriptValidationMessage)){window.open(Exhibit.UI.validator+"?expresson="+encodeURIComponent(c),b)}};Exhibit.UI.showJsonFileValidation=function(b,a){var c="_blank";if(a.indexOf("file:")==0){if(window.confirm(b+"\n\n"+Exhibit.l10n.showJsonValidationFormMessage)){window.open(Exhibit.UI.validator,c)}}else{if(window.confirm(b+"\n\n"+Exhibit.l10n.showJsonValidationMessage)){window.open(Exhibit.UI.validator+"?url="+a,c)}}};Exhibit.UI._busyIndicator=null;Exhibit.UI._busyIndicatorCount=0;Exhibit.UI.showBusyIndicator=function(){Exhibit.UI._busyIndicatorCount++;if(Exhibit.UI._busyIndicatorCount>1){return}if(Exhibit.UI._busyIndicator==null){Exhibit.UI._busyIndicator=Exhibit.UI.createBusyIndicator()}var c=("scrollTop" in document.body)?document.body.scrollTop:document.body.parentNode.scrollTop;var a=("innerHeight" in window)?window.innerHeight:("clientHeight" in document.body?document.body.clientHeight:document.body.parentNode.clientHeight);var b=Math.floor(c+a/3);Exhibit.UI._busyIndicator.style.top=b+"px";document.body.appendChild(Exhibit.UI._busyIndicator)};Exhibit.UI.hideBusyIndicator=function(){Exhibit.UI._busyIndicatorCount--;if(Exhibit.UI._busyIndicatorCount>0){return}try{document.body.removeChild(Exhibit.UI._busyIndicator)}catch(a){}};Exhibit.UI.protectUI=function(a){SimileAjax.DOM.appendClassName(a,"exhibit-ui-protection")};Exhibit.UI.makeActionLink=function(g,e,d){var c=document.createElement("a");c.href="javascript:";c.className="exhibit-action";c.innerHTML=g;var b=function(h,a,i){if("true"!=h.getAttribute("disabled")){e(h,a,i)}};SimileAjax.WindowManager.registerEvent(c,"click",b,d);return c};Exhibit.UI.enableActionLink=function(b,c){b.setAttribute("disabled",c?"false":"true");b.className=c?"exhibit-action":"exhibit-action-disabled"};Exhibit.UI.makeItemSpan=function(h,d,c,e){if(d==null){d=database.getObject(h,"label");if(d==null){d=h}}var b=SimileAjax.DOM.createElementFromString('<a href="'+Exhibit.Persistence.getItemLink(h)+"\" class='exhibit-item'>"+d+"</a>");var g=function(i,a,k){Exhibit.UI.showItemInPopup(h,i,c)};SimileAjax.WindowManager.registerEvent(b,"click",g,e);return b};Exhibit.UI.makeValueSpan=function(b,e,c){var d=document.createElement("span");d.className="exhibit-value";if(e=="url"){var a=b;if(Exhibit.params.safe&&a.trim().startsWith("javascript:")){d.appendChild(document.createTextNode(a))}else{d.innerHTML='<a href="'+a+"\" target='_blank'>"+(b.length>50?b.substr(0,20)+" ... "+b.substr(b.length-20):b)+"</a>"}}else{if(Exhibit.params.safe){b=Exhibit.Formatter.encodeAngleBrackets(b)}d.innerHTML=b}return d};Exhibit.UI.showItemInPopup=function(g,c,b){var e=SimileAjax.DOM.getPageCoordinates(c);var a=document.createElement("div");var d=b.getLensRegistry().createLens(g,a,b);SimileAjax.Graphics.createBubbleForContentAndPoint(a,e.left+Math.round(c.offsetWidth/2),e.top+Math.round(c.offsetHeight/2),b.getSetting("bubbleWidth"))};Exhibit.UI.createButton=function(a,d,c){var b=document.createElement("button");b.className=(c||"exhibit-button")+" screen";b.innerHTML=a;if(d){SimileAjax.WindowManager.registerEvent(b,"click",d)}return b};Exhibit.UI.createPopupMenuDom=function(a){var c=document.createElement("div");c.className="exhibit-menu-popup exhibit-ui-protection";var b={elmt:c,close:function(){document.body.removeChild(this.elmt)},open:function(){var e=this;this.layer=SimileAjax.WindowManager.pushLayer(function(){e.close()},true,c);var g=document.body.offsetWidth;var d=document.body.offsetHeight;var h=SimileAjax.DOM.getPageCoordinates(a);c.style.top=(h.top+a.scrollHeight)+"px";c.style.right=(g-(h.left+a.scrollWidth))+"px";document.body.appendChild(this.elmt)},appendMenuItem:function(g,h,i){var e=this;var d=document.createElement("a");d.className="exhibit-menu-item";d.href="javascript:";SimileAjax.WindowManager.registerEvent(d,"click",function(m,l,n){i(m,l,n);SimileAjax.WindowManager.popLayer(e.layer);SimileAjax.DOM.cancelEvent(l);return false});var k=document.createElement("div");d.appendChild(k);k.appendChild(SimileAjax.Graphics.createTranslucentImage(h!=null?h:(Exhibit.urlPrefix+"images/blank-16x16.png")));k.appendChild(document.createTextNode(g));this.elmt.appendChild(d)},appendSeparator:function(){var d=document.createElement("hr");this.elmt.appendChild(d)}};return b};Exhibit.UI.createBusyIndicator=function(){var e=Exhibit.urlPrefix+"images/";var k=document.createElement("div");if(SimileAjax.Graphics.pngIsTranslucent){var l=document.createElement("div");l.style.height="33px";l.style.background="url("+e+"message-bubble/message-top-left.png) top left no-repeat";l.style.paddingLeft="44px";k.appendChild(l);var c=document.createElement("div");c.style.height="33px";c.style.background="url("+e+"message-bubble/message-top-right.png) top right no-repeat";l.appendChild(c);var i=document.createElement("div");i.style.background="url("+e+"message-bubble/message-left.png) top left repeat-y";i.style.paddingLeft="44px";k.appendChild(i);var a=document.createElement("div");a.style.background="url("+e+"message-bubble/message-right.png) top right repeat-y";a.style.paddingRight="44px";i.appendChild(a);var d=document.createElement("div");a.appendChild(d);var b=document.createElement("div");b.style.height="55px";b.style.background="url("+e+"message-bubble/message-bottom-left.png) bottom left no-repeat";b.style.paddingLeft="44px";k.appendChild(b);var h=document.createElement("div");h.style.height="55px";h.style.background="url("+e+"message-bubble/message-bottom-right.png) bottom right no-repeat";b.appendChild(h)}else{k.style.border="2px solid #7777AA";k.style.padding="20px";k.style.background="white";SimileAjax.Graphics.setOpacity(k,90);var d=document.createElement("div");k.appendChild(d)}k.className="exhibit-busyIndicator";d.className="exhibit-busyIndicator-content";var g=document.createElement("img");g.src=e+"progress-running.gif";d.appendChild(g);d.appendChild(document.createTextNode(" "+Exhibit.l10n.busyIndicatorMessage));return k};Exhibit.UI.createFocusDialogBox=function(c,a,e){var b={tag:"div",className:"exhibit-focusDialog exhibit-ui-protection",children:[{tag:"div",className:"exhibit-focusDialog-viewContainer",field:"viewContainer"},{tag:"div",className:"exhibit-focusDialog-controls",children:[{tag:"button",field:"closeButton",children:[Exhibit.l10n.focusDialogBoxCloseButtonLabel]}]}]};var d=SimileAjax.DOM.createDOMFromTemplate(b);d.close=function(){document.body.removeChild(d.elmt)};d.open=function(){d.layer=SimileAjax.WindowManager.pushLayer(function(){d.close()},false);var g=new Exhibit.Lens(c,d.viewContainer,a,e);d.elmt.style.top=(document.body.scrollTop+100)+"px";document.body.appendChild(d.elmt);SimileAjax.WindowManager.registerEvent(d.closeButton,"click",function(i,h,k){SimileAjax.WindowManager.popLayer(d.layer);SimileAjax.DOM.cancelEvent(h);return false},d.layer)};return d};Exhibit.UI.createTranslucentImage=function(a,b){return SimileAjax.Graphics.createTranslucentImage(Exhibit.urlPrefix+a,b)};Exhibit.UI.createTranslucentImageHTML=function(a,b){return SimileAjax.Graphics.createTranslucentImageHTML(Exhibit.urlPrefix+a,b)};Exhibit.HTMLView=function(c,a,b){this.html=b;this.view=this.moveChildNodes(b,c)};Exhibit.HTMLView.create=Exhibit.HTMLView.createFromDOM=function(c,b,a){return new Exhibit.HTMLView(b!=null?b:c,null,c)};Exhibit.HTMLView.prototype.dispose=function(){this.html=this.moveChildNodes(this.view,this.html);this.view=this.html=null};Exhibit.HTMLView.prototype.moveChildNodes=function(b,c){if(b===c){return c}var a=document.createDocumentFragment();while(b.firstChild){a.appendChild(b.firstChild)}c.appendChild(a);return c};Exhibit.OrderedViewFrame=function(a){this._uiContext=a;this._orders=null;this._possibleOrders=null;this._settings={}};Exhibit.OrderedViewFrame._settingSpecs={showAll:{type:"boolean",defaultValue:false},grouped:{type:"boolean",defaultValue:true},showDuplicates:{type:"boolean",defaultValue:false},abbreviatedCount:{type:"int",defaultValue:10},showHeader:{type:"boolean",defaultValue:true},showSummary:{type:"boolean",defaultValue:true},showControls:{type:"boolean",defaultValue:true},showFooter:{type:"boolean",defaultValue:true}};Exhibit.OrderedViewFrame.prototype.configure=function(a){if("orders" in a){this._orders=[];this._configureOrders(a.orders)}if("possibleOrders" in a){this._possibleOrders=[];this._configurePossibleOrders(a.possibleOrders)}Exhibit.SettingsUtilities.collectSettings(a,Exhibit.OrderedViewFrame._settingSpecs,this._settings);this._internalValidate()};Exhibit.OrderedViewFrame.prototype.configureFromDOM=function(a){var e=Exhibit.getAttribute(a,"orders",",");if(e!=null&&e.length>0){this._orders=[];this._configureOrders(e)}var g=Exhibit.getAttribute(a,"directions",",");if(g!=null&&g.length>0&&this._orders!=null){for(var d=0;d<g.length&&d<this._orders.length;d++){this._orders[d].ascending=(g[d].toLowerCase()!="descending")}}var b=Exhibit.getAttribute(a,"possibleOrders",",");if(b!=null&&b.length>0){this._possibleOrders=[];this._configurePossibleOrders(b)}var c=Exhibit.getAttribute(a,"possibleDirections",",");if(c!=null&&c.length>0&&this._possibleOrders!=null){for(var d=0;d<c.length&&d<this._possibleOrders.length;d++){this._possibleOrders.ascending=(c[d].toLowerCase()!="descending")}}Exhibit.SettingsUtilities.collectSettingsFromDOM(a,Exhibit.OrderedViewFrame._settingSpecs,this._settings);this._internalValidate()};Exhibit.OrderedViewFrame.prototype.dispose=function(){if(this._headerDom){this._headerDom.dispose();this._headerDom=null}if(this._footerDom){this._footerDom.dispose();this._footerDom=null}this._divHeader=null;this._divFooter=null;this._uiContext=null};Exhibit.OrderedViewFrame.prototype._internalValidate=function(){if(this._orders!=null&&this._orders.length==0){this._orders=null}if(this._possibleOrders!=null&&this._possibleOrders.length==0){this._possibleOrders=null}};Exhibit.OrderedViewFrame.prototype._configureOrders=function(c){for(var d=0;d<c.length;d++){var a=c[d];var l;var b=true;if(typeof a=="string"){l=a}else{if(typeof a=="object"){l=a.expression,b=("ascending" in a)?(a.ascending):true}else{SimileAjax.Debug.warn("Bad order object "+a);continue}}try{var k=Exhibit.ExpressionParser.parse(l);if(k.isPath()){var m=k.getPath();if(m.getSegmentCount()==1){var g=m.getSegment(0);this._orders.push({property:g.property,forward:g.forward,ascending:b})}}}catch(h){SimileAjax.Debug.warn("Bad order expression "+l)}}};Exhibit.OrderedViewFrame.prototype._configurePossibleOrders=function(a){for(var d=0;d<a.length;d++){var b=a[d];var l;var c=true;if(typeof b=="string"){l=b}else{if(typeof b=="object"){l=b.expression,c=("ascending" in b)?(b.ascending):true}else{SimileAjax.Debug.warn("Bad possible order object "+b);continue}}try{var k=Exhibit.ExpressionParser.parse(l);if(k.isPath()){var m=k.getPath();if(m.getSegmentCount()==1){var g=m.getSegment(0);this._possibleOrders.push({property:g.property,forward:g.forward,ascending:c})}}}catch(h){SimileAjax.Debug.warn("Bad possible order expression "+l)}}};Exhibit.OrderedViewFrame.prototype.initializeUI=function(){var a=this;if(this._settings.showHeader){this._headerDom=Exhibit.OrderedViewFrame.createHeaderDom(this._uiContext,this._divHeader,this._settings.showSummary,this._settings.showControls,function(c,b,d){a._openSortPopup(c,-1)},function(c,b,d){a._toggleGroup()})}if(this._settings.showFooter){this._footerDom=Exhibit.OrderedViewFrame.createFooterDom(this._uiContext,this._divFooter,function(c,b,d){a._setShowAll(true)},function(c,b,d){a._setShowAll(false)})}};Exhibit.OrderedViewFrame.prototype.reconstruct=function(){var n=this;var c=this._uiContext.getCollection();var k=this._uiContext.getDatabase();var d=c.countAllItems();var l=c.countRestrictedItems();var e=false;if(l>0){var g=c.getRestrictedItems();e=this._internalReconstruct(g);var m=[];var h=function(i,p){var q=k.getProperty(i.property);var o=q!=null?(i.forward?q.getPluralLabel():q.getReversePluralLabel()):(i.forward?i.property:"reverse of "+i.property);m.push(Exhibit.UI.makeActionLink(o,function(s,r,t){n._openSortPopup(s,p)}))};var a=this._getOrders();for(var b=0;b<a.length;b++){h(a[b],b)}if(this._settings.showHeader&&this._settings.showControls){this._headerDom.setOrders(m);this._headerDom.enableThenByAction(m.length<this._getPossibleOrders().length)}}if(this._settings.showHeader&&this._settings.showControls){this._headerDom.groupOptionWidget.setChecked(this._settings.grouped)}if(this._settings.showFooter){this._footerDom.setCounts(l,this._settings.abbreviatedCount,this._settings.showAll,!(e&&this._grouped))}};Exhibit.OrderedViewFrame.prototype._internalReconstruct=function(i){var n=this;var d=this._settings;var m=this._uiContext.getDatabase();var e=this._getOrders();var b=0;var k=false;var g=function(o){if((k&&d.grouped)||d.showAll||b<d.abbreviatedCount){n.onNewItem(o,b++)}};var l=function(p,q,o){if((k&&d.grouped)||d.showAll||b<d.abbreviatedCount){n.onNewGroup(p,q,o)}};var a=function(t,r){var o=e[r];var w=o.forward?m.getObjectsUnion(t,o.property):m.getSubjectsUnion(t,o.property);var q="text";if(o.forward){var v=m.getProperty(o.property);q=v!=null?v.getValueType():"text"}else{q="item"}var x=(q=="item"||q=="text")?c(t,r,w,q):h(t,r,w,q);var s=false;for(var p=0;p<x.length;p++){if(x[p].items.size()>1){s=true}}if(s){k=true}for(var p=0;p<x.length;p++){var u=x[p];if(u.items.size()>0){if(s&&d.grouped){l(u.display,q,r)}t.removeSet(u.items);if(u.items.size()>1&&r<e.length-1){a(u.items,r+1)}else{u.items.visit(g)}}}if(t.size()>0){if(s&&d.grouped){l(Exhibit.l10n.missingSortKey,q,r)}if(t.size()>1&&r<e.length-1){a(t,r+1)}else{t.visit(g)}}};var c=function(s,r,v,q){var w=[];var t;var x;var o=e[r];if(q=="item"){v.visit(function(z){var y=m.getObject(z,"label");y=y!=null?y:z;w.push({itemID:z,display:y})});t=function(z,y){var A=z.display.localeCompare(y.display);return A!=0?A:z.itemID.localeCompare(y.itemID)};x=o.forward?function(y){return m.getSubjects(y.itemID,o.property,null,s)}:function(y){return m.getObjects(y.itemID,o.property,null,s)}}else{v.visit(function(y){w.push({display:y})});t=function(z,y){return z.display.localeCompare(y.display)};x=o.forward?function(y){return m.getSubjects(y.display,o.property,null,s)}:function(y){return m.getObjects(y.display,o.property,null,s)}}w.sort(function(z,y){return(o.ascending?1:-1)*t(z,y)});for(var p=0;p<w.length;p++){var u=w[p];u.items=x(u);if(!d.showDuplicates){s.removeSet(u.items)}}return w};var h=function(t,r,y,q){var z=[];var s={};var o=e[r];var u;if(q=="number"){u=function(v){if(typeof v=="number"){return v}else{try{return parseFloat(v)}catch(A){return null}}}}else{u=function(v){if(v instanceof Date){return v.getTime()}else{try{return SimileAjax.DateTime.parseIso8601DateTime(v.toString()).getTime()}catch(A){return null}}}}y.visit(function(B){var A=u(B);if(A!=null){var v=s[A];if(!v){v={sortkey:A,display:B,values:[],items:new Exhibit.Set()};s[A]=v;z.push(v)}v.values.push(B)}});z.sort(function(A,v){return(o.ascending?1:-1)*(A.sortkey-v.sortkey)});for(var p=0;p<z.length;p++){var x=z[p];var y=x.values;for(var w=0;w<y.length;w++){if(o.forward){m.getSubjects(y[w],o.property,x.items,t)}else{m.getObjects(y[w],o.property,x.items,t)}}if(!d.showDuplicates){t.removeSet(x.items)}}return z};a(i,0);return k};Exhibit.OrderedViewFrame.prototype._getOrders=function(){return this._orders||[this._getPossibleOrders()[0]]};Exhibit.OrderedViewFrame.prototype._getPossibleOrders=function(){var a=null;if(this._possibleOrders==null){a=this._uiContext.getDatabase().getAllProperties();for(var b=0,c;c=a[b];b++){a[b]={ascending:true,forward:true,property:c}}}else{a=[].concat(this._possibleOrders)}if(a.length==0){a.push({property:"label",forward:true,ascending:true})}return a};Exhibit.OrderedViewFrame.prototype._openSortPopup=function(h,e){var m=this;var k=this._uiContext.getDatabase();var v=Exhibit.UI.createPopupMenuDom(h);var n=this._getOrders();if(e>=0){var q=n[e];var d=k.getProperty(q.property);var l=q.forward?d.getPluralLabel():d.getReversePluralLabel();var s=q.forward?d.getValueType():"item";var c=Exhibit.Database.l10n.sortLabels[s];c=(c!=null)?c:Exhibit.Database.l10n.sortLabels.text;v.appendMenuItem(c.ascending,Exhibit.urlPrefix+(q.ascending?"images/option-check.png":"images/option.png"),q.ascending?function(){}:function(){m._reSort(e,q.property,q.forward,true,false)});v.appendMenuItem(c.descending,Exhibit.urlPrefix+(q.ascending?"images/option.png":"images/option-check.png"),q.ascending?function(){m._reSort(e,q.property,q.forward,false,false)}:function(){});if(n.length>1){v.appendSeparator();v.appendMenuItem(Exhibit.OrderedViewFrame.l10n.removeOrderLabel,null,function(){m._removeOrder(e)})}}var a=[];var b=this._getPossibleOrders();for(r=0;r<b.length;r++){var g=b[r];var o=false;for(var p=(e<0)?n.length-1:e;p>=0;p--){var t=n[p];if(t.property==g.property&&t.forward==g.forward){o=true;break}}if(!o){var d=k.getProperty(g.property);a.push({property:g.property,forward:g.forward,ascending:g.ascending,label:g.forward?d.getPluralLabel():d.getReversePluralLabel()})}}if(a.length>0){if(e>=0){v.appendSeparator()}a.sort(function(w,i){return w.label.localeCompare(i.label)});var u=function(i){v.appendMenuItem(i.label,null,function(){m._reSort(e,i.property,i.forward,i.ascending,true)})};for(var r=0;r<a.length;r++){u(a[r])}}v.open()};Exhibit.OrderedViewFrame.prototype._reSort=function(i,m,h,b,k){var d=this._getOrders();i=(i<0)?d.length:i;var g=d.slice(0,i);g.push({property:m,forward:h,ascending:b});if(!k){g=g.concat(d.slice(i+1))}var l=this._uiContext.getDatabase().getProperty(m);var a=h?l.getPluralLabel():l.getReversePluralLabel();var c=h?l.getValueType():"item";var e=Exhibit.Database.l10n.sortLabels[c];e=(e!=null)?e:Exhibit.Database.l10n.sortLabels.text;var n=this;SimileAjax.History.addLengthyAction(function(){n._orders=g;n.parentReconstruct()},function(){n._orders=d;n.parentReconstruct()},Exhibit.OrderedViewFrame.l10n.formatSortActionTitle(a,b?e.ascending:e.descending))};Exhibit.OrderedViewFrame.prototype._removeOrder=function(h){var d=this._getOrders();var g=d.slice(0,h).concat(d.slice(h+1));var a=d[h];var i=this._uiContext.getDatabase().getProperty(a.property);var b=a.forward?i.getPluralLabel():i.getReversePluralLabel();var c=a.forward?i.getValueType():"item";var e=Exhibit.Database.l10n.sortLabels[c];e=(e!=null)?e:Exhibit.Database.l10n.sortLabels.text;var k=this;SimileAjax.History.addLengthyAction(function(){k._orders=g;k.parentReconstruct()},function(){k._orders=d;k.parentReconstruct()},Exhibit.OrderedViewFrame.l10n.formatRemoveOrderActionTitle(b,a.ascending?e.ascending:e.descending))};Exhibit.OrderedViewFrame.prototype._setShowAll=function(b){var a=this;var c=this._settings;SimileAjax.History.addLengthyAction(function(){c.showAll=b;a.parentReconstruct()},function(){c.showAll=!b;a.parentReconstruct()},Exhibit.OrderedViewFrame.l10n[b?"showAllActionTitle":"dontShowAllActionTitle"])};Exhibit.OrderedViewFrame.prototype._toggleGroup=function(){var c=this._settings;var b=c.grouped;var a=this;SimileAjax.History.addLengthyAction(function(){c.grouped=!b;a.parentReconstruct()},function(){c.grouped=b;a.parentReconstruct()},Exhibit.OrderedViewFrame.l10n[b?"ungroupAsSortedActionTitle":"groupAsSortedActionTitle"])};Exhibit.OrderedViewFrame.prototype._toggleShowDuplicates=function(){var c=this._settings;var b=c.showDuplicates;var a=this;SimileAjax.History.addLengthyAction(function(){c.showDuplicates=!b;a.parentReconstruct()},function(){c.showDuplicates=b;a.parentReconstruct()},Exhibit.OrderedViewFrame.l10n[b?"hideDuplicatesActionTitle":"showDuplicatesActionTitle"])};Exhibit.OrderedViewFrame.headerTemplate="<div id='collectionSummaryDiv' style='display: none;'></div><div class='exhibit-collectionView-header-sortControls' style='display: none;' id='controlsDiv'>%0<span class='exhibit-collectionView-header-groupControl'> \u2022 <a id='groupOption' class='exhibit-action'></a></span></div>";Exhibit.OrderedViewFrame.createHeaderDom=function(d,h,g,c,e,a){var k=Exhibit.OrderedViewFrame.l10n;var i=String.substitute(Exhibit.OrderedViewFrame.headerTemplate,[k.sortingControlsTemplate]);var b=SimileAjax.DOM.createDOMFromString(h,i,{});h.className="exhibit-collectionView-header";if(g){b.collectionSummaryDiv.style.display="block";b.collectionSummaryWidget=Exhibit.CollectionSummaryWidget.create({},b.collectionSummaryDiv,d)}if(c){b.controlsDiv.style.display="block";b.groupOptionWidget=Exhibit.OptionWidget.create({label:k.groupedAsSortedOptionLabel,onToggle:a},b.groupOption,d);SimileAjax.WindowManager.registerEvent(b.thenSortByAction,"click",e);b.enableThenByAction=function(l){Exhibit.UI.enableActionLink(b.thenSortByAction,l)};b.setOrders=function(n){b.ordersSpan.innerHTML="";var l=Exhibit.Formatter.createListDelimiter(b.ordersSpan,n.length,d);for(var m=0;m<n.length;m++){l();b.ordersSpan.appendChild(n[m])}l()}}b.dispose=function(){if("collectionSummaryWidget" in b){b.collectionSummaryWidget.dispose();b.collectionSummaryWidget=null}b.groupOptionWidget.dispose();b.groupOptionWidget=null};return b};Exhibit.OrderedViewFrame.footerTemplate="<span id='showAllSpan'></span>";Exhibit.OrderedViewFrame.createFooterDom=function(a,e,d,b){var c=Exhibit.OrderedViewFrame.l10n;var g=SimileAjax.DOM.createDOMFromString(e,Exhibit.OrderedViewFrame.footerTemplate,{});e.className="exhibit-collectionView-footer";g.setCounts=function(k,i,h,l){g.showAllSpan.innerHTML="";if(l&&k>i){if(h){g.showAllSpan.appendChild(Exhibit.UI.makeActionLink(c.formatDontShowAll(i),b))}else{g.showAllSpan.appendChild(Exhibit.UI.makeActionLink(c.formatShowAll(k),d))}}};g.dispose=function(){};return g};Exhibit.TabularView=function(c,b){this._div=c;this._uiContext=b;this._settings={rowStyler:null,tableStyler:null};this._columns=[];this._rowTemplate=null;var a=this;this._listener={onItemsChanged:function(){a._reconstruct()}};b.getCollection().addListener(this._listener)};Exhibit.TabularView._settingSpecs={sortAscending:{type:"boolean",defaultValue:true},sortColumn:{type:"int",defaultValue:0},showSummary:{type:"boolean",defaultValue:true},showToolbox:{type:"boolean",defaultValue:true},border:{type:"int",defaultValue:1},cellPadding:{type:"int",defaultValue:5},cellSpacing:{type:"int",defaultValue:3}};Exhibit.TabularView.create=function(d,c,b){var a=new Exhibit.TabularView(c,Exhibit.UIContext.create(d,b));Exhibit.TabularView._configure(a,d);a._internalValidate();a._initializeUI();return a};Exhibit.TabularView.createFromDOM=function(configElmt,containerElmt,uiContext){var configuration=Exhibit.getConfigurationFromDOM(configElmt);uiContext=Exhibit.UIContext.createFromDOM(configElmt,uiContext);var view=new Exhibit.TabularView(containerElmt!=null?containerElmt:configElmt,uiContext);Exhibit.SettingsUtilities.collectSettingsFromDOM(configElmt,Exhibit.TabularView._settingSpecs,view._settings);try{var expressions=[];var labels=Exhibit.getAttribute(configElmt,"columnLabels",",")||[];var s=Exhibit.getAttribute(configElmt,"columns");if(s!=null&&s.length>0){expressions=Exhibit.ExpressionParser.parseSeveral(s)}for(var i=0;i<expressions.length;i++){var expression=expressions[i];view._columns.push({expression:expression,uiContext:Exhibit.UIContext.create({},view._uiContext,true),styler:null,label:i<labels.length?labels[i]:null,format:"list"})}var formats=Exhibit.getAttribute(configElmt,"columnFormats");if(formats!=null&&formats.length>0){var index=0;var startPosition=0;while(index<view._columns.length&&startPosition<formats.length){var column=view._columns[index];var o={};column.format=Exhibit.FormatParser.parseSeveral(column.uiContext,formats,startPosition,o);startPosition=o.index;while(startPosition<formats.length&&" \t\r\n".indexOf(formats.charAt(startPosition))>=0){startPosition++}if(startPosition<formats.length&&formats.charAt(startPosition)==","){startPosition++}index++}}var tables=configElmt.getElementsByTagName("table");if(tables.length>0&&tables[0].rows.length>0){view._rowTemplate=Exhibit.Lens.compileTemplate(tables[0].rows[0],false,uiContext)}}catch(e){SimileAjax.Debug.exception(e,"TabularView: Error processing configuration of tabular view")}var s=Exhibit.getAttribute(configElmt,"rowStyler");if(s!=null&&s.length>0){var f=eval(s);if(typeof f=="function"){view._settings.rowStyler=f}}s=Exhibit.getAttribute(configElmt,"tableStyler");if(s!=null&&s.length>0){f=eval(s);if(typeof f=="function"){view._settings.tableStyler=f}}Exhibit.TabularView._configure(view,configuration);view._internalValidate();view._initializeUI();return view};Exhibit.TabularView._configure=function(g,a){Exhibit.SettingsUtilities.collectSettings(a,Exhibit.TabularView._settingSpecs,g._settings);if("columns" in a){var c=a.columns;for(var d=0;d<c.length;d++){var b=c[d];var l;var n=null;var h=null;var k=null;if(typeof b=="string"){l=b}else{l=b.expression;n=b.styler;h=b.label;k=b.format}var e=Exhibit.ExpressionParser.parse(l);if(e.isPath()){var m=e.getPath();if(k!=null&&k.length>0){k=Exhibit.FormatParser.parse(g._uiContext,k,0)}else{k="list"}g._columns.push({expression:e,styler:n,label:h,format:k})}}}if("rowStyler" in a){g._settings.rowStyler=a.rowStyler}if("tableStyler" in a){g._settings.tableStyler=a.tableStyler}};Exhibit.TabularView.prototype._internalValidate=function(){if(this._columns.length==0){var b=this._uiContext.getDatabase();var d=b.getAllProperties();for(var a=0;a<d.length;a++){var c=d[a];if(c!="uri"){this._columns.push({expression:Exhibit.ExpressionParser.parse("."+c),styler:null,label:b.getProperty(c).getLabel(),format:"list"})}}}this._settings.sortColumn=Math.max(0,Math.min(this._settings.sortColumn,this._columns.length-1))};Exhibit.TabularView.prototype.dispose=function(){this._uiContext.getCollection().removeListener(this._listener);if(this._toolboxWidget){this._toolboxWidget.dispose();this._toolboxWidget=null}this._collectionSummaryWidget.dispose();this._collectionSummaryWidget=null;this._uiContext.dispose();this._uiContext=null;this._div.innerHTML="";this._dom=null;this._div=null};Exhibit.TabularView.prototype._initializeUI=function(){var a=this;this._div.innerHTML="";this._dom=Exhibit.TabularView.createDom(this._div);this._collectionSummaryWidget=Exhibit.CollectionSummaryWidget.create({},this._dom.collectionSummaryDiv,this._uiContext);if(this._settings.showToolbox){this._toolboxWidget=Exhibit.ToolboxWidget.createFromDOM(this._div,this._div,this._uiContext);this._toolboxWidget.getGeneratedHTML=function(){return a._dom.bodyDiv.innerHTML}}if(!this._settings.showSummary){this._dom.collectionSummaryDiv.style.display="none"}this._reconstruct()};Exhibit.TabularView.prototype._reconstruct=function(){var p=this;var e=this._uiContext.getCollection();var n=this._uiContext.getDatabase();var b=this._dom.bodyDiv;b.innerHTML="";var h=[];var g=e.countAllItems();if(g>0){var l=e.getRestrictedItems();l.visit(function(i){h.push({id:i,sortKey:""})})}if(h.length>0){var a=this._columns[this._settings.sortColumn];h.sort(this._createSortFunction(h,a.expression,this._settings.sortAscending));var o=document.createElement("table");o.className="exhibit-tabularView-body";if(this._settings.tableStyler!=null){this._settings.tableStyler(o,n)}else{o.cellSpacing=this._settings.cellSpacing;o.cellPadding=this._settings.cellPadding;o.border=this._settings.border}var k=o.insertRow(0);var m=function(q){var r=p._columns[q];if(r.label==null){r.label=p._getColumnLabel(r.expression)}var s=document.createElement("th");Exhibit.TabularView.createColumnHeader(exhibit,s,r.label,q==p._settings.sortColumn,p._settings.sortAscending,function(t,i,u){p._doSort(q);SimileAjax.DOM.cancelEvent(i);return false});k.appendChild(s)};for(var d=0;d<this._columns.length;d++){m(d)}var c;if(this._rowTemplate!=null){c=function(q){var r=h[q];var s=Exhibit.Lens.constructFromLensTemplate(r.id,p._rowTemplate,o,p._uiContext);if(p._settings.rowStyler!=null){p._settings.rowStyler(r.id,n,s,q)}}}else{c=function(r){var t=h[r];var u=o.insertRow(o.rows.length);for(var x=0;x<p._columns.length;x++){var s=p._columns[x];var w=u.insertCell(x);var q=s.expression.evaluate({value:t.id},{value:"item"},"value",n);var v=s.format=="list"?q.valueType:s.format;s.uiContext.formatList(q.values,q.size,v,function(i){w.appendChild(i)});if(s.styler!=null){s.styler(t.id,n,w)}}if(p._settings.rowStyler!=null){p._settings.rowStyler(t.id,n,u,r)}}}for(var d=0;d<h.length;d++){c(d)}b.appendChild(o)}};Exhibit.TabularView.prototype._getColumnLabel=function(g){var c=this._uiContext.getDatabase();var e=g.getPath();var a=e.getSegment(e.getSegmentCount()-1);var d=a.property;var b=c.getProperty(d);if(b!=null){return a.forward?b.getLabel():b.getReverseLabel()}else{return d}};Exhibit.TabularView.prototype._createSortFunction=function(k,h,c){var o=this._uiContext.getDatabase();var b=c?1:-1;var m=function(r,i){return b*(r.sortKey-i.sortKey)};var s=function(r,i){return b*r.sortKey.localeCompare(i.sortKey)};var l=[];var g={};for(var e=0;e<k.length;e++){var q=k[e];var a=h.evaluate({value:q.id},{value:"item"},"value",o);a.values.visit(function(i){q.sortKey=i});if(!(a.valueType in g)){g[a.valueType]=true;l.push(a.valueType)}}var d="text";if(l.length==1){d=l[0]}else{d="text"}var p;var n;if(d=="number"){n=m;p=function(i){if(i==null){return Number.NEGATIVE_INFINITY}else{if(typeof i=="number"){return i}else{var r=parseFloat(i);if(isNaN(r)){return Number.NEGATIVE_INFINITY}else{return r}}}}}else{if(d=="date"){n=m;p=function(i){if(i==null){return Number.NEGATIVE_INFINITY}else{if(i instanceof Date){return i.getTime()}else{try{return SimileAjax.DateTime.parseIso8601DateTime(i).getTime()}catch(r){return Number.NEGATIVE_INFINITY}}}}}else{if(d=="boolean"){n=m;p=function(i){if(i==null){return Number.NEGATIVE_INFINITY}else{if(typeof i=="boolean"){return i?1:0}else{return i.toString().toLowerCase()=="true"}}}}else{if(d=="item"){n=s;p=function(i){if(i==null){return Exhibit.l10n.missingSortKey}else{var r=o.getObject(i,"label");return(r==null)?i:r}}}else{n=s;p=function(i){if(i==null){return Exhibit.l10n.missingSortKey}else{return i.toString()}}}}}}for(var e=0;e<k.length;e++){var q=k[e];q.sortKey=p(q.sortKey)}return n};Exhibit.TabularView.prototype._doSort=function(g){var b=this._settings.sortColumn;var h=this._settings.sortAscending;var e=g;var a=b==e?!h:true;var d=this._settings;var c=this;SimileAjax.History.addLengthyAction(function(){d.sortColumn=e;d.sortAscending=a;c._reconstruct()},function(){d.sortColumn=b;d.sortAscending=h;c._reconstruct()},Exhibit.TabularView.l10n.makeSortActionTitle(this._columns[g].label,a))};Exhibit.TabularView._constructDefaultValueList=function(b,d,c,a){a.formatList(b,b.size(),d,function(e){c.appendChild(e)})};Exhibit.TabularView.createDom=function(c){var a=Exhibit.TabularView.l10n;var b={elmt:c,className:"exhibit-collectionView-header",children:[{tag:"div",field:"collectionSummaryDiv"},{tag:"div",field:"bodyDiv"}]};return SimileAjax.DOM.createDOMFromTemplate(b)};Exhibit.TabularView.createColumnHeader=function(h,a,e,c,d,i){var k=Exhibit.TabularView.l10n;var g={elmt:a,className:c?"exhibit-tabularView-columnHeader-sorted":"exhibit-tabularView-columnHeader",title:c?k.columnHeaderReSortTooltip:k.columnHeaderSortTooltip,children:[e]};if(c){g.children.push({elmt:Exhibit.UI.createTranslucentImage(d?"images/up-arrow.png":"images/down-arrow.png")})}SimileAjax.WindowManager.registerEvent(a,"click",i,null);var b=SimileAjax.DOM.createDOMFromTemplate(g);return b};Exhibit.TemplateView=function(c,b){this._div=c;this._uiContext=b;this._settings={tempate:null,lenses:null};var a=this;this._listener={onItemsChanged:function(){a._reconstruct()}};b.getCollection().addListener(this._listener)};Exhibit.TemplateView._settingSpecs={showToolbox:{type:"boolean",defaultValue:true},showSummary:{type:"boolean",defaultValue:true},slotIDPrefix:{type:"text",defaultValue:""},slotKey:{type:"text",defaultValue:null},slotClass:{type:"text",defaultValue:null}};Exhibit.TemplateView.create=function(d,c,b){var a=new Exhibit.TemplateView(c,Exhibit.UIContext.create(d,b));Exhibit.TemplateView._configure(a,d);a._initializeUI();return a};Exhibit.TemplateView.createFromDOM=function(configElmt,containerElmt,uiContext){var configuration=Exhibit.getConfigurationFromDOM(configElmt);uiContext=Exhibit.UIContext.createFromDOM(configElmt,uiContext);var view=new Exhibit.TemplateView(containerElmt!=null?containerElmt:configElmt,uiContext);Exhibit.SettingsUtilities.collectSettingsFromDOM(configElmt,Exhibit.TemplateView._settingSpecs,view._settings);var s=Exhibit.getAttribute(configElmt,"template");if(s!=null&&s.length>0){var o=eval(s);if(typeof o=="object"){view._settings.template=o}}s=Exhibit.getAttribute(configElmt,"lenses");if(s!=null&&s.length>0){o=eval(s);if(typeof o=="object"){view._settings.lenses={};for(var lensType in o){var template=o[lensType];var templateResult=SimileAjax.DOM.createDOMFromTemplate(template);view._settings.lenses[lensType]=Exhibit.Lens.compileTemplate(templateResult.elmt,false,uiContext)}}}Exhibit.TemplateView._configure(view,configuration);view._initializeUI();return view};Exhibit.TemplateView._configure=function(a,b){Exhibit.SettingsUtilities.collectSettings(b,Exhibit.TemplateView._settingSpecs,a._settings);if("template" in b){a._settings.template=b.template}if("lenses" in b){a._settings.lenses=b.lenses}};Exhibit.TemplateView.prototype.dispose=function(){this._uiContext.getCollection().removeListener(this._listener);if(this._toolboxWidget){this._toolboxWidget.dispose();this._toolboxWidget=null}this._collectionSummaryWidget.dispose();this._collectionSummaryWidget=null;this._uiContext.dispose();this._uiContext=null;this._div.innerHTML="";this._dom=null;this._div=null};Exhibit.TemplateView.prototype._initializeUI=function(){var a=this;this._div.innerHTML="";this._dom=Exhibit.TemplateView.createDom(this._div,this._settings.template);this._collectionSummaryWidget=Exhibit.CollectionSummaryWidget.create({},this._dom.collectionSummaryDiv,this._uiContext);if(this._settings.showToolbox){this._toolboxWidget=Exhibit.ToolboxWidget.createFromDOM(this._div,this._div,this._uiContext);this._toolboxWidget.getGeneratedHTML=function(){return a._dom.bodyDiv.innerHTML}}if(!this._settings.showSummary){this._dom.collectionSummaryDiv.style.display="none"}this._reconstruct()};Exhibit.TemplateView.prototype._reconstruct=function(){var a=this;var e=this._uiContext.getCollection();var d=this._uiContext.getDatabase();var c=this._dom.bodyDiv;$("."+this._settings.slotClass).html("");if(e.countRestrictedItems()>0){var b=e.getRestrictedItems();b.visit(function(i){var k=d.getObject(i,a._settings.slotKey);var h=document.getElementById(a._settings.slotIDPrefix+k);var g=a._settings.lenses[k];if(!g){g=a._settings.lenses["*"]}if(h!=null&&g!=null){Exhibit.Lens.constructFromLensTemplate(i,g,h,a._uiContext)}})}};Exhibit.TemplateView.createDom=function(e,c){var b=Exhibit.TemplateView.l10n;var a=SimileAjax.DOM.createDOMFromTemplate(c);var d={elmt:e,className:"exhibit-collectionView-header",children:[{tag:"div",field:"collectionSummaryDiv"},{elmt:a.elmt,field:"bodyDiv"}]};return SimileAjax.DOM.createDOMFromTemplate(d)};Exhibit.ThumbnailView=function(c,b){this._div=c;this._uiContext=b;this._settings={};var a=this;this._listener={onItemsChanged:function(){a._reconstruct()}};b.getCollection().addListener(this._listener);this._orderedViewFrame=new Exhibit.OrderedViewFrame(b);this._orderedViewFrame.parentReconstruct=function(){a._reconstruct()}};Exhibit.ThumbnailView._settingSpecs={showToolbox:{type:"boolean",defaultValue:true}};Exhibit.ThumbnailView.create=function(d,c,b){var a=new Exhibit.ThumbnailView(c,Exhibit.UIContext.create(d,b,true));a._lensRegistry=Exhibit.UIContext.createLensRegistry(d,b.getLensRegistry());Exhibit.SettingsUtilities.collectSettings(d,Exhibit.ThumbnailView._settingSpecs,a._settings);a._orderedViewFrame.configure(d);a._initializeUI();return a};Exhibit.ThumbnailView.createFromDOM=function(d,c,b){var e=Exhibit.getConfigurationFromDOM(d);var a=new Exhibit.ThumbnailView(c!=null?c:d,Exhibit.UIContext.createFromDOM(d,b,true));a._lensRegistry=Exhibit.UIContext.createLensRegistryFromDOM(d,e,b.getLensRegistry());Exhibit.SettingsUtilities.collectSettingsFromDOM(d,Exhibit.ThumbnailView._settingSpecs,a._settings);Exhibit.SettingsUtilities.collectSettings(e,Exhibit.ThumbnailView._settingSpecs,a._settings);a._orderedViewFrame.configureFromDOM(d);a._orderedViewFrame.configure(e);a._initializeUI();return a};Exhibit.ThumbnailView.prototype.dispose=function(){this._uiContext.getCollection().removeListener(this._listener);if(this._toolboxWidget){this._toolboxWidget.dispose();this._toolboxWidget=null}this._orderedViewFrame.dispose();this._orderedViewFrame=null;this._lensRegistry=null;this._dom=null;this._div.innerHTML="";this._div=null;this._uiContext=null};Exhibit.ThumbnailView.prototype._initializeUI=function(){var a=this;this._div.innerHTML="";var b={elmt:this._div,children:[{tag:"div",field:"headerDiv"},{tag:"div",className:"exhibit-collectionView-body",field:"bodyDiv"},{tag:"div",field:"footerDiv"}]};this._dom=SimileAjax.DOM.createDOMFromTemplate(b);if(this._settings.showToolbox){this._toolboxWidget=Exhibit.ToolboxWidget.createFromDOM(this._div,this._div,this._uiContext);this._toolboxWidget.getGeneratedHTML=function(){return a._dom.bodyDiv.innerHTML}}this._orderedViewFrame._divHeader=this._dom.headerDiv;this._orderedViewFrame._divFooter=this._dom.footerDiv;this._orderedViewFrame._generatedContentElmtRetriever=function(){return a._dom.bodyDiv};this._orderedViewFrame.initializeUI();this._reconstruct()};Exhibit.ThumbnailView.prototype._reconstruct=function(){var a=this;var b={div:this._dom.bodyDiv,itemContainer:null,groupDoms:[],groupCounts:[]};var c=function(d){for(var e=d;e<b.groupDoms.length;e++){b.groupDoms[e].countSpan.innerHTML=b.groupCounts[e]}b.groupDoms=b.groupDoms.slice(0,d);b.groupCounts=b.groupCounts.slice(0,d);if(d>0){b.div=b.groupDoms[d-1].contentDiv}else{b.div=a._dom.bodyDiv}b.itemContainer=null};this._orderedViewFrame.onNewGroup=function(d,h,e){c(e);var g=Exhibit.ThumbnailView.constructGroup(e,d);b.div.appendChild(g.elmt);b.div=g.contentDiv;b.groupDoms.push(g);b.groupCounts.push(0)};this._orderedViewFrame.onNewItem=function(k,e){if(b.itemContainer==null){b.itemContainer=Exhibit.ThumbnailView.constructItemContainer();b.div.appendChild(b.itemContainer)}for(var g=0;g<b.groupCounts.length;g++){b.groupCounts[g]++}var d=document.createElement("div");d.className=SimileAjax.Platform.browser.isIE?"exhibit-thumbnailView-itemContainer-IE":"exhibit-thumbnailView-itemContainer";var h=a._lensRegistry.createLens(k,d,a._uiContext);b.itemContainer.appendChild(d)};this._div.style.display="none";this._dom.bodyDiv.innerHTML="";this._orderedViewFrame.reconstruct();c(0);this._div.style.display="block"};Exhibit.ThumbnailView.constructGroup=function(b,a){var c=Exhibit.ThumbnailView.l10n;var d={tag:"div",className:"exhibit-thumbnailView-group",children:[{tag:"h"+(b+1),children:[a,{tag:"span",className:"exhibit-collectionView-group-count",children:[" (",{tag:"span",field:"countSpan"},")"]}],field:"header"},{tag:"div",className:"exhibit-collectionView-group-content",field:"contentDiv"}]};return SimileAjax.DOM.createDOMFromTemplate(d)};Exhibit.ThumbnailView.constructItemContainer=function(){var a=document.createElement("div");a.className="exhibit-thumbnailView-body";return a};Exhibit.TileView=function(c,b){this._div=c;this._uiContext=b;this._settings={};var a=this;this._listener={onItemsChanged:function(){a._reconstruct()}};b.getCollection().addListener(this._listener);this._orderedViewFrame=new Exhibit.OrderedViewFrame(b);this._orderedViewFrame.parentReconstruct=function(){a._reconstruct()}};Exhibit.TileView._settingSpecs={showToolbox:{type:"boolean",defaultValue:true}};Exhibit.TileView.create=function(d,c,b){var a=new Exhibit.TileView(c,Exhibit.UIContext.create(d,b));Exhibit.SettingsUtilities.collectSettings(d,Exhibit.TileView._settingSpecs,a._settings);a._orderedViewFrame.configure(d);a._initializeUI();return a};Exhibit.TileView.createFromDOM=function(d,c,b){var e=Exhibit.getConfigurationFromDOM(d);var a=new Exhibit.TileView(c!=null?c:d,Exhibit.UIContext.createFromDOM(d,b));Exhibit.SettingsUtilities.collectSettingsFromDOM(d,Exhibit.TileView._settingSpecs,a._settings);Exhibit.SettingsUtilities.collectSettings(e,Exhibit.TileView._settingSpecs,a._settings);a._orderedViewFrame.configureFromDOM(d);a._orderedViewFrame.configure(e);a._initializeUI();return a};Exhibit.TileView.prototype.dispose=function(){this._uiContext.getCollection().removeListener(this._listener);this._div.innerHTML="";if(this._toolboxWidget){this._toolboxWidget.dispose();this._toolboxWidget=null}this._orderedViewFrame.dispose();this._orderedViewFrame=null;this._dom=null;this._div=null;this._uiContext=null};Exhibit.TileView.prototype._initializeUI=function(){var a=this;this._div.innerHTML="";var b={elmt:this._div,children:[{tag:"div",field:"headerDiv"},{tag:"div",className:"exhibit-collectionView-body",field:"bodyDiv"},{tag:"div",field:"footerDiv"}]};this._dom=SimileAjax.DOM.createDOMFromTemplate(b);if(this._settings.showToolbox){this._toolboxWidget=Exhibit.ToolboxWidget.createFromDOM(this._div,this._div,this._uiContext);this._toolboxWidget.getGeneratedHTML=function(){return a._dom.bodyDiv.innerHTML}}this._orderedViewFrame._divHeader=this._dom.headerDiv;this._orderedViewFrame._divFooter=this._dom.footerDiv;this._orderedViewFrame._generatedContentElmtRetriever=function(){return a._dom.bodyDiv};this._orderedViewFrame.initializeUI();this._reconstruct()};Exhibit.TileView.prototype._reconstruct=function(){var a=this;var b={div:this._dom.bodyDiv,contents:null,groupDoms:[],groupCounts:[]};var c=function(d){for(var e=d;e<b.groupDoms.length;e++){b.groupDoms[e].countSpan.innerHTML=b.groupCounts[e]}b.groupDoms=b.groupDoms.slice(0,d);b.groupCounts=b.groupCounts.slice(0,d);if(d>0){b.div=b.groupDoms[d-1].contentDiv}else{b.div=a._dom.bodyDiv}b.contents=null};this._orderedViewFrame.onNewGroup=function(d,h,e){c(e);var g=Exhibit.TileView.constructGroup(e,d);b.div.appendChild(g.elmt);b.div=g.contentDiv;b.groupDoms.push(g);b.groupCounts.push(0)};this._orderedViewFrame.onNewItem=function(k,d){if(b.contents==null){b.contents=Exhibit.TileView.constructList();b.div.appendChild(b.contents)}for(var e=0;e<b.groupCounts.length;e++){b.groupCounts[e]++}var h=document.createElement("li");var g=a._uiContext.getLensRegistry().createLens(k,h,a._uiContext);b.contents.appendChild(h)};this._div.style.display="none";this._dom.bodyDiv.innerHTML="";this._orderedViewFrame.reconstruct();c(0);this._div.style.display="block"};Exhibit.TileView.constructGroup=function(b,a){var c={tag:"div",className:"exhibit-collectionView-group",children:[{tag:"h"+(b+1),children:[a,{tag:"span",className:"exhibit-collectionView-group-count",children:[" (",{tag:"span",field:"countSpan"},")"]}],field:"header"},{tag:"div",className:"exhibit-collectionView-group-content",field:"contentDiv"}]};return SimileAjax.DOM.createDOMFromTemplate(c)};Exhibit.TileView.constructList=function(){var a=document.createElement("ol");a.className="exhibit-tileView-body";return a};Exhibit.ViewPanel=function(b,a){this._uiContext=a;this._div=b;this._viewConstructors=[];this._viewConfigs=[];this._viewLabels=[];this._viewTooltips=[];this._viewDomConfigs=[];this._viewIDs=[];this._viewIndex=0;this._view=null};Exhibit.ViewPanel.create=function(c,a,d){var e=new Exhibit.ViewPanel(a,d);if("views" in c){for(var g=0;g<c.views.length;g++){var h=c.views[g];var k=("viewClass" in view)?view.viewClass:Exhibit.TileView;if(typeof k=="string"){k=Exhibit.UI.viewClassNameToViewClass(k)}var l=null;if("viewLabel" in h){l=h.viewLabel}else{if("label" in h){l=h.label}else{if("l10n" in k&&"viewLabel" in k.l10n){l=k.l10n.viewLabel}else{l=""+k}}}var m=null;if("tooltip" in h){m=h.tooltip}else{if("l10n" in k&&"viewTooltip" in k.l10n){m=k.l10n.viewTooltip}else{m=l}}var b=e._generateViewID();if("id" in h){b=h.id}e._viewConstructors.push(k);e._viewConfigs.push(h);e._viewLabels.push(l);e._viewTooltips.push(m);e._viewDomConfigs.push(null);e._viewIDs.push(b)}}if("initialView" in c){e._viewIndex=c.initialView}e._internalValidate();e._initializeUI();return e};Exhibit.ViewPanel.createFromDOM=function(b,i){var k=new Exhibit.ViewPanel(b,Exhibit.UIContext.createFromDOM(b,i,false));var h=b.firstChild;while(h!=null){if(h.nodeType==1){h.style.display="none";var l=Exhibit.getRoleAttribute(h);if(l=="view"){var o=Exhibit.TileView;var a=Exhibit.getAttribute(h,"viewClass");if(a!=null&&a.length>0){o=Exhibit.UI.viewClassNameToViewClass(a);if(o==null){SimileAjax.Debug.warn("Unknown viewClass "+a)}}var d=Exhibit.getAttribute(h,"viewLabel");var q=(d!=null&&d.length>0)?d:Exhibit.getAttribute(h,"label");var r=Exhibit.getAttribute(h,"title");var c=h.id;if(q==null){if("viewLabel" in o.l10n){q=o.l10n.viewLabel}else{q=""+o}}if(r==null){if("l10n" in o&&"viewTooltip" in o.l10n){r=o.l10n.viewTooltip}else{r=q}}if(c==null||c.length==0){c=k._generateViewID()}k._viewConstructors.push(o);k._viewConfigs.push(null);k._viewLabels.push(q);k._viewTooltips.push(r);k._viewDomConfigs.push(h);k._viewIDs.push(c)}}h=h.nextSibling}var p=Exhibit.getAttribute(b,"initialView");if(p!=null&&p.length>0){try{var g=parseInt(p);if(!isNaN(g)){k._viewIndex=g}}catch(m){}}k._internalValidate();k._initializeUI();return k};Exhibit.ViewPanel.prototype.dispose=function(){if(this._view!=null){this._view.dispose();this._view=null}this._div.innerHTML="";this._uiContext.dispose();this._uiContext=null;this._div=null};Exhibit.ViewPanel.prototype._generateViewID=function(){return"view"+Math.floor(Math.random()*1000000).toString()};Exhibit.ViewPanel.prototype._internalValidate=function(){if(this._viewConstructors.length==0){this._viewConstructors.push(Exhibit.TileView);this._viewConfigs.push({});this._viewLabels.push(Exhibit.TileView.l10n.viewLabel);this._viewTooltips.push(Exhibit.TileView.l10n.viewTooltip);this._viewDomConfigs.push(null);this._viewIDs.push(this._generateViewID())}this._viewIndex=Math.max(0,Math.min(this._viewIndex,this._viewConstructors.length-1))};Exhibit.ViewPanel.prototype._initializeUI=function(){var b=document.createElement("div");if(this._div.firstChild!=null){this._div.insertBefore(b,this._div.firstChild)}else{this._div.appendChild(b)}var a=this;this._dom=Exhibit.ViewPanel.constructDom(this._div.firstChild,this._viewLabels,this._viewTooltips,function(c){a._selectView(c)});this._createView()};Exhibit.ViewPanel.prototype._createView=function(){var a=this._dom.getViewContainer();a.innerHTML="";var b=document.createElement("div");a.appendChild(b);var c=this._viewIndex;try{if(this._viewDomConfigs[c]!=null){this._view=this._viewConstructors[c].createFromDOM(this._viewDomConfigs[c],a,this._uiContext)}else{this._view=this._viewConstructors[c].create(this._viewConfigs[c],a,this._uiContext)}}catch(d){SimileAjax.Debug.log("Failed to create view "+this._viewLabels[c])}this._uiContext.getExhibit().setComponent(this._viewIDs[c],this._view);this._dom.setViewIndex(c)};Exhibit.ViewPanel.prototype._switchView=function(a){if(this._view){this._uiContext.getExhibit().disposeComponent(this._viewIDs[this._viewIndex]);this._view=null}this._viewIndex=a;this._createView()};Exhibit.ViewPanel.prototype._selectView=function(b){var c=this._viewIndex;var a=this;SimileAjax.History.addLengthyAction(function(){a._switchView(b)},function(){a._switchView(c)},Exhibit.ViewPanel.l10n.createSelectViewActionTitle(a._viewLabels[b]))};Exhibit.ViewPanel.getPropertyValuesPairs=function(g,h,e){var d=[];var b=function(o,l){var n=e.getProperty(o);var k=l?e.getObjects(g,o):e.getSubjects(g,o);var m=k.size();if(m>0){var i=n.getValueType()=="item";var p={propertyLabel:l?(m>1?n.getPluralLabel():n.getLabel()):(m>1?n.getReversePluralLabel():n.getReverseLabel()),valueType:n.getValueType(),values:[]};if(i){k.visit(function(r){var q=e.getObject(r,"label");p.values.push(q!=null?q:r)})}else{k.visit(function(q){p.values.push(q)})}d.push(p)}};for(var a=0;a<h.length;a++){var c=h[a];if(typeof c=="string"){b(c,true)}else{b(c.property,c.forward)}}return d};Exhibit.ViewPanel.constructDom=function(h,b,e,a){var c=Exhibit.ViewPanel.l10n;var d={elmt:h,className:"exhibit-viewPanel exhibit-ui-protection",children:[{tag:"div",className:"exhibit-viewPanel-viewSelection",field:"viewSelectionDiv"},{tag:"div",className:"exhibit-viewPanel-viewContainer",field:"viewContainerDiv"}]};var g=SimileAjax.DOM.createDOMFromTemplate(d);g.getViewContainer=function(){return g.viewContainerDiv};g.setViewIndex=function(l){if(b.length>1){g.viewSelectionDiv.innerHTML="";var k=function(n){var q=(n==l);if(n>0){g.viewSelectionDiv.appendChild(document.createTextNode(" \u2022 "))}var p=document.createElement("span");p.className=q?"exhibit-viewPanel-viewSelection-selectedView":"exhibit-viewPanel-viewSelection-view";p.title=e[n];p.innerHTML=b[n];if(!q){var o=function(r,i,s){a(n);SimileAjax.DOM.cancelEvent(i);return false};SimileAjax.WindowManager.registerEvent(p,"click",o)}g.viewSelectionDiv.appendChild(p)};for(var m=0;m<b.length;m++){k(m)}}};return g};Exhibit.CollectionSummaryWidget=function(c,a){this._exhibit=a.getExhibit();this._collection=a.getCollection();this._uiContext=a;this._div=c;var b=this;this._listener={onItemsChanged:function(){b._reconstruct()}};this._collection.addListener(this._listener)};Exhibit.CollectionSummaryWidget.create=function(d,c,a){var b=new Exhibit.CollectionSummaryWidget(c,Exhibit.UIContext.create(d,a));b._initializeUI();return b};Exhibit.CollectionSummaryWidget.createFromDOM=function(d,c,a){var b=new Exhibit.CollectionSummaryWidget(c!=null?c:d,Exhibit.UIContext.createFromDOM(d,a));b._initializeUI();return b};Exhibit.CollectionSummaryWidget.prototype.dispose=function(){this._collection.removeListener(this._listener);this._div.innerHTML="";this._noResultsDom=null;this._allResultsDom=null;this._filteredResultsDom=null;this._div=null;this._collection=null;this._exhibit=null};Exhibit.CollectionSummaryWidget.prototype._initializeUI=function(){var b=this;var c=Exhibit.CollectionSummaryWidget.l10n;var a=function(e,d,g){b._resetCollection();SimileAjax.DOM.cancelEvent(d);return false};this._allResultsDom=SimileAjax.DOM.createDOMFromString("span",String.substitute(c.allResultsTemplate,["exhibit-collectionSummaryWidget-results"]));this._filteredResultsDom=SimileAjax.DOM.createDOMFromString("span",String.substitute(c.filteredResultsTemplate,["exhibit-collectionSummaryWidget-results"]),{resetActionLink:Exhibit.UI.makeActionLink(c.resetFiltersLabel,a)});this._noResultsDom=SimileAjax.DOM.createDOMFromString("span",String.substitute(c.noResultsTemplate,["exhibit-collectionSummaryWidget-results","exhibit-collectionSummaryWidget-count"]),{resetActionLink:Exhibit.UI.makeActionLink(c.resetFiltersLabel,a)});this._div.innerHTML="";this._reconstruct()};Exhibit.CollectionSummaryWidget.prototype._reconstruct=function(){var c=this._collection.countAllItems();var a=this._collection.countRestrictedItems();var e=this._uiContext.getDatabase();var h=this._dom;while(this._div.childNodes.length>0){this._div.removeChild(this._div.firstChild)}if(c>0){if(a==0){this._div.appendChild(this._noResultsDom.elmt)}else{var g=e.getTypeIDs(this._collection.getRestrictedItems()).toArray();var b=g.length==1?g[0]:"Item";var d=Exhibit.Database.l10n.labelItemsOfType(a,b,e,"exhibit-collectionSummaryWidget-count");if(a==c){this._div.appendChild(this._allResultsDom.elmt);this._allResultsDom.resultDescription.innerHTML="";this._allResultsDom.resultDescription.appendChild(d)}else{this._div.appendChild(this._filteredResultsDom.elmt);this._filteredResultsDom.resultDescription.innerHTML="";this._filteredResultsDom.resultDescription.appendChild(d);this._filteredResultsDom.originalCountSpan.innerHTML=c}}}};Exhibit.CollectionSummaryWidget.prototype._resetCollection=function(){var a={};var b=this._collection;SimileAjax.History.addLengthyAction(function(){a.restrictions=b.clearAllRestrictions()},function(){b.applyRestrictions(a.restrictions)},Exhibit.CollectionSummaryWidget.l10n.resetActionTitle)};Exhibit.LegendGradientWidget=function(b,a){this._div=b;this._uiContext=a;this._initializeUI()};Exhibit.LegendGradientWidget.create=function(b,a){return new Exhibit.LegendGradientWidget(b,a)};Exhibit.LegendGradientWidget.prototype.addGradient=function(r){var b=[];var b=r;var s=function(C,i){return C.value-i.value};b.sort(s);var d=document.createElement("table");var w=document.createElement("tbody");var v=document.createElement("tr");var u=document.createElement("tr");var t=document.createElement("tr");v.style.height="2em";u.style.height="2em";t.style.height="2em";d.style.width="80%";d.cellSpacing="0";d.style.emptyCells="show";d.style.marginLeft="auto";d.style.marginRight="auto";w.appendChild(v);w.appendChild(u);w.appendChild(t);d.appendChild(w);this._theRow1=v;this._theRow2=u;this._theRow3=t;var m=b[0].value;var z=b[b.length-1].value;var e=(z-m)/50;var p=0;for(var y=0;y<b.length-1;y++){var l=b[y].value;var B=b[y+1].value;var A=document.createElement("td");A.style.backgroundColor="rgb("+b[y].red+","+b[y].green+","+b[y].blue+")";var n=document.createElement("td");var a=document.createElement("div");var k=document.createTextNode(b[y].value);a.appendChild(k);n.appendChild(a);v.appendChild(document.createElement("td"));u.appendChild(A);t.appendChild(n);A.onmouseover=function(){this.style.border="solid 1.2px"};A.onmouseout=function(){this.style.border="none"};p++;for(var x=l+e;x<B;x+=e){var h=(x-l)/(B-l);var c=Math.floor(b[y].red+h*(b[y+1].red-b[y].red));var g=Math.floor(b[y].green+h*(b[y+1].green-b[y].green));var q=Math.floor(b[y].blue+h*(b[y+1].blue-b[y].blue));var A=document.createElement("td");A.count=p;A.style.backgroundColor="rgb("+c+","+g+","+q+")";var n=document.createElement("td");var a=document.createElement("div");var k=document.createTextNode((Math.floor(x*100))/100);a.appendChild(k);n.appendChild(a);a.style.width="2px";a.style.overflow="hidden";a.style.visibility="hidden";v.appendChild(n);u.appendChild(A);t.appendChild(document.createElement("td"));p++;A.onmouseover=function(){this.parentNode.parentNode.childNodes[0].childNodes[this.count].childNodes[0].style.visibility="visible";this.parentNode.parentNode.childNodes[0].childNodes[this.count].childNodes[0].style.overflow="visible";this.style.border="solid 1.2px"};A.onmouseout=function(){this.parentNode.parentNode.childNodes[0].childNodes[this.count].childNodes[0].style.visibility="hidden";this.parentNode.parentNode.childNodes[0].childNodes[this.count].childNodes[0].style.overflow="hidden";this.style.border="none"}}}var o=b.length-1;var A=document.createElement("td");A.style.backgroundColor="rgb("+b[o].red+","+b[o].green+","+b[o].blue+")";var n=document.createElement("td");var a=document.createElement("div");var k=document.createTextNode(z);a.appendChild(k);n.appendChild(a);v.appendChild(document.createElement("td"));u.appendChild(A);t.appendChild(n);p++;A.onmouseover=function(){this.style.border="solid 1.2px"};A.onmouseout=function(){this.style.border="none"};this._div.appendChild(d)};Exhibit.LegendGradientWidget.prototype.addEntry=function(b,c){var a=document.createElement("td");a.style.width="1.5em";a.style.height="2em";this._theRow1.appendChild(a);this._theRow1.appendChild(document.createElement("td"));this._theRow2.appendChild(document.createElement("td"));this._theRow3.appendChild(document.createElement("td"));var g=document.createElement("td");g.style.backgroundColor=b;this._theRow2.appendChild(g);var e=document.createElement("td");var d=document.createElement("div");d.appendChild(document.createTextNode(c));e.appendChild(d);this._theRow3.appendChild(e)};Exhibit.LegendGradientWidget.prototype.dispose=function(){this._div.innerHTML="";this._div=null;this._uiContext=null};Exhibit.LegendGradientWidget.prototype._initializeUI=function(){this._div.className="exhibit-legendGradientWidget";this._div.innerHTML=""};Exhibit.LegendGradientWidget.prototype.clear=function(){this._div.innerHTML=""};Exhibit.LegendWidget=function(c,b,a){this._configuration=c;this._div=b;this._uiContext=a;this._colorMarkerGenerator="colorMarkerGenerator" in c?c.colorMarkerGenerator:Exhibit.LegendWidget._defaultColorMarkerGenerator;this._sizeMarkerGenerator="sizeMarkerGenerator" in c?c.sizeMarkerGenerator:Exhibit.LegendWidget._defaultSizeMarkerGenerator;this._iconMarkerGenerator="iconMarkerGenerator" in c?c.iconMarkerGenerator:Exhibit.LegendWidget._defaultIconMarkerGenerator;this._labelStyler="labelStyler" in c?c.labelStyler:Exhibit.LegendWidget._defaultColorLabelStyler;this._initializeUI()};Exhibit.LegendWidget.create=function(c,b,a){return new Exhibit.LegendWidget(c,b,a)};Exhibit.LegendWidget.prototype.dispose=function(){this._div.innerHTML="";this._div=null;this._uiContext=null};Exhibit.LegendWidget.prototype._initializeUI=function(){this._div.className="exhibit-legendWidget";this._div.innerHTML="<div id='exhibit-color-legend'></div><div id='exhibit-size-legend'></div><div id='exhibit-icon-legend'></div>"};Exhibit.LegendWidget.prototype.clear=function(){this._div.innerHTML="<div id='exhibit-color-legend'></div><div id='exhibit-size-legend'></div><div id='exhibit-icon-legend'></div>"};Exhibit.LegendWidget.prototype.addLegendLabel=function(a,b){var c=SimileAjax.DOM.createDOMFromString("div","<div id='legend-label'><span id='label' class='exhibit-legendWidget-entry-title'>"+a.replace(/\s+/g,"\u00a0")+"</span>\u00a0\u00a0 </div>",{});c.elmt.className="exhibit-legendWidget-label";var d="exhibit-"+b+"-legend";document.getElementById(d).appendChild(c.elmt)};Exhibit.LegendWidget.prototype.addEntry=function(d,a,b){b=b||"color";a=(a!=null)?a.toString():key.toString();if(b=="color"){var e=SimileAjax.DOM.createDOMFromString("span","<span id='marker'></span>\u00a0<span id='label' class='exhibit-legendWidget-entry-title'>"+a.replace(/\s+/g,"\u00a0")+"</span>\u00a0\u00a0 ",{marker:this._colorMarkerGenerator(d)});var c=document.getElementById("exhibit-color-legend")}if(b=="size"){var e=SimileAjax.DOM.createDOMFromString("span","<span id='marker'></span>\u00a0<span id='label' class='exhibit-legendWidget-entry-title'>"+a.replace(/\s+/g,"\u00a0")+"</span>\u00a0\u00a0 ",{marker:this._sizeMarkerGenerator(d)});var c=document.getElementById("exhibit-size-legend")}if(b=="icon"){var e=SimileAjax.DOM.createDOMFromString("span","<span id='marker'></span>\u00a0<span id='label' class='exhibit-legendWidget-entry-title'>"+a.replace(/\s+/g,"\u00a0")+"</span>\u00a0\u00a0 ",{marker:this._iconMarkerGenerator(d)});var c=document.getElementById("exhibit-icon-legend")}e.elmt.className="exhibit-legendWidget-entry";this._labelStyler(e.label,d);c.appendChild(e.elmt)};Exhibit.LegendWidget._localeSort=function(d,c){return d.localeCompare(c)};Exhibit.LegendWidget._defaultColorMarkerGenerator=function(b){var a=document.createElement("span");a.className="exhibit-legendWidget-entry-swatch";a.style.background=b;a.innerHTML="\u00a0\u00a0";return a};Exhibit.LegendWidget._defaultSizeMarkerGenerator=function(b){var a=document.createElement("span");a.className="exhibit-legendWidget-entry-swatch";a.style.height=b;a.style.width=b;a.style.background="#C0C0C0";a.innerHTML="\u00a0\u00a0";return a};Exhibit.LegendWidget._defaultIconMarkerGenerator=function(b){var a=document.createElement("span");a.className="<img src="+b+"/>";return a};Exhibit.LegendWidget._defaultColorLabelStyler=function(a,b){};Exhibit.Logo=function(b,a){this._exhibit=a;this._elmt=b;this._color="Silver"};Exhibit.Logo.create=function(d,b,a){var c=new Exhibit.Logo(b,a);if("color" in d){this._color=d.color}Logo._initializeUI();return c};Exhibit.Logo.createFromDOM=function(c,b){var d=new Exhibit.Logo(c,b);var a=Exhibit.getAttribute(c,"color");if(a!=null&&a.length>0){d._color=a}d._initializeUI();return d};Exhibit.Logo.prototype.dispose=function(){this._elmt=null;this._exhibit=null};Exhibit.Logo.prototype._initializeUI=function(){var d="http://static.simile.mit.edu/graphics/logos/exhibit/exhibit-small-"+this._color+".png";var c=SimileAjax.Graphics.createTranslucentImage(d);var e="exhibit-logo-image";if(!document.getElementById(e)){c.id=e}var b=document.createElement("a");b.href="http://simile.mit.edu/exhibit/";b.title="http://simile.mit.edu/exhibit/";b.target="_blank";b.appendChild(c);this._elmt.appendChild(b)};Exhibit.OptionWidget=function(c,b,a){this._label=c.label;this._checked="checked" in c?c.checked:false;this._onToggle=c.onToggle;this._containerElmt=b;this._uiContext=a;this._initializeUI()};Exhibit.OptionWidget.create=function(c,b,a){return new Exhibit.OptionWidget(c,b,a)};Exhibit.OptionWidget.prototype.dispose=function(){this._containerElmt.innerHTML="";this._dom=null;this._containerElmt=null;this._uiContext=null};Exhibit.OptionWidget.uncheckedImageURL=Exhibit.urlPrefix+"images/option.png";Exhibit.OptionWidget.checkedImageURL=Exhibit.urlPrefix+"images/option-check.png";Exhibit.OptionWidget.uncheckedTemplate="<span id='uncheckedSpan' style='display: none;'><img id='uncheckedImage' /> %0</span>";Exhibit.OptionWidget.checkedTemplate="<span id='checkedSpan' style='display: none;'><img id='checkedImage' /> %0</span>";Exhibit.OptionWidget.prototype._initializeUI=function(){this._containerElmt.className="exhibit-optionWidget";this._dom=SimileAjax.DOM.createDOMFromString(this._containerElmt,String.substitute(Exhibit.OptionWidget.uncheckedTemplate+Exhibit.OptionWidget.checkedTemplate,[this._label]),{uncheckedImage:SimileAjax.Graphics.createTranslucentImage(Exhibit.OptionWidget.uncheckedImageURL),checkedImage:SimileAjax.Graphics.createTranslucentImage(Exhibit.OptionWidget.checkedImageURL)});if(this._checked){this._dom.checkedSpan.style.display="inline"}else{this._dom.uncheckedSpan.style.display="inline"}SimileAjax.WindowManager.registerEvent(this._containerElmt,"click",this._onToggle)};Exhibit.OptionWidget.prototype.getChecked=function(){return this._checked};Exhibit.OptionWidget.prototype.setChecked=function(a){if(a!=this._checked){this._checked=a;if(a){this._dom.checkedSpan.style.display="inline";this._dom.uncheckedSpan.style.display="none"}else{this._dom.checkedSpan.style.display="none";this._dom.uncheckedSpan.style.display="inline"}}};Exhibit.OptionWidget.prototype.toggle=function(){this.setChecked(!this._checked)};Exhibit.ResizableDivWidget=function(c,b,a){this._div=b;this._configuration=c;if(!("minHeight" in c)){c.minHeight=10}this._initializeUI()};Exhibit.ResizableDivWidget.create=function(c,b,a){return new Exhibit.ResizableDivWidget(c,b,a)};Exhibit.ResizableDivWidget.prototype.dispose=function(){this._div.innerHTML="";this._contentDiv=null;this._resizerDiv=null;this._div=null};Exhibit.ResizableDivWidget.prototype.getContentDiv=function(){return this._contentDiv};Exhibit.ResizableDivWidget.prototype._initializeUI=function(){var a=this;this._div.innerHTML="<div></div><div class='exhibit-resizableDivWidget-resizer'>"+SimileAjax.Graphics.createTranslucentImageHTML(Exhibit.urlPrefix+"images/down-arrow.png")+"</div>";this._contentDiv=this._div.childNodes[0];this._resizerDiv=this._div.childNodes[1];SimileAjax.WindowManager.registerForDragging(this._resizerDiv,{onDragStart:function(){this._height=a._contentDiv.offsetHeight},onDragBy:function(c,b){this._height+=b;a._contentDiv.style.height=Math.max(a._configuration.minHeight,this._height)+"px"},onDragEnd:function(){if("onResize" in a._configuration){a._configuration.onResize()}}})};Exhibit.ToolboxWidget=function(b,a){this._containerElmt=b;this._uiContext=a;this._settings={};this._customExporters=[];this._hovering=false;this._initializeUI()};Exhibit.ToolboxWidget._settingSpecs={itemID:{type:"text"}};Exhibit.ToolboxWidget.create=function(d,c,a){var b=new Exhibit.ToolboxWidget(c,Exhibit.UIContext.create(d,a));Exhibit.ToolboxWidget._configure(b,d);b._initializeUI();return b};Exhibit.ToolboxWidget.createFromDOM=function(d,c,a){var e=Exhibit.getConfigurationFromDOM(d);var b=new Exhibit.ToolboxWidget(c!=null?c:d,Exhibit.UIContext.createFromDOM(d,a));Exhibit.SettingsUtilities.collectSettingsFromDOM(d,Exhibit.ToolboxWidget._settingSpecs,b._settings);Exhibit.ToolboxWidget._configure(b,e);b._initializeUI();return b};Exhibit.ToolboxWidget._configure=function(a,b){Exhibit.SettingsUtilities.collectSettings(b,Exhibit.ToolboxWidget._settingSpecs,a._settings)};Exhibit.ToolboxWidget.prototype.dispose=function(){this._containerElmt.onmouseover=null;this._containerElmt.onmouseout=null;this._dismiss();this._settings=null;this._containerElmt=null;this._uiContext=null};Exhibit.ToolboxWidget.prototype.addExporter=function(a){this._customExporters.push(a)};Exhibit.ToolboxWidget.prototype._initializeUI=function(){var a=this;this._containerElmt.onmouseover=function(b){a._onContainerMouseOver(b)};this._containerElmt.onmouseout=function(b){a._onContainerMouseOut(b)}};Exhibit.ToolboxWidget.prototype._onContainerMouseOver=function(b){if(!this._hovering){var d=this;var g=SimileAjax.DOM.getPageCoordinates(this._containerElmt);var e=document.body.offsetWidth;var c=document.body.offsetHeight;var a=document.createElement("div");a.className="exhibit-toolboxWidget-popup screen";a.style.top=g.top+"px";a.style.right=(e-g.left-this._containerElmt.offsetWidth)+"px";this._fillPopup(a);document.body.appendChild(a);a.onmouseover=function(h){d._onPopupMouseOver(h)};a.onmouseout=function(h){d._onPopupMouseOut(h)};this._popup=a;this._hovering=true}else{this._clearTimeout()}};Exhibit.ToolboxWidget.prototype._onContainerMouseOut=function(a){if(Exhibit.ToolboxWidget._mouseOutsideElmt(Exhibit.ToolboxWidget._getEvent(a),this._containerElmt)){this._setTimeout()}};Exhibit.ToolboxWidget.prototype._onPopupMouseOver=function(a){this._clearTimeout()};Exhibit.ToolboxWidget.prototype._onPopupMouseOut=function(a){if(Exhibit.ToolboxWidget._mouseOutsideElmt(Exhibit.ToolboxWidget._getEvent(a),this._containerElmt)){this._setTimeout()}};Exhibit.ToolboxWidget.prototype._setTimeout=function(){var a=this;this._timer=window.setTimeout(function(){a._onTimeout()},200)};Exhibit.ToolboxWidget.prototype._clearTimeout=function(){if(this._timer){window.clearTimeout(this._timer);this._timer=null}};Exhibit.ToolboxWidget.prototype._onTimeout=function(){this._dismiss();this._hovering=false;this._timer=null};Exhibit.ToolboxWidget.prototype._fillPopup=function(b){var a=this;var c=Exhibit.UI.createTranslucentImage("images/liveclipboard-icon.png");c.className="exhibit-toolboxWidget-button";SimileAjax.WindowManager.registerEvent(c,"click",function(e,d,g){a._showExportMenu(c)});b.appendChild(c)};Exhibit.ToolboxWidget.prototype._dismiss=function(){if(this._popup){document.body.removeChild(this._popup);this._popup=null}};Exhibit.ToolboxWidget._mouseOutsideElmt=function(a,b){var c=SimileAjax.DOM.getEventPageCoordinates(a);var d=SimileAjax.DOM.getPageCoordinates(b);return((c.x<d.left||c.x>d.left+b.offsetWidth)||(c.y<d.top||c.y>d.top+b.offsetHeight))};Exhibit.ToolboxWidget._getEvent=function(a){return(a)?a:((event)?event:null)};Exhibit.ToolboxWidget.prototype._showExportMenu=function(c){var a=this;var e=Exhibit.UI.createPopupMenuDom(c);var d=function(h){e.appendMenuItem(h.getLabel(),null,function(){var i=a._uiContext.getDatabase();var k=("itemID" in a._settings)?h.exportOne(a._settings.itemID,i):h.exportMany(a._uiContext.getCollection().getRestrictedItems(),i);Exhibit.ToolboxWidget.createExportDialogBox(k).open()})};var g=Exhibit.getExporters();for(var b=0;b<g.length;b++){d(g[b])}for(var b=0;b<this._customExporters.length;b++){d(this._customExporters[b])}if("getGeneratedHTML" in this){d({getLabel:function(){return Exhibit.l10n.htmlExporterLabel},exportOne:this.getGeneratedHTML,exportMany:this.getGeneratedHTML})}e.open()};Exhibit.ToolboxWidget.createExportDialogBox=function(a){var b={tag:"div",className:"exhibit-copyDialog exhibit-ui-protection",children:[{tag:"button",field:"closeButton",children:[Exhibit.l10n.exportDialogBoxCloseButtonLabel]},{tag:"p",children:[Exhibit.l10n.exportDialogBoxPrompt]},{tag:"div",field:"textAreaContainer"}]};var c=SimileAjax.DOM.createDOMFromTemplate(b);c.textAreaContainer.innerHTML="<textarea wrap='off' rows='15'>"+a+"</textarea>";c.close=function(){document.body.removeChild(c.elmt)};c.open=function(){c.elmt.style.top=(document.body.scrollTop+100)+"px";document.body.appendChild(c.elmt);c.layer=SimileAjax.WindowManager.pushLayer(function(){c.close()},false);var d=c.textAreaContainer.firstChild;d.select();SimileAjax.WindowManager.registerEvent(c.closeButton,"click",function(g,e,h){SimileAjax.WindowManager.popLayer(c.layer)},c.layer);SimileAjax.WindowManager.registerEvent(d,"keyup",function(g,e,h){if(e.keyCode==27){SimileAjax.WindowManager.popLayer(c.layer)}},c.layer)};return c};Exhibit.Coders=new Object();Exhibit.Coders.mixedCaseColor="#fff";Exhibit.Coders.othersCaseColor="#aaa";Exhibit.Coders.missingCaseColor="#888";Exhibit.FacetUtilities=new Object();Exhibit.FacetUtilities.constructFacetFrame=function(g,d,b,a){g.className="exhibit-facet";var e=SimileAjax.DOM.createDOMFromString(g,"<div class='exhibit-facet-header'><div class='exhibit-facet-header-filterControl' id='clearSelectionsDiv' title='"+Exhibit.FacetUtilities.l10n.clearSelectionsTooltip+"'><span id='filterCountSpan'></span><img id='checkImage' /></div><span class='exhibit-facet-header-title'>"+d+"</span></div><div class='exhibit-facet-body-frame' id='frameDiv'></div>",{checkImage:Exhibit.UI.createTranslucentImage("images/black-check.png")});var c=Exhibit.ResizableDivWidget.create({},e.frameDiv,a);e.valuesContainer=c.getContentDiv();e.valuesContainer.className="exhibit-facet-body";e.setSelectionCount=function(h){this.filterCountSpan.innerHTML=h;this.clearSelectionsDiv.style.display=h>0?"block":"none"};SimileAjax.WindowManager.registerEvent(e.clearSelectionsDiv,"click",b);return e};Exhibit.FacetUtilities.constructFacetItem=function(i,g,b,d,k,h,a,e){if(Exhibit.params.safe){i=Exhibit.Formatter.encodeAngleBrackets(i)}var c=SimileAjax.DOM.createDOMFromString("div","<div class='exhibit-facet-value-count'>"+g+"</div><div class='exhibit-facet-value-inner' id='inner'>"+("<div class='exhibit-facet-value-checkbox'>&nbsp;"+SimileAjax.Graphics.createTranslucentImageHTML(Exhibit.urlPrefix+(k?(d?"images/black-check.png":"images/no-check.png"):"images/no-check-no-border.png"))+"</div>")+"</div>");c.elmt.className=d?"exhibit-facet-value exhibit-facet-value-selected":"exhibit-facet-value";if(typeof i=="string"){c.elmt.title=i;c.inner.appendChild(document.createTextNode(i));if(b!=null){c.inner.style.color=b}}else{c.inner.appendChild(i);if(b!=null){i.style.color=b}}SimileAjax.WindowManager.registerEvent(c.elmt,"click",a,SimileAjax.WindowManager.getBaseLayer());if(k){SimileAjax.WindowManager.registerEvent(c.inner.firstChild,"click",h,SimileAjax.WindowManager.getBaseLayer())}return c.elmt};Exhibit.FacetUtilities.constructFlowingFacetFrame=function(e,c,b,a){e.className="exhibit-flowingFacet";var d=SimileAjax.DOM.createDOMFromString(e,"<div class='exhibit-flowingFacet-header'><span class='exhibit-flowingFacet-header-title'>"+c+"</span></div><div class='exhibit-flowingFacet-body' id='valuesContainer'></div>");d.setSelectionCount=function(g){};return d};Exhibit.FacetUtilities.constructFlowingFacetItem=function(i,g,b,d,k,h,a,e){if(Exhibit.params.safe){i=Exhibit.Formatter.encodeAngleBrackets(i)}var c=SimileAjax.DOM.createDOMFromString("div",("<div class='exhibit-flowingFacet-value-checkbox'>"+SimileAjax.Graphics.createTranslucentImageHTML(Exhibit.urlPrefix+(k?(d?"images/black-check.png":"images/no-check.png"):"images/no-check-no-border.png"))+"</div>")+"<span id='inner'></span> <span class='exhibit-flowingFacet-value-count'>("+g+")</span>");c.elmt.className=d?"exhibit-flowingFacet-value exhibit-flowingFacet-value-selected":"exhibit-flowingFacet-value";if(typeof i=="string"){c.elmt.title=i;c.inner.appendChild(document.createTextNode(i));if(b!=null){c.inner.style.color=b}}else{c.inner.appendChild(i);if(b!=null){i.style.color=b}}SimileAjax.WindowManager.registerEvent(c.elmt,"click",a,SimileAjax.WindowManager.getBaseLayer());if(k){SimileAjax.WindowManager.registerEvent(c.elmt.firstChild,"click",h,SimileAjax.WindowManager.getBaseLayer())}return c.elmt};Exhibit.Set=function(b){this._hash={};this._count=0;if(b instanceof Array){for(var c=0;c<b.length;c++){this.add(b[c])}}else{if(b instanceof Exhibit.Set){this.addSet(b)}}};Exhibit.Set.prototype.add=function(a){if(!(a in this._hash)){this._hash[a]=true;this._count++;return true}return false};Exhibit.Set.prototype.addSet=function(b){for(var a in b._hash){this.add(a)}};Exhibit.Set.prototype.remove=function(a){if(a in this._hash){delete this._hash[a];this._count--;return true}return false};Exhibit.Set.prototype.removeSet=function(b){for(var a in b._hash){this.remove(a)}};Exhibit.Set.prototype.retainSet=function(b){for(var a in this._hash){if(!b.contains(a)){delete this._hash[a];this._count--}}};Exhibit.Set.prototype.contains=function(a){return(a in this._hash)};Exhibit.Set.prototype.size=function(){return this._count};Exhibit.Set.prototype.toArray=function(){var b=[];for(var c in this._hash){b.push(c)}return b};Exhibit.Set.prototype.visit=function(a){for(var b in this._hash){if(a(b)==true){break}}};Exhibit.SettingsUtilities=new Object();Exhibit.SettingsUtilities.collectSettings=function(a,c,b){Exhibit.SettingsUtilities._internalCollectSettings(function(d){return a[d]},c,b)};Exhibit.SettingsUtilities.collectSettingsFromDOM=function(b,c,a){Exhibit.SettingsUtilities._internalCollectSettings(function(d){return Exhibit.getAttribute(b,d)},c,a)};Exhibit.SettingsUtilities._internalCollectSettings=function(l,d,g){for(var p in d){var r=d[p];var c=p;if("name" in r){c=r.name}if(!(c in g)&&"defaultValue" in r){g[c]=r.defaultValue}var q=l(p);if(q==null){continue}if(typeof q=="string"){q=q.trim();if(q.length==0){continue}}var n="text";if("type" in r){n=r.type}var b=1;if("dimensions" in r){b=r.dimensions}try{if(b>1){var k=",";if("separator" in r){k=r.separator}var o=q.split(k);if(o.length!=b){throw new Error("Expected a tuple of "+b+" dimensions separated with "+k+" but got "+q)}else{for(var h=0;h<o.length;h++){o[h]=Exhibit.SettingsUtilities._parseSetting(o[h].trim(),n,r)}g[c]=o}}else{g[c]=Exhibit.SettingsUtilities._parseSetting(q,n,r)}}catch(m){SimileAjax.Debug.exception(m)}}};Exhibit.SettingsUtilities._parseSetting=function(s,type,spec){var sType=typeof s;if(type=="text"){return s}else{if(type=="float"){if(sType=="number"){return s}else{if(sType=="string"){var f=parseFloat(s);if(!isNaN(f)){return f}}}throw new Error("Expected a floating point number but got "+s)}else{if(type=="int"){if(sType=="number"){return Math.round(s)}else{if(sType=="string"){var n=parseInt(s);if(!isNaN(n)){return n}}}throw new Error("Expected an integer but got "+s)}else{if(type=="boolean"){if(sType=="boolean"){return s}else{if(sType=="string"){s=s.toLowerCase();if(s=="true"){return true}else{if(s=="false"){return false}}}}throw new Error("Expected either 'true' or 'false' but got "+s)}else{if(type=="function"){if(sType=="function"){return s}else{if(sType=="string"){try{var f=eval(s);if(typeof f=="function"){return f}}catch(e){}}}throw new Error("Expected a function or the name of a function but got "+s)}else{if(type=="enum"){var choices=spec.choices;for(var i=0;i<choices.length;i++){if(choices[i]==s){return s}}throw new Error("Expected one of "+choices.join(", ")+" but got "+s)}else{throw new Error("Unknown setting type "+type)}}}}}}};Exhibit.SettingsUtilities.createAccessors=function(b,c,a){Exhibit.SettingsUtilities._internalCreateAccessors(function(d){return b[d]},c,a)};Exhibit.SettingsUtilities.createAccessorsFromDOM=function(b,c,a){Exhibit.SettingsUtilities._internalCreateAccessors(function(d){return Exhibit.getAttribute(b,d)},c,a)};Exhibit.SettingsUtilities._internalCreateAccessors=function(g,b,e){for(var l in b){var n=b[l];var h=n.accessorName;var d=null;var k=false;var m=function(i){k=false;if("bindings" in i){return Exhibit.SettingsUtilities._createBindingsAccessor(g,i.bindings)}else{if("bindingNames" in i){k=true;return Exhibit.SettingsUtilities._createTupleAccessor(g,i)}else{return Exhibit.SettingsUtilities._createElementalAccessor(g,i)}}};if("alternatives" in n){var a=n.alternatives;for(var c=0;c<a.length;c++){d=m(a[c]);if(d!=null){break}}}else{d=m(n)}if(d!=null){e[h]=d}else{if(!(h in e)){e[h]=function(p,o,i){}}}}};Exhibit.SettingsUtilities._createBindingsAccessor=function(g,c){var h=[];for(var e=0;e<c.length;e++){var d=c[e];var a=null;var b=false;if("bindingNames" in d){b=true;a=Exhibit.SettingsUtilities._createTupleAccessor(g,d)}else{a=Exhibit.SettingsUtilities._createElementalAccessor(g,d)}if(a==null){if(!("optional" in d)||!d.optional){return null}}else{h.push({bindingName:d.bindingName,accessor:a,isTuple:b})}}return function(l,k,i){Exhibit.SettingsUtilities._evaluateBindings(l,k,i,h)}};Exhibit.SettingsUtilities._createTupleAccessor=function(g,n){var l=g(n.attributeName);if(l==null){return null}if(typeof l=="string"){l=l.trim();if(l.length==0){return null}}try{var k=Exhibit.ExpressionParser.parse(l);var m=[];var a=n.types;for(var b=0;b<a.length;b++){m.push(Exhibit.SettingsUtilities._typeToParser(a[b]))}var d=n.bindingNames;var c=",";if("separator" in n){c=n.separator}return function(p,o,i,e){k.evaluateOnItem(p,o).values.visit(function(r){var q=r.split(c);if(q.length==m.length){var t={};if(e){for(var u in e){t[u]=e[u]}}for(var s=0;s<d.length;s++){t[d[s]]=null;m[s](q[s],function(w){t[d[s]]=w})}i(t)}})}}catch(h){SimileAjax.Debug.exception(h);return null}};Exhibit.SettingsUtilities._createElementalAccessor=function(d,a){var c=d(a.attributeName);if(c==null){return null}if(typeof c=="string"){c=c.trim();if(c.length==0){return null}}var b="text";if("type" in a){b=a.type}try{var h=Exhibit.ExpressionParser.parse(c);var i=Exhibit.SettingsUtilities._typeToParser(b);return function(l,k,e){h.evaluateOnItem(l,k).values.visit(function(m){return i(m,e)})}}catch(g){SimileAjax.Debug.exception(g);return null}};Exhibit.SettingsUtilities._typeToParser=function(a){switch(a){case"text":return Exhibit.SettingsUtilities._textParser;case"url":return Exhibit.SettingsUtilities._urlParser;case"float":return Exhibit.SettingsUtilities._floatParser;case"int":return Exhibit.SettingsUtilities._intParser;case"date":return Exhibit.SettingsUtilities._dateParser;case"boolean":return Exhibit.SettingsUtilities._booleanParser;default:throw new Error("Unknown setting type "+a)}};Exhibit.SettingsUtilities._textParser=function(a,b){return b(a)};Exhibit.SettingsUtilities._floatParser=function(a,b){var c=parseFloat(a);if(!isNaN(c)){return b(c)}return false};Exhibit.SettingsUtilities._intParser=function(a,b){var c=parseInt(a);if(!isNaN(c)){return b(c)}return false};Exhibit.SettingsUtilities._dateParser=function(a,b){if(a instanceof Date){return b(a)}else{if(typeof a=="number"){var c=new Date(0);c.setUTCFullYear(a);return b(c)}else{var c=SimileAjax.DateTime.parseIso8601DateTime(a.toString());if(c!=null){return b(c)}}}return false};Exhibit.SettingsUtilities._booleanParser=function(a,b){a=a.toString().toLowerCase();if(a=="true"){return b(true)}else{if(a=="false"){return b(false)}}return false};Exhibit.SettingsUtilities._urlParser=function(a,b){return b(Exhibit.Persistence.resolveURL(a.toString()))};Exhibit.SettingsUtilities._evaluateBindings=function(e,d,c,g){var a=g.length-1;var b=function(h,k){var n=g[k];var i=false;var m=k==a?function(){c(h)}:function(){b(h,k+1)};if(n.isTuple){n.accessor(e,d,function(o){i=true;h=o;m()},h)}else{var l=n.bindingName;n.accessor(e,d,function(o){i=true;h[l]=o;m()})}if(!i){m()}};b({},0)};Exhibit.Util={};Exhibit.Util.augment=function(c,d){if(c==null){c={}}for(var b=1;b<arguments.length;b++){var e=arguments[b];if(typeof(e)!="undefined"&&e!=null){for(var a in e){if(e.hasOwnProperty(a)){c[a]=e[a]}}}}return c};Exhibit.Util.round=function(e,a){a=a||1;var b=Math.floor(Math.log(a)/Math.log(10));e=(Math.round(e/a)*a).toString();var c=e.split(".");if(b>=0){return c[0]}b=-b;c[1]=(c[1]||"").substring(0,b);while(c[1].length<b){c[1]+="0"}return c.join(".")};if(!Array.prototype.map){Array.prototype.map=function(e,c){if(typeof e!="function"){throw new TypeError()}if(typeof c=="undefined"){c=this}var b=[],d=this.length;for(var a=0;a<d;a++){if(this.hasOwnProperty(a)){b[a]=e.call(c,this[a],a,this)}}return b}}Exhibit.ViewUtilities=new Object();Exhibit.ViewUtilities.openBubbleForItems=function(b,d,c){var e=SimileAjax.DOM.getPageCoordinates(b);var a=SimileAjax.Graphics.createBubbleForPoint(e.left+Math.round(b.offsetWidth/2),e.top+Math.round(b.offsetHeight/2),c.getSetting("bubbleWidth"),c.getSetting("bubbleHeight"));Exhibit.ViewUtilities.fillBubbleWithItems(a.content,d,c)};Exhibit.ViewUtilities.fillBubbleWithItems=function(g,c,b){if(g==null){g=document.createElement("div")}if(c.length>1){g.className=[g.className,"exhibit-views-bubbleWithItems"].join(" ");var e=document.createElement("ul");for(var d=0;d<c.length;d++){b.format(c[d],"item",function(k){var i=document.createElement("li");i.appendChild(k);e.appendChild(i)})}g.appendChild(e)}else{var a=document.createElement("div");var h=b.getLensRegistry().createLens(c[0],a,b);g.appendChild(a)}return g};Exhibit.ViewUtilities.constructPlottingViewDom=function(g,a,d,b,c){var e=SimileAjax.DOM.createDOMFromString(g,"<div class='exhibit-views-header'>"+(d?"<div id='collectionSummaryDiv'></div>":"")+"<div id='unplottableMessageDiv' class='exhibit-views-unplottableMessage'></div></div><div id='resizableDiv'></div><div id='legendDiv'></div>",{});if(d){e.collectionSummaryWidget=Exhibit.CollectionSummaryWidget.create({},e.collectionSummaryDiv,a)}e.resizableDivWidget=Exhibit.ResizableDivWidget.create(b,e.resizableDiv,a);e.plotContainer=e.resizableDivWidget.getContentDiv();if(c.colorGradient==true){e.legendGradientWidget=Exhibit.LegendGradientWidget.create(e.legendDiv,a)}else{e.legendWidget=Exhibit.LegendWidget.create(c,e.legendDiv,a)}e.setUnplottableMessage=function(i,h){Exhibit.ViewUtilities._setUnplottableMessage(e,i,h,a)};e.dispose=function(){if(d){e.collectionSummaryWidget.dispose()}e.resizableDivWidget.dispose();e.legendWidget.dispose()};return e};Exhibit.ViewUtilities._setUnplottableMessage=function(d,b,a,c){var e=d.unplottableMessageDiv;if(a.length==0){e.style.display="none"}else{e.innerHTML="";var d=SimileAjax.DOM.createDOMFromString(e,Exhibit.ViewUtilities.l10n.unplottableMessageFormatter(b,a,c),{});SimileAjax.WindowManager.registerEvent(d.unplottableCountLink,"click",function(h,g,i){Exhibit.ViewUtilities.openBubbleForItems(h,a,c)});e.style.display="block"}};